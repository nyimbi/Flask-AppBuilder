<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Graph Collaboration</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<style>
		.collaboration-card {
			transition: transform 0.2s ease-in-out;
			border-left: 4px solid #17a2b8;
		}
		
		.collaboration-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		
		.user-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: linear-gradient(45deg, #007bff, #17a2b8);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: bold;
			margin-right: 10px;
		}
		
		.permission-badge {
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
			border-radius: 1rem;
		}
		
		.permission-viewer { background-color: #6c757d; color: white; }
		.permission-editor { background-color: #28a745; color: white; }
		.permission-admin { background-color: #ffc107; color: black; }
		.permission-owner { background-color: #dc3545; color: white; }
		
		.session-status {
			padding: 0.25rem 0.5rem;
			border-radius: 0.25rem;
			font-size: 0.75rem;
			font-weight: 600;
		}
		
		.session-active { background-color: #d1ecf1; color: #0c5460; }
		.session-inactive { background-color: #f8d7da; color: #721c24; }
		
		.notification-badge {
			position: absolute;
			top: -5px;
			right: -5px;
			background-color: #dc3545;
			color: white;
			border-radius: 50%;
			width: 20px;
			height: 20px;
			font-size: 0.75rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.stats-card {
			text-align: center;
			padding: 1.5rem;
		}
		
		.stats-number {
			font-size: 2.5rem;
			font-weight: bold;
			line-height: 1;
		}
		
		.stats-label {
			font-size: 0.875rem;
			color: #6c757d;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		
		.active-sessions {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		
		.team-management {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			color: white;
		}
		
		.real-time-editing {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
		}
		
		.comment-preview {
			background-color: #f8f9fa;
			border-left: 3px solid #007bff;
			padding: 0.75rem;
			margin: 0.5rem 0;
			border-radius: 0.25rem;
		}
		
		.online-indicator {
			width: 10px;
			height: 10px;
			background-color: #28a745;
			border-radius: 50%;
			display: inline-block;
			margin-left: 5px;
		}
		
		.offline-indicator {
			width: 10px;
			height: 10px;
			background-color: #6c757d;
			border-radius: 50%;
			display: inline-block;
			margin-left: 5px;
		}
		
		.quick-action-btn {
			border-radius: 50px;
			padding: 0.75rem 1.5rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		
		.resource-item {
			padding: 0.75rem;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			margin-bottom: 0.5rem;
			transition: all 0.2s ease-in-out;
		}
		
		.resource-item:hover {
			background-color: #f8f9fa;
			border-color: #007bff;
		}
		
		.participant-list {
			display: flex;
			flex-wrap: wrap;
			gap: 0.25rem;
		}
		
		.participant-avatar {
			width: 30px;
			height: 30px;
			border-radius: 50%;
			background: linear-gradient(45deg, #28a745, #20c997);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 0.75rem;
			font-weight: bold;
		}
		
		.notification-item {
			border-left: 3px solid #007bff;
			background-color: #f8f9fa;
			transition: background-color 0.2s ease-in-out;
		}
		
		.notification-item.unread {
			background-color: #e3f2fd;
			border-left-color: #2196f3;
		}
		
		.notification-item:hover {
			background-color: #e9ecef;
		}
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<h1 class="h2 mb-0">
						<i class="fas fa-users text-info me-2"></i>
						{{ title }}
					</h1>
					<div class="btn-group">
						<a href="{{ url_for('CollaborationView.sessions') }}" class="btn btn-outline-primary">
							<i class="fas fa-users-cog me-1"></i> Sessions
						</a>
						<a href="{{ url_for('CollaborationView.permissions') }}" class="btn btn-outline-info">
							<i class="fas fa-key me-1"></i> Permissions
						</a>
						<a href="{{ url_for('CollaborationView.comments') }}" class="btn btn-outline-success">
							<i class="fas fa-comments me-1"></i> Comments
						</a>
						<div class="btn-group ms-2">
							<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
								<i class="fas fa-bell me-1"></i> 
								Notifications
								{% if overview.unread_notifications > 0 %}
									<span class="badge bg-danger ms-1">{{ overview.unread_notifications }}</span>
								{% endif %}
							</button>
							<ul class="dropdown-menu dropdown-menu-end" style="width: 300px; max-height: 400px; overflow-y: auto;">
								{% for notification in overview.notifications[:5] %}
									<li>
										<div class="dropdown-item-text notification-item {% if not notification.is_read %}unread{% endif %} p-3">
											<div class="d-flex justify-content-between align-items-start">
												<div class="flex-grow-1">
													<h6 class="mb-1">{{ notification.title }}</h6>
													<p class="mb-1">{{ notification.message }}</p>
													<small class="text-muted">{{ notification.created_at[:19] }}</small>
												</div>
												{% if not notification.is_read %}
													<span class="badge bg-primary">New</span>
												{% endif %}
											</div>
										</div>
									</li>
									<li><hr class="dropdown-divider"></li>
								{% endfor %}
								<li>
									<button class="dropdown-item text-center" onclick="loadAllNotifications()">
										<i class="fas fa-eye me-1"></i> View All Notifications
									</button>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Statistics Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card collaboration-card stats-card">
					<div class="stats-number text-primary">{{ overview.collaboration_stats.total_sessions }}</div>
					<div class="stats-label">Active Sessions</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card collaboration-card stats-card">
					<div class="stats-number text-success">{{ overview.collaboration_stats.total_permissions }}</div>
					<div class="stats-label">Permissions</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card collaboration-card stats-card">
					<div class="stats-number text-info">{{ overview.collaboration_stats.total_comments }}</div>
					<div class="stats-label">Comments</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card collaboration-card stats-card">
					<div class="stats-number text-warning">{{ users|length }}</div>
					<div class="stats-label">Team Members</div>
				</div>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="row mb-4">
			<div class="col-md-4">
				<div class="card collaboration-card active-sessions">
					<div class="card-body text-center">
						<i class="fas fa-users-cog fa-3x mb-3"></i>
						<h5>Start Collaboration</h5>
						<p class="mb-3">Create a new collaboration session and invite team members to work together.</p>
						<button class="btn btn-light quick-action-btn" onclick="showStartCollaborationModal()">
							Start Session
						</button>
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card collaboration-card team-management">
					<div class="card-body text-center">
						<i class="fas fa-user-friends fa-3x mb-3"></i>
						<h5>Manage Team</h5>
						<p class="mb-3">Invite team members, manage permissions, and control access to your graphs.</p>
						<button class="btn btn-light quick-action-btn" onclick="showTeamManagementModal()">
							Manage Team
						</button>
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card collaboration-card real-time-editing">
					<div class="card-body text-center">
						<i class="fas fa-edit fa-3x mb-3"></i>
						<h5>Real-time Editing</h5>
						<p class="mb-3">Edit graphs collaboratively with real-time synchronization and conflict resolution.</p>
						<a href="/graph/editor" class="btn btn-light quick-action-btn">
							Open Editor
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Active Sessions and Team Overview -->
		<div class="row mb-4">
			<div class="col-md-8">
				<div class="card collaboration-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-laptop-code text-primary me-2"></i>
							Active Collaboration Sessions
						</h6>
					</div>
					<div class="card-body">
						{% if overview.active_sessions %}
							{% for session in overview.active_sessions %}
								<div class="resource-item">
									<div class="d-flex justify-content-between align-items-center">
										<div class="flex-grow-1">
											<h6 class="mb-1">
												{{ session.resource_type|title }}: {{ session.resource_id }}
												<span class="session-status session-active">Active</span>
											</h6>
											<small class="text-muted">
												Session ID: <code>{{ session.session_id[:8] }}...</code> |
												Created: {{ session.created_at[:19] }} |
												Participants: {{ session.participants|length }}
											</small>
										</div>
										<div class="participant-list">
											{% for participant in session.participants[:5] %}
												<div class="participant-avatar" title="Participant {{ participant }}">
													{{ participant[:1]|upper }}
												</div>
											{% endfor %}
											{% if session.participants|length > 5 %}
												<div class="participant-avatar" title="+{{ session.participants|length - 5 }} more">
													+{{ session.participants|length - 5 }}
												</div>
											{% endif %}
										</div>
									</div>
									<div class="mt-2">
										<div class="btn-group btn-group-sm">
											<button class="btn btn-outline-primary" onclick="joinSession('{{ session.session_id }}')">
												<i class="fas fa-sign-in-alt me-1"></i> Join
											</button>
											<button class="btn btn-outline-info" onclick="viewSessionDetails('{{ session.session_id }}')">
												<i class="fas fa-eye me-1"></i> Details
											</button>
											{% if session.owner_id == current_user_id %}
												<button class="btn btn-outline-danger" onclick="endSession('{{ session.session_id }}')">
													<i class="fas fa-stop me-1"></i> End
												</button>
											{% endif %}
										</div>
									</div>
								</div>
							{% endfor %}
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-users-slash fa-2x mb-2"></i>
								<p>No active collaboration sessions</p>
								<button class="btn btn-primary btn-sm" onclick="showStartCollaborationModal()">
									Start Your First Session
								</button>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card collaboration-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-users text-success me-2"></i>
							Team Members ({{ users|length }})
						</h6>
					</div>
					<div class="card-body" style="max-height: 400px; overflow-y: auto;">
						{% if users %}
							{% for user in users %}
								<div class="d-flex align-items-center mb-3">
									<div class="user-avatar">
										{{ user.username[:1]|upper }}
									</div>
									<div class="flex-grow-1">
										<h6 class="mb-0">{{ user.username }}</h6>
										<small class="text-muted">
											{{ user.email }}
											{% if user.is_active %}
												<span class="online-indicator" title="Online"></span>
											{% else %}
												<span class="offline-indicator" title="Offline"></span>
											{% endif %}
										</small>
									</div>
									<div class="btn-group btn-group-sm">
										<button class="btn btn-outline-primary" onclick="inviteToCollaborate('{{ user.user_id }}')">
											<i class="fas fa-paper-plane"></i>
										</button>
									</div>
								</div>
							{% endfor %}
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-user-plus fa-2x mb-2"></i>
								<p>No team members yet</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<!-- My Permissions and Recent Comments -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="card collaboration-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-key text-warning me-2"></i>
							My Permissions
						</h6>
					</div>
					<div class="card-body">
						{% if overview.permissions %}
							<div class="table-responsive">
								<table class="table table-sm">
									<thead>
										<tr>
											<th>Resource</th>
											<th>Permission</th>
											<th>Granted By</th>
										</tr>
									</thead>
									<tbody>
										{% for perm in overview.permissions[:5] %}
											<tr>
												<td>
													<small>{{ perm.resource_id }}</small>
												</td>
												<td>
													<span class="permission-badge permission-{{ perm.permission_level }}">
														{{ perm.permission_level|title }}
													</span>
												</td>
												<td>
													<small>{{ perm.granted_by }}</small>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% if overview.permissions|length > 5 %}
								<div class="text-center">
									<a href="{{ url_for('CollaborationView.permissions') }}" class="btn btn-sm btn-outline-primary">
										View All ({{ overview.permissions|length }})
									</a>
								</div>
							{% endif %}
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-key fa-2x mb-2"></i>
								<p>No permissions assigned</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="card collaboration-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-comments text-info me-2"></i>
							Recent Comments
						</h6>
					</div>
					<div class="card-body">
						{% if overview.recent_comments %}
							{% for comment in overview.recent_comments[:3] %}
								<div class="comment-preview">
									<div class="d-flex justify-content-between align-items-start mb-1">
										<small class="fw-bold">On {{ comment.resource_id }}</small>
										<small class="text-muted">{{ comment.created_at[:16] }}</small>
									</div>
									<p class="mb-0">{{ comment.content[:100] }}{% if comment.content|length > 100 %}...{% endif %}</p>
									{% if comment.mentions %}
										<div class="mt-1">
											{% for mention in comment.mentions %}
												<span class="badge bg-secondary me-1">@{{ mention }}</span>
											{% endfor %}
										</div>
									{% endif %}
								</div>
							{% endfor %}
							<div class="text-center mt-3">
								<a href="{{ url_for('CollaborationView.comments') }}" class="btn btn-sm btn-outline-info">
									View All Comments
								</a>
							</div>
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-comment fa-2x mb-2"></i>
								<p>No recent comments</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<!-- Available Graphs -->
		<div class="row">
			<div class="col-12">
				<div class="card collaboration-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-project-diagram text-secondary me-2"></i>
							Available Graphs for Collaboration
						</h6>
					</div>
					<div class="card-body">
						{% if graphs %}
							<div class="row">
								{% for graph in graphs %}
									<div class="col-md-4 mb-3">
										<div class="resource-item">
											<div class="d-flex justify-content-between align-items-start">
												<div class="flex-grow-1">
													<h6 class="mb-1">{{ graph.name }}</h6>
													<small class="text-muted">
														Nodes: {{ graph.node_count }} | Edges: {{ graph.edge_count }}
													</small>
												</div>
												<div class="btn-group btn-group-sm">
													<button class="btn btn-outline-primary" onclick="startCollaborationFor('{{ graph.name }}')">
														<i class="fas fa-users me-1"></i> Collaborate
													</button>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-database fa-2x mb-2"></i>
								<p>No graphs available for collaboration</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Start Collaboration Modal -->
	<div class="modal fade" id="startCollaborationModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Start Collaboration Session</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="startCollaborationForm">
						<div class="mb-3">
							<label class="form-label">Select Graph</label>
							<select class="form-select" id="collaborationResourceId" required>
								<option value="">Choose a graph...</option>
								{% for graph in graphs %}
									<option value="{{ graph.name }}">{{ graph.name }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Invite Collaborators</label>
							<div class="row">
								{% for user in users %}
									{% if user.user_id != current_user_id %}
										<div class="col-md-6 mb-2">
											<div class="form-check">
												<input class="form-check-input collaborator-checkbox" type="checkbox" 
													   id="user_{{ user.user_id }}" value="{{ user.user_id }}">
												<label class="form-check-label" for="user_{{ user.user_id }}">
													<div class="d-flex align-items-center">
														<div class="user-avatar me-2" style="width: 30px; height: 30px; font-size: 0.75rem;">
															{{ user.username[:1]|upper }}
														</div>
														<div>
															<div>{{ user.username }}</div>
															<small class="text-muted">{{ user.email }}</small>
														</div>
													</div>
												</label>
												<select class="form-select form-select-sm mt-1" id="perm_{{ user.user_id }}">
													{% for level in permission_levels %}
														<option value="{{ level.value }}" {% if level.value == 'editor' %}selected{% endif %}>
															{{ level.name }}
														</option>
													{% endfor %}
												</select>
											</div>
										</div>
									{% endif %}
								{% endfor %}
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="startCollaboration()">
						<i class="fas fa-rocket me-1"></i> Start Collaboration
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		// Collaboration management functions
		function showStartCollaborationModal() {
			new bootstrap.Modal(document.getElementById('startCollaborationModal')).show();
		}
		
		function startCollaborationFor(graphName) {
			document.getElementById('collaborationResourceId').value = graphName;
			showStartCollaborationModal();
		}
		
		async function startCollaboration() {
			const resourceId = document.getElementById('collaborationResourceId').value;
			if (!resourceId) {
				alert('Please select a graph');
				return;
			}
			
			// Collect selected collaborators and their permissions
			const collaborators = {};
			document.querySelectorAll('.collaborator-checkbox:checked').forEach(checkbox => {
				const userId = checkbox.value;
				const permissionSelect = document.getElementById(`perm_${userId}`);
				collaborators[userId] = permissionSelect.value;
			});
			
			try {
				const response = await fetch('/graph/collaboration/api/start-collaboration/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						resource_id: resourceId,
						resource_type: 'graph',
						collaborators: collaborators
					})
				});
				
				const result = await response.json();
				if (result.success) {
					alert(`Collaboration session started: ${result.session_id}`);
					bootstrap.Modal.getInstance(document.getElementById('startCollaborationModal')).hide();
					location.reload();
				} else {
					alert('Error starting collaboration: ' + result.error);
				}
			} catch (error) {
				console.error('Error starting collaboration:', error);
				alert('Error starting collaboration: ' + error.message);
			}
		}
		
		async function joinSession(sessionId) {
			try {
				const response = await fetch('/graph/collaboration/api/join-session/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						session_id: sessionId
					})
				});
				
				const result = await response.json();
				if (result.success) {
					alert('Joined collaboration session successfully');
					// Redirect to collaborative editor or refresh page
					location.reload();
				} else {
					alert('Error joining session: ' + result.error);
				}
			} catch (error) {
				console.error('Error joining session:', error);
				alert('Error joining session: ' + error.message);
			}
		}
		
		function viewSessionDetails(sessionId) {
			// Open session details modal or redirect to sessions page
			window.location.href = `/graph/collaboration/sessions/?session=${sessionId}`;
		}
		
		async function endSession(sessionId) {
			if (!confirm('Are you sure you want to end this collaboration session?')) {
				return;
			}
			
			try {
				const response = await fetch('/graph/collaboration/api/leave-session/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						session_id: sessionId
					})
				});
				
				const result = await response.json();
				if (result.success) {
					alert('Session ended successfully');
					location.reload();
				} else {
					alert('Error ending session: ' + result.error);
				}
			} catch (error) {
				console.error('Error ending session:', error);
				alert('Error ending session: ' + error.message);
			}
		}
		
		function inviteToCollaborate(userId) {
			alert(`Invite functionality for user ${userId} - would open invite modal`);
		}
		
		function showTeamManagementModal() {
			window.location.href = '/graph/collaboration/permissions/';
		}
		
		function loadAllNotifications() {
			// Redirect to notifications page or load in modal
			alert('Load all notifications - would show detailed notifications interface');
		}
		
		// Initialize page
		document.addEventListener('DOMContentLoaded', function() {
			// Set up auto-refresh for active sessions
			setInterval(refreshActiveStatus, 30000); // Refresh every 30 seconds
		});
		
		function refreshActiveStatus() {
			// Refresh collaboration overview
			fetch('/graph/collaboration/api/collaboration-overview/')
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// Update notification badge
						const notificationBadge = document.querySelector('.btn-primary .badge');
						if (notificationBadge) {
							const unreadCount = data.overview.unread_notifications;
							if (unreadCount > 0) {
								notificationBadge.textContent = unreadCount;
								notificationBadge.style.display = 'inline';
							} else {
								notificationBadge.style.display = 'none';
							}
						}
					}
				})
				.catch(error => console.error('Error refreshing status:', error));
		}
	</script>
</body>
</html>