{% extends "appbuilder/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_css %}
{{ super() }}
<style>
/* Machine Learning Dashboard Styles */
.ml-dashboard {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
    background: #f8fafc;
    min-height: 100vh;
}

.dashboard-header {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(50%, -50%);
}

.header-content {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dashboard-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.dashboard-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.btn-header {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-header:hover {
    background: rgba(255, 255, 255, 0.3);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

/* Statistics Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.stat-card.models {
    border-left: 4px solid #8b5cf6;
}

.stat-card.tasks {
    border-left: 4px solid #06b6d4;
}

.stat-card.accuracy {
    border-left: 4px solid #10b981;
}

.stat-card.graphs {
    border-left: 4px solid #f59e0b;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.4rem;
    margin-bottom: 15px;
}

.stat-icon.models { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.stat-icon.tasks { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.stat-icon.accuracy { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.graphs { background: linear-gradient(135deg, #f59e0b, #d97706); }

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 5px 0;
}

.stat-label {
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
    margin: 0;
}

.stat-trend {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    font-weight: 500;
}

.trend-positive { color: #10b981; }
.trend-negative { color: #ef4444; }
.trend-neutral { color: #64748b; }

/* Main Content Grid */
.main-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.card-header {
    background: #f8fafc;
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-actions {
    display: flex;
    gap: 8px;
}

.btn-card-action {
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-card-action:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.btn-card-action.primary {
    background: #8b5cf6;
    border-color: #8b5cf6;
    color: white;
}

.btn-card-action.primary:hover {
    background: #7c3aed;
}

.card-content {
    padding: 25px;
}

/* Model Training Interface */
.training-panel {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
}

.training-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 15px 0;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #374151;
}

.form-input, .form-select {
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
}

.btn-train {
    background: #8b5cf6;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-train:hover {
    background: #7c3aed;
    transform: translateY(-1px);
}

.btn-train:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

/* Models List */
.models-list {
    max-height: 500px;
    overflow-y: auto;
}

.model-item {
    padding: 15px;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.model-item:last-child {
    border-bottom: none;
}

.model-item:hover {
    background: #f8fafc;
}

.model-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.model-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
}

.model-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.model-status.trained {
    background: #dcfce7;
    color: #166534;
}

.model-status.training {
    background: #fef3c7;
    color: #92400e;
}

.model-status.failed {
    background: #fee2e2;
    color: #991b1b;
}

.model-details {
    font-size: 0.85rem;
    color: #64748b;
    line-height: 1.4;
}

.model-metrics {
    display: flex;
    gap: 15px;
    margin-top: 8px;
    font-size: 0.8rem;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #10b981;
    font-weight: 500;
}

.model-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
}

.btn-model-action {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.btn-model-action.predict {
    background: #eff6ff;
    color: #2563eb;
}

.btn-model-action.predict:hover {
    background: #dbeafe;
}

.btn-model-action.delete {
    background: #fef2f2;
    color: #dc2626;
}

.btn-model-action.delete:hover {
    background: #fee2e2;
}

/* Quick Actions */
.quick-actions {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.quick-actions-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 15px 0;
}

.action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.action-btn {
    background: white;
    border: 1px solid #e5e7eb;
    color: #374151;
    padding: 12px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    text-align: left;
}

.action-btn:hover {
    background: #f9fafb;
    border-color: #8b5cf6;
    color: #8b5cf6;
    text-decoration: none;
}

/* Performance Charts */
.chart-container {
    height: 250px;
    background: #f8fafc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    font-style: italic;
}

/* Recent Activity */
.activity-list {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: start;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f1f5f9;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.activity-icon.train { background: #8b5cf6; }
.activity-icon.predict { background: #06b6d4; }
.activity-icon.pattern { background: #f59e0b; }

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-title {
    font-weight: 500;
    color: #1e293b;
    margin: 0 0 4px 0;
    font-size: 0.9rem;
}

.activity-description {
    color: #64748b;
    font-size: 0.8rem;
    margin: 0 0 4px 0;
}

.activity-time {
    color: #9ca3af;
    font-size: 0.75rem;
    margin: 0;
}

/* Loading States */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #8b5cf6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.training-progress {
    background: #eff6ff;
    border: 1px solid #dbeafe;
    border-radius: 6px;
    padding: 12px;
    margin-top: 15px;
    display: none;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8b5cf6, #06b6d4);
    transition: width 0.3s ease;
    animation: progress-animate 2s infinite;
}

@keyframes progress-animate {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
}

.progress-text {
    font-size: 0.85rem;
    color: #374151;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .ml-dashboard {
        padding: 15px;
    }
    
    .dashboard-header {
        padding: 20px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .dashboard-title {
        font-size: 1.8rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="ml-dashboard">
    <!-- Header -->
    <div class="dashboard-header fade-in">
        <div class="header-content">
            <div>
                <h1 class="dashboard-title">
                    <i class="fa fa-brain"></i>
                    Graph Machine Learning
                </h1>
                <p class="dashboard-subtitle">
                    Advanced machine learning capabilities for graph analysis and prediction
                </p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('GraphMLView.models') }}" class="btn-header">
                    <i class="fa fa-cogs"></i> Manage Models
                </a>
                <a href="{{ url_for('GraphMLView.patterns') }}" class="btn-header">
                    <i class="fa fa-search"></i> Pattern Mining
                </a>
                <a href="{{ url_for('GraphMLView.predictions') }}" class="btn-header">
                    <i class="fa fa-crystal-ball"></i> Predictions
                </a>
            </div>
        </div>
    </div>
    
    <!-- Statistics Grid -->
    <div class="stats-grid fade-in">
        <div class="stat-card models">
            <div class="stat-icon models">
                <i class="fa fa-cogs"></i>
            </div>
            <div class="stat-number">{{ model_stats.total_models }}</div>
            <div class="stat-label">Trained Models</div>
            <div class="stat-trend trend-positive">
                <i class="fa fa-arrow-up"></i>
                <span>Active and ready</span>
            </div>
        </div>
        
        <div class="stat-card tasks">
            <div class="stat-icon tasks">
                <i class="fa fa-tasks"></i>
            </div>
            <div class="stat-number">{{ model_stats.by_task_type|length }}</div>
            <div class="stat-label">ML Task Types</div>
            <div class="stat-trend trend-positive">
                <i class="fa fa-check"></i>
                <span>Available</span>
            </div>
        </div>
        
        <div class="stat-card accuracy">
            <div class="stat-icon accuracy">
                <i class="fa fa-target"></i>
            </div>
            <div class="stat-number">85.2%</div>
            <div class="stat-label">Avg Model Accuracy</div>
            <div class="stat-trend trend-positive">
                <i class="fa fa-arrow-up"></i>
                <span>High performance</span>
            </div>
        </div>
        
        <div class="stat-card graphs">
            <div class="stat-icon graphs">
                <i class="fa fa-project-diagram"></i>
            </div>
            <div class="stat-number">{{ model_stats.by_graph|length }}</div>
            <div class="stat-label">Graphs Analyzed</div>
            <div class="stat-trend trend-positive">
                <i class="fa fa-database"></i>
                <span>ML enabled</span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Training Interface -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fa fa-graduation-cap"></i>
                    Train New Model
                </h2>
                <div class="card-actions">
                    <button class="btn-card-action" onclick="loadTrainingExample()">
                        <i class="fa fa-lightbulb"></i> Example
                    </button>
                </div>
            </div>
            <div class="card-content">
                <div class="training-panel">
                    <h3 class="training-title">Model Configuration</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Graph</label>
                            <select class="form-select" id="training-graph">
                                <option value="">Select Graph</option>
                                {% for graph in graphs %}
                                <option value="{{ graph.name }}">{{ graph.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Task Type</label>
                            <select class="form-select" id="training-task-type" onchange="updateAlgorithms()">
                                <option value="">Select Task Type</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Algorithm</label>
                            <select class="form-select" id="training-algorithm">
                                <option value="">Select Algorithm</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="target-property-group" style="display: none;">
                            <label class="form-label">Target Property</label>
                            <select class="form-select" id="target-property">
                                <option value="">Select Property</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Test Size</label>
                            <input type="number" class="form-input" id="test-size" 
                                   value="0.2" min="0.1" max="0.5" step="0.1">
                        </div>
                        
                        <div class="form-group" id="contamination-group" style="display: none;">
                            <label class="form-label">Contamination</label>
                            <input type="number" class="form-input" id="contamination" 
                                   value="0.1" min="0.01" max="0.5" step="0.01">
                        </div>
                    </div>
                    
                    <button class="btn-train" onclick="trainModel()" id="train-button">
                        <i class="fa fa-play"></i>
                        Train Model
                    </button>
                    
                    <div class="training-progress" id="training-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%;"></div>
                        </div>
                        <div class="progress-text">Training model... Please wait</div>
                    </div>
                </div>
                
                <!-- Recent Models -->
                <div>
                    <h3 class="training-title">Recent Models</h3>
                    <div class="models-list">
                        {% if model_stats.recent_models %}
                            {% for model in model_stats.recent_models %}
                            <div class="model-item">
                                <div class="model-header">
                                    <div class="model-name">{{ model.name }}</div>
                                    <div class="model-status {{ model.status }}">{{ model.status|title }}</div>
                                </div>
                                <div class="model-details">
                                    {{ model.task_type|replace("_", " ")|title }} • {{ model.algorithm|replace("_", " ")|title }} • Graph: {{ model.graph_name }}
                                </div>
                                {% if model.metrics %}
                                <div class="model-metrics">
                                    {% for metric, value in model.metrics.items() %}
                                    <div class="metric-item">
                                        <i class="fa fa-chart-line"></i>
                                        {{ metric|title }}: {{ "%.3f"|format(value) }}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="model-actions">
                                    <button class="btn-model-action predict" onclick="makePrediction('{{ model.id }}')">
                                        <i class="fa fa-magic"></i> Predict
                                    </button>
                                    <button class="btn-model-action delete" onclick="deleteModel('{{ model.id }}')">
                                        <i class="fa fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #64748b; padding: 40px; font-style: italic;">
                                No trained models yet. Create your first ML model above.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fa fa-rocket"></i>
                    Quick Actions
                </h2>
                <div class="card-actions">
                    <button class="btn-card-action" onclick="refreshDashboard()">
                        <i class="fa fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-content">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="quick-actions-title">Popular Tasks</h3>
                    <div class="action-grid">
                        <button class="action-btn" onclick="quickTraining('node_classification')">
                            <i class="fa fa-tag"></i>
                            <div>
                                <div>Node Classification</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Predict node categories</div>
                            </div>
                        </button>
                        
                        <button class="action-btn" onclick="quickTraining('link_prediction')">
                            <i class="fa fa-link"></i>
                            <div>
                                <div>Link Prediction</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Predict connections</div>
                            </div>
                        </button>
                        
                        <button class="action-btn" onclick="quickTraining('anomaly_detection')">
                            <i class="fa fa-exclamation-triangle"></i>
                            <div>
                                <div>Anomaly Detection</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Find outliers</div>
                            </div>
                        </button>
                        
                        <a href="{{ url_for('GraphMLView.patterns') }}" class="action-btn">
                            <i class="fa fa-search"></i>
                            <div>
                                <div>Pattern Mining</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Discover patterns</div>
                            </div>
                        </a>
                    </div>
                </div>
                
                <!-- Model Distribution -->
                <div>
                    <h3 class="quick-actions-title">Model Distribution</h3>
                    <div class="chart-container" id="model-distribution-chart">
                        <div>
                            {% if model_stats.by_task_type %}
                                {% for task_type, count in model_stats.by_task_type.items() %}
                                <div style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 12px; height: 12px; border-radius: 50%; 
                                               background: {{ ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'][loop.index0 % 4] }};"></div>
                                    <span style="font-size: 0.85rem; color: #374151;">
                                        {{ task_type|replace("_", " ")|title }}: {{ count }}
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <span>No models trained yet</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div>
                    <h3 class="quick-actions-title">Recent Activity</h3>
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon train">
                                <i class="fa fa-graduation-cap"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">System Ready</div>
                                <div class="activity-description">ML engine initialized and ready for training</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
// Machine Learning Dashboard JavaScript
class MLDashboard {
    constructor() {
        this.taskTypes = [];
        this.algorithms = [];
        this.graphProperties = {};
        
        this.initializeData();
    }
    
    async initializeData() {
        try {
            // Load task types
            const taskTypesResponse = await fetch('/graph/ml/api/task-types/');
            const taskTypesData = await taskTypesResponse.json();
            if (taskTypesData.success) {
                this.taskTypes = taskTypesData.task_types;
                this.populateTaskTypes();
            }
        } catch (error) {
            console.error('Failed to initialize ML dashboard:', error);
        }
    }
    
    populateTaskTypes() {
        const taskTypeSelect = document.getElementById('training-task-type');
        taskTypeSelect.innerHTML = '<option value="">Select Task Type</option>';
        
        this.taskTypes.forEach(taskType => {
            const option = document.createElement('option');
            option.value = taskType.value;
            option.textContent = taskType.name;
            option.title = taskType.description;
            taskTypeSelect.appendChild(option);
        });
    }
    
    async updateAlgorithms() {
        const taskType = document.getElementById('training-task-type').value;
        const algorithmSelect = document.getElementById('training-algorithm');
        
        if (!taskType) {
            algorithmSelect.innerHTML = '<option value="">Select Algorithm</option>';
            return;
        }
        
        try {
            const response = await fetch(`/graph/ml/api/algorithms/?task_type=${taskType}`);
            const data = await response.json();
            
            if (data.success) {
                algorithmSelect.innerHTML = '<option value="">Select Algorithm</option>';
                
                data.algorithms.forEach(algorithm => {
                    const option = document.createElement('option');
                    option.value = algorithm.value;
                    option.textContent = algorithm.name;
                    option.title = algorithm.description;
                    algorithmSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load algorithms:', error);
        }
        
        // Show/hide task-specific fields
        this.updateTaskSpecificFields(taskType);
    }
    
    updateTaskSpecificFields(taskType) {
        const targetPropertyGroup = document.getElementById('target-property-group');
        const contaminationGroup = document.getElementById('contamination-group');
        
        // Hide all by default
        targetPropertyGroup.style.display = 'none';
        contaminationGroup.style.display = 'none';
        
        // Show task-specific fields
        if (taskType === 'node_classification') {
            targetPropertyGroup.style.display = 'block';
            this.loadGraphProperties();
        } else if (taskType === 'anomaly_detection') {
            contaminationGroup.style.display = 'block';
        }
    }
    
    async loadGraphProperties() {
        const graphName = document.getElementById('training-graph').value;
        if (!graphName) return;
        
        try {
            const response = await fetch(`/graph/ml/api/graph-properties/${graphName}/`);
            const data = await response.json();
            
            if (data.success) {
                const propertySelect = document.getElementById('target-property');
                propertySelect.innerHTML = '<option value="">Select Property</option>';
                
                data.properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property;
                    option.textContent = property;
                    propertySelect.appendChild(option);
                });
                
                this.graphProperties[graphName] = data.property_details;
            }
        } catch (error) {
            console.error('Failed to load graph properties:', error);
        }
    }
    
    async trainModel() {
        const graphName = document.getElementById('training-graph').value;
        const taskType = document.getElementById('training-task-type').value;
        const algorithm = document.getElementById('training-algorithm').value;
        
        if (!graphName || !taskType || !algorithm) {
            showNotification('Please fill in all required fields', 'warning');
            return;
        }
        
        const trainButton = document.getElementById('train-button');
        const progressDiv = document.getElementById('training-progress');
        
        try {
            // Disable button and show progress
            trainButton.disabled = true;
            progressDiv.style.display = 'block';
            
            // Simulate progress animation
            this.animateProgress();
            
            // Prepare training data
            const trainingData = {
                graph_name: graphName,
                task_type: taskType,
                algorithm: algorithm,
                test_size: parseFloat(document.getElementById('test-size').value)
            };
            
            // Add task-specific parameters
            if (taskType === 'node_classification') {
                const targetProperty = document.getElementById('target-property').value;
                if (!targetProperty) {
                    throw new Error('Target property is required for node classification');
                }
                trainingData.target_property = targetProperty;
            } else if (taskType === 'anomaly_detection') {
                trainingData.contamination = parseFloat(document.getElementById('contamination').value);
            } else if (taskType === 'link_prediction') {
                trainingData.negative_samples_ratio = 1.0;
            }
            
            // Train model
            const response = await fetch('/graph/ml/api/train/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(trainingData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(
                    `Model trained successfully! Accuracy: ${(result.model.metrics.accuracy * 100).toFixed(1)}%`,
                    'success'
                );
                
                // Refresh the page to show new model
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error(result.error);
            }
            
        } catch (error) {
            console.error('Training failed:', error);
            showNotification(`Training failed: ${error.message}`, 'error');
        } finally {
            // Reset UI
            trainButton.disabled = false;
            progressDiv.style.display = 'none';
        }
    }
    
    animateProgress() {
        const progressFill = document.querySelector('.progress-fill');
        let width = 0;
        
        const interval = setInterval(() => {
            width += Math.random() * 15;
            if (width > 90) width = 90; // Stop at 90% until actual completion
            
            progressFill.style.width = `${width}%`;
            
            if (width >= 90) {
                clearInterval(interval);
            }
        }, 200);
        
        // Complete when training is done
        setTimeout(() => {
            progressFill.style.width = '100%';
        }, 3000);
    }
}

// Global dashboard instance
let mlDashboard;

document.addEventListener('DOMContentLoaded', function() {
    mlDashboard = new MLDashboard();
});

// Global functions
function updateAlgorithms() {
    mlDashboard.updateAlgorithms();
}

function trainModel() {
    mlDashboard.trainModel();
}

function loadTrainingExample() {
    // Load example configuration
    document.getElementById('training-graph').value = 'default_graph';
    document.getElementById('training-task-type').value = 'node_classification';
    
    // Trigger updates
    updateAlgorithms();
    
    showNotification('Example configuration loaded', 'info');
}

function quickTraining(taskType) {
    document.getElementById('training-task-type').value = taskType;
    updateAlgorithms();
    
    // Scroll to training panel
    document.querySelector('.training-panel').scrollIntoView({ behavior: 'smooth' });
}

function makePrediction(modelId) {
    // Navigate to predictions page with model pre-selected
    window.location.href = `{{ url_for('GraphMLView.predictions') }}?model=${modelId}`;
}

function deleteModel(modelId) {
    if (!confirm('Are you sure you want to delete this model? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/graph/ml/api/models/${modelId}/`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Model deleted successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(`Failed to delete model: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Delete failed:', error);
        showNotification('Failed to delete model', 'error');
    });
}

function refreshDashboard() {
    window.location.reload();
}

// Event listeners
document.getElementById('training-graph').addEventListener('change', function() {
    if (document.getElementById('training-task-type').value === 'node_classification') {
        mlDashboard.loadGraphProperties();
    }
});

// Utility functions
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-left: 4px solid ${type === 'success' ? '#10b981' : 
                                   type === 'error' ? '#ef4444' : 
                                   type === 'warning' ? '#f59e0b' : '#3b82f6'};
        border-radius: 6px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fa fa-${type === 'error' ? 'exclamation-circle' : 
                              type === 'success' ? 'check-circle' : 
                              type === 'warning' ? 'exclamation-triangle' :
                              'info-circle'}" 
               style="color: ${type === 'success' ? '#10b981' : 
                               type === 'error' ? '#ef4444' : 
                               type === 'warning' ? '#f59e0b' : '#3b82f6'};"></i>
            <span style="color: #374151; font-weight: 500;">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Add required CSS animations
const mlAnimations = document.createElement('style');
mlAnimations.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(mlAnimations);
</script>
{% endblock %}