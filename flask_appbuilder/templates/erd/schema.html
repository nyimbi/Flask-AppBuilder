{% extends "appbuilder/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_css %}
{{ super() }}
<style>
/* Interactive ERD Schema Viewer Styles */
.schema-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.schema-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.header-title {
    font-size: 1.4rem;
    font-weight: 600;
    margin: 0;
}

.database-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    opacity: 0.9;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-header {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-header:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    text-decoration: none;
}

.toolbar {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 15px 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toolbar-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #495057;
    margin-right: 5px;
}

.btn-toolbar {
    background: white;
    border: 1px solid #ced4da;
    color: #495057;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-toolbar:hover,
.btn-toolbar.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    background: white;
    border: 1px solid #ced4da;
    border-radius: 4px;
    overflow: hidden;
}

.zoom-btn {
    background: none;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s ease;
}

.zoom-btn:hover {
    background: #f8f9fa;
}

.zoom-level {
    padding: 6px 12px;
    font-size: 0.85rem;
    color: #495057;
    border-left: 1px solid #ced4da;
    border-right: 1px solid #ced4da;
    min-width: 60px;
    text-align: center;
}

.search-box {
    position: relative;
}

.search-input {
    padding: 6px 12px 6px 35px;
    border: 1px solid #ced4da;
    border-radius: 20px;
    width: 200px;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 0.9rem;
}

.erd-viewport {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #fafbfc;
    background-image: 
        radial-gradient(circle, #e9ecef 1px, transparent 1px);
    background-size: 20px 20px;
    cursor: grab;
}

.erd-viewport.grabbing {
    cursor: grabbing;
}

.erd-canvas {
    width: 100%;
    height: 100%;
    position: relative;
    transform-origin: 0 0;
    transition: transform 0.2s ease;
}

.table-node {
    position: absolute;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 250px;
    cursor: move;
    user-select: none;
    transition: all 0.2s ease;
}

.table-node:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    transform: translateY(-2px);
}

.table-node.selected {
    border-color: #667eea;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 15px;
    border-radius: 6px 6px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.table-name {
    font-weight: 600;
    font-size: 1rem;
    margin: 0;
}

.table-info {
    font-size: 0.8rem;
    opacity: 0.9;
}

.table-actions {
    display: flex;
    gap: 5px;
}

.table-action-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background 0.2s ease;
}

.table-action-btn:hover {
    background: rgba(255,255,255,0.3);
}

.columns-container {
    max-height: 300px;
    overflow-y: auto;
}

.column-row {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.85rem;
    transition: background 0.2s ease;
}

.column-row:hover {
    background: #f8f9fa;
}

.column-row:last-child {
    border-bottom: none;
}

.column-icons {
    display: flex;
    gap: 4px;
    margin-right: 8px;
    min-width: 40px;
}

.column-icon {
    width: 14px;
    height: 14px;
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: white;
}

.icon-pk {
    background: #ffc107;
}

.icon-fk {
    background: #28a745;
}

.icon-unique {
    background: #17a2b8;
}

.icon-index {
    background: #6f42c1;
}

.column-name {
    font-weight: 500;
    color: #343a40;
    margin-right: 8px;
}

.column-type {
    color: #667eea;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    margin-left: auto;
}

.column-nullable {
    color: #dc3545;
    font-size: 0.7rem;
    margin-left: 5px;
}

.relationship-line {
    position: absolute;
    pointer-events: none;
    z-index: 1;
}

.relationship-path {
    stroke: #667eea;
    stroke-width: 2;
    fill: none;
    marker-end: url(#arrowhead);
    transition: stroke 0.2s ease;
}

.relationship-path.one-to-one {
    stroke: #28a745;
    stroke-dasharray: 5,5;
}

.relationship-path.one-to-many {
    stroke: #667eea;
}

.relationship-path.many-to-many {
    stroke: #dc3545;
    stroke-dasharray: 3,3;
}

.relationship-path:hover {
    stroke-width: 3;
    opacity: 0.8;
}

.relationship-label {
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.7rem;
    color: #495057;
    pointer-events: none;
    transform: translate(-50%, -50%);
}

/* Left Sidebar - Components */
.left-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100%;
    background: white;
    border-right: 1px solid #dee2e6;
    z-index: 1000;
    transition: left 0.3s ease;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.left-sidebar.collapsed {
    left: -240px;
}

.sidebar-toggle {
    position: absolute;
    right: 10px;
    top: 15px;
    background: none;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    color: #6c757d;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.sidebar-toggle:hover {
    background: #f8f9fa;
    color: #495057;
}

.component-section {
    margin-bottom: 30px;
    padding: 0 15px;
}

.component-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 15px;
    padding: 10px 0 5px;
    border-bottom: 1px solid #f8f9fa;
    display: flex;
    align-items: center;
    gap: 8px;
}

.component-item {
    margin-bottom: 15px;
    padding: 10px;
    border: 2px dashed #dee2e6;
    border-radius: 6px;
    cursor: move;
    transition: all 0.2s ease;
    background: #f8f9fa;
}

.component-item:hover {
    border-color: #667eea;
    background: #f0f8ff;
    transform: translateY(-1px);
}

.component-item.dragging {
    opacity: 0.7;
    transform: rotate(5deg);
}

.template-table {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    font-size: 0.75rem;
}

.template-header {
    background: #667eea;
    color: white;
    padding: 6px 8px;
    font-weight: 600;
    text-align: center;
}

.template-columns {
    padding: 8px;
}

.template-columns div {
    padding: 2px 0;
    color: #495057;
    font-family: 'Monaco', 'Consolas', monospace;
}

.component-label {
    display: block;
    text-align: center;
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 8px;
    font-weight: 500;
}

.relationship-tools {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.relationship-btn, .action-btn {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #495057;
}

.relationship-btn:hover, .action-btn:hover {
    background: #667eea;
    border-color: #667eea;
    color: white;
    transform: translateY(-1px);
}

.quick-actions {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

/* Right Sidebar - Enhanced */
.sidebar {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100%;
    background: white;
    border-left: 1px solid #dee2e6;
    z-index: 1000;
    transition: right 0.3s ease;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

.sidebar.open {
    right: 0;
}

.sidebar-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 20px;
}

.sidebar-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 8px;
    font-size: 0.85rem;
    cursor: pointer;
    color: #6c757d;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
}

.sidebar-tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

.sidebar-tab:hover {
    background: #f8f9fa;
    color: #495057;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

.no-selection {
    text-align: center;
    color: #6c757d;
    padding: 40px 20px;
}

.no-selection i {
    color: #dee2e6;
    margin-bottom: 15px;
}

.layer-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 20px;
}

.layer-btn {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #495057;
}

.layer-btn.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

.layer-list {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 15px;
}

.layer-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.85rem;
    color: #495057;
}

.layer-item:last-child {
    border-bottom: none;
}

.history-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.85rem;
    color: #495057;
}

.history-item i {
    color: #667eea;
    margin-right: 8px;
}

.history-time {
    font-size: 0.75rem;
    color: #6c757d;
}

.history-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.sidebar-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.sidebar-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: #343a40;
}

.sidebar-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #6c757d;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s ease;
}

.sidebar-close:hover {
    background: #e9ecef;
}

.sidebar-content {
    padding: 20px;
    overflow-y: auto;
    height: calc(100% - 70px);
}

.property-group {
    margin-bottom: 25px;
}

.property-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    display: block;
}

.property-value {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    font-size: 0.85rem;
    color: #495057;
}

.property-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.property-list li {
    padding: 5px 0;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.85rem;
}

.property-list li:last-child {
    border-bottom: none;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.minimap {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 200px;
    height: 150px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    z-index: 100;
}

.minimap-content {
    width: 100%;
    height: 100%;
    transform-origin: 0 0;
    position: relative;
}

.minimap-table {
    position: absolute;
    background: #667eea;
    border-radius: 2px;
    opacity: 0.7;
}

.minimap-viewport {
    position: absolute;
    border: 2px solid #dc3545;
    background: rgba(220, 53, 69, 0.1);
    cursor: move;
}

@media (max-width: 768px) {
    .schema-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .header-controls {
        justify-content: center;
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .sidebar {
        width: 100%;
        right: -100%;
    }
    
    .minimap {
        display: none;
    }
}

/* Dialog Styles */
.relationship-dialog, .sql-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
}

.dialog-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.dialog-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    padding: 30px;
    min-width: 500px;
    max-width: 80vw;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.dialog-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #495057;
}

.relationship-form {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
}

.relationship-form .form-group {
    margin-bottom: 0;
}

.relationship-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
}

.relationship-form select,
.relationship-form input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 4px;
    font-size: 0.9rem;
}

.relationship-form select[multiple] {
    height: 120px;
}

.dialog-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #f8f9fa;
    padding-top: 20px;
}

.sql-dialog .dialog-content {
    min-width: 600px;
}

.sql-dialog textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 4px;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.9rem;
    resize: vertical;
    margin-bottom: 20px;
}

/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 400px;
    animation: slideIn 0.3s ease;
}

.notification.notification-success {
    border-left: 4px solid #28a745;
}

.notification.notification-error {
    border-left: 4px solid #dc3545;
}

.notification.notification-info {
    border-left: 4px solid #17a2b8;
}

.notification.fade-out {
    animation: fadeOut 0.3s ease forwards;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Selection Box */
.selection-box {
    position: absolute;
    border: 2px dashed #667eea;
    background: rgba(102, 126, 234, 0.1);
    pointer-events: none;
    z-index: 1000;
}

.table-node.selection-highlight {
    border-color: #667eea !important;
    background: rgba(102, 126, 234, 0.05);
}

/* Connection Mode Styles */
.erd-viewport.connect-mode .table-node.connection-ready {
    border-color: #28a745;
    cursor: crosshair;
}

.erd-viewport.connect-mode .table-node.connection-ready:hover {
    border-color: #20c997;
    box-shadow: 0 0 20px rgba(32, 201, 151, 0.3);
}

.table-node.connection-source {
    border-color: #ffc107 !important;
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
}

.table-node.connection-target {
    border-color: #dc3545 !important;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.4);
}

/* Enhanced table states */
.table-node.multi-selected {
    border-color: #667eea;
    box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
}

/* Mode-specific cursors */
.erd-viewport.pan-mode {
    cursor: grab;
}

.erd-viewport.pan-mode.grabbing {
    cursor: grabbing;
}

.erd-viewport.connect-mode {
    cursor: crosshair;
}

/* Enhanced toolbar styles */
.btn-toolbar.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Force layout animation */
.table-node.animating {
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Drag preview */
.drag-preview {
    position: fixed;
    pointer-events: none;
    z-index: 2000;
    opacity: 0.8;
    transform: rotate(5deg);
}

/* Enhanced relationship lines */
.relationship-path.highlighted {
    stroke-width: 4;
    stroke: #ffc107;
    filter: drop-shadow(0 0 6px rgba(255, 193, 7, 0.6));
}
</style>
{% endblock %}

{% block content %}
<div class="schema-container">
    <!-- Header -->
    <div class="schema-header">
        <div class="header-left">
            <h1 class="header-title">
                <i class="fa fa-sitemap"></i>
                Database Schema Diagram
            </h1>
            <div class="database-info">
                <span><i class="fa fa-database"></i> {{ schema.name }}</span>
                <span>•</span>
                <span>{{ erd_data.tables|length }} tables</span>
                <span>•</span>
                <span>{{ erd_data.relationships|length }} relationships</span>
            </div>
        </div>
        
        <div class="header-controls">
            <a href="{{ url_for('DatabaseERDView.index') }}" class="btn-header">
                <i class="fa fa-arrow-left"></i> Back to Dashboard
            </a>
            <button onclick="exportSchema()" class="btn-header">
                <i class="fa fa-download"></i> Export
            </button>
            <button onclick="toggleFullscreen()" class="btn-header">
                <i class="fa fa-expand"></i> Fullscreen
            </button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <span class="toolbar-label">Mode:</span>
            <button class="btn-toolbar active" id="selectMode" data-mode="select">
                <i class="fa fa-mouse-pointer"></i> Select
            </button>
            <button class="btn-toolbar" id="panMode" data-mode="pan">
                <i class="fa fa-hand-paper-o"></i> Pan
            </button>
            <button class="btn-toolbar" id="connectMode" data-mode="connect">
                <i class="fa fa-link"></i> Connect
            </button>
        </div>

        <div class="toolbar-group">
            <span class="toolbar-label">Layout:</span>
            <button class="btn-toolbar active" data-layout="auto">
                <i class="fa fa-magic"></i> Auto
            </button>
            <button class="btn-toolbar" data-layout="grid">
                <i class="fa fa-th"></i> Grid
            </button>
            <button class="btn-toolbar" data-layout="circular">
                <i class="fa fa-circle-o"></i> Circular
            </button>
            <button class="btn-toolbar" data-layout="hierarchical">
                <i class="fa fa-sitemap"></i> Tree
            </button>
            <button class="btn-toolbar" data-layout="force">
                <i class="fa fa-crosshairs"></i> Force
            </button>
        </div>
        
        <div class="toolbar-group">
            <span class="toolbar-label">View:</span>
            <button class="btn-toolbar active" data-view="all">
                <i class="fa fa-eye"></i> All Tables
            </button>
            <button class="btn-toolbar" data-view="related">
                <i class="fa fa-link"></i> Related Only
            </button>
            <button class="btn-toolbar" data-view="large">
                <i class="fa fa-database"></i> Large Tables
            </button>
            <button class="btn-toolbar" data-view="empty">
                <i class="fa fa-square-o"></i> Empty Tables
            </button>
        </div>

        <div class="toolbar-group">
            <span class="toolbar-label">Tools:</span>
            <button class="btn-toolbar" onclick="createNewTable()">
                <i class="fa fa-plus"></i> New Table
            </button>
            <button class="btn-toolbar" onclick="alignTables('horizontal')">
                <i class="fa fa-arrows-h"></i> Align H
            </button>
            <button class="btn-toolbar" onclick="alignTables('vertical')">
                <i class="fa fa-arrows-v"></i> Align V
            </button>
            <button class="btn-toolbar" onclick="distributeTables()">
                <i class="fa fa-expand"></i> Distribute
            </button>
        </div>
        
        <div class="toolbar-group">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">
                    <i class="fa fa-minus"></i>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" onclick="zoomIn()">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            
            <button class="btn-toolbar" onclick="fitToScreen()">
                <i class="fa fa-arrows-alt"></i> Fit Screen
            </button>
        </div>
        
        <div class="toolbar-group">
            <div class="search-box">
                <i class="fa fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search tables..." 
                       id="tableSearch" onkeyup="searchTables()">
            </div>
        </div>
        
        <div class="toolbar-group">
            <button class="btn-toolbar" onclick="toggleMinimap()">
                <i class="fa fa-map-o"></i> Minimap
            </button>
            <button class="btn-toolbar" onclick="openTablesList()">
                <i class="fa fa-list"></i> Tables List
            </button>
        </div>
    </div>

    <!-- ERD Viewport -->
    <div class="erd-viewport" id="erdViewport">
        <!-- Loading overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- ERD Canvas -->
        <div class="erd-canvas" id="erdCanvas">
            <!-- Tables will be dynamically added here -->
        </div>

        <!-- SVG for relationship lines -->
        <svg class="relationship-lines" id="relationshipSVG" 
             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
                </marker>
            </defs>
        </svg>

        <!-- Minimap -->
        <div class="minimap" id="minimap" style="display: none;">
            <div class="minimap-content" id="minimapContent">
                <!-- Minimap tables will be dynamically added -->
            </div>
            <div class="minimap-viewport" id="minimapViewport"></div>
        </div>
    </div>

    <!-- Left Sidebar - Tools & Components -->
    <div class="left-sidebar" id="leftSidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Components</h3>
            <button class="sidebar-toggle" onclick="toggleLeftSidebar()">
                <i class="fa fa-chevron-left" id="leftSidebarIcon"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <!-- Table Templates -->
            <div class="component-section">
                <h4 class="component-title">
                    <i class="fa fa-table"></i> Table Templates
                </h4>
                <div class="component-item" draggable="true" data-template="basic-table">
                    <div class="template-table">
                        <div class="template-header">New Table</div>
                        <div class="template-columns">
                            <div>id (PK)</div>
                            <div>name</div>
                            <div>created_at</div>
                        </div>
                    </div>
                    <span class="component-label">Basic Table</span>
                </div>
                
                <div class="component-item" draggable="true" data-template="user-table">
                    <div class="template-table">
                        <div class="template-header">User</div>
                        <div class="template-columns">
                            <div>user_id (PK)</div>
                            <div>username</div>
                            <div>email</div>
                            <div>password_hash</div>
                            <div>created_at</div>
                        </div>
                    </div>
                    <span class="component-label">User Table</span>
                </div>
                
                <div class="component-item" draggable="true" data-template="lookup-table">
                    <div class="template-table">
                        <div class="template-header">Lookup</div>
                        <div class="template-columns">
                            <div>id (PK)</div>
                            <div>code</div>
                            <div>description</div>
                            <div>sort_order</div>
                        </div>
                    </div>
                    <span class="component-label">Lookup Table</span>
                </div>
                
                <div class="component-item" draggable="true" data-template="audit-table">
                    <div class="template-table">
                        <div class="template-header">Activity Log</div>
                        <div class="template-columns">
                            <div>log_id (PK)</div>
                            <div>user_id (FK)</div>
                            <div>action</div>
                            <div>timestamp</div>
                            <div>details</div>
                        </div>
                    </div>
                    <span class="component-label">Audit Table</span>
                </div>
            </div>
            
            <!-- Relationship Tools -->
            <div class="component-section">
                <h4 class="component-title">
                    <i class="fa fa-link"></i> Relationships
                </h4>
                <div class="relationship-tools">
                    <button class="relationship-btn" data-rel-type="one-to-one">
                        <i class="fa fa-minus"></i> One-to-One
                    </button>
                    <button class="relationship-btn" data-rel-type="one-to-many">
                        <i class="fa fa-share"></i> One-to-Many
                    </button>
                    <button class="relationship-btn" data-rel-type="many-to-many">
                        <i class="fa fa-share-alt"></i> Many-to-Many
                    </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="component-section">
                <h4 class="component-title">
                    <i class="fa fa-bolt"></i> Quick Actions
                </h4>
                <div class="quick-actions">
                    <button class="action-btn" onclick="generateFromSQL()">
                        <i class="fa fa-code"></i> From SQL
                    </button>
                    <button class="action-btn" onclick="reverseEngineer()">
                        <i class="fa fa-cogs"></i> Reverse Engineer
                    </button>
                    <button class="action-btn" onclick="validateSchema()">
                        <i class="fa fa-check-circle"></i> Validate Schema
                    </button>
                    <button class="action-btn" onclick="optimizeLayout()">
                        <i class="fa fa-magic"></i> Auto-Layout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar - Properties & Details -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="properties">
                    <i class="fa fa-cog"></i> Properties
                </button>
                <button class="sidebar-tab" data-tab="layers">
                    <i class="fa fa-layer-group"></i> Layers
                </button>
                <button class="sidebar-tab" data-tab="history">
                    <i class="fa fa-history"></i> History
                </button>
            </div>
            <button class="sidebar-close" onclick="closeSidebar()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <!-- Properties Tab -->
            <div class="tab-pane active" id="propertiesTab">
                <div id="sidebarContent">
                    <div class="no-selection">
                        <i class="fa fa-info-circle fa-3x"></i>
                        <p>Select a table or relationship to view properties</p>
                    </div>
                </div>
            </div>
            
            <!-- Layers Tab -->
            <div class="tab-pane" id="layersTab">
                <div class="layer-controls">
                    <button class="layer-btn" data-layer="tables" onclick="toggleLayer('tables')">
                        <i class="fa fa-eye"></i> Tables
                    </button>
                    <button class="layer-btn" data-layer="relationships" onclick="toggleLayer('relationships')">
                        <i class="fa fa-eye"></i> Relationships
                    </button>
                    <button class="layer-btn" data-layer="indexes" onclick="toggleLayer('indexes')">
                        <i class="fa fa-eye"></i> Indexes
                    </button>
                    <button class="layer-btn" data-layer="constraints" onclick="toggleLayer('constraints')">
                        <i class="fa fa-eye"></i> Constraints
                    </button>
                </div>
                
                <div class="layer-list">
                    <div class="layer-item">
                        <input type="checkbox" checked> <i class="fa fa-table"></i> Tables Layer
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" checked> <i class="fa fa-link"></i> Relationships Layer
                    </div>
                    <div class="layer-item">
                        <input type="checkbox"> <i class="fa fa-key"></i> Primary Keys Layer
                    </div>
                    <div class="layer-item">
                        <input type="checkbox"> <i class="fa fa-sitemap"></i> Indexes Layer
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="tab-pane" id="historyTab">
                <div class="history-list">
                    <div class="history-item">
                        <i class="fa fa-plus"></i> Added table "users"
                        <span class="history-time">2 min ago</span>
                    </div>
                    <div class="history-item">
                        <i class="fa fa-link"></i> Created relationship
                        <span class="history-time">5 min ago</span>
                    </div>
                    <div class="history-item">
                        <i class="fa fa-edit"></i> Modified "orders" table
                        <span class="history-time">8 min ago</span>
                    </div>
                </div>
                <div class="history-controls">
                    <button class="btn btn-sm btn-outline-primary" onclick="undoLastAction()">
                        <i class="fa fa-undo"></i> Undo
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="redoLastAction()">
                        <i class="fa fa-repeat"></i> Redo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="erdData">
{{ erd_data | tojson | safe }}
</script>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
// Global variables
let erdData = JSON.parse(document.getElementById('erdData').textContent);
let currentZoom = 1;
let currentPan = { x: 0, y: 0 };
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let selectedTable = null;
let selectedTables = [];
let tablePositions = {};
let currentMode = 'select';
let connectionMode = false;
let connectingFrom = null;
let connectingTo = null;
let tempConnection = null;
let actionHistory = [];
let historyPosition = -1;
let draggedComponent = null;

// Initialize ERD viewer
document.addEventListener('DOMContentLoaded', function() {
    initializeERD();
    setupEventListeners();
    setupDragAndDrop();
    setupModeButtons();
    setupSidebarTabs();
    hideLoadingOverlay();
});

function initializeERD() {
    console.log('Initializing ERD with', erdData.tables.length, 'tables');
    
    // Create tables
    createTables();
    
    // Create relationships
    createRelationships();
    
    // Apply initial layout
    applyLayout('auto');
    
    // Fit to screen
    setTimeout(() => {
        fitToScreen();
    }, 100);
}

function createTables() {
    const canvas = document.getElementById('erdCanvas');
    canvas.innerHTML = ''; // Clear existing tables
    
    erdData.tables.forEach((table, index) => {
        const tableElement = createTableElement(table, index);
        canvas.appendChild(tableElement);
        
        // Store initial position
        tablePositions[table.name] = table.position || { 
            x: (index % 4) * 300 + 50, 
            y: Math.floor(index / 4) * 250 + 50 
        };
        
        // Apply position
        tableElement.style.left = tablePositions[table.name].x + 'px';
        tableElement.style.top = tablePositions[table.name].y + 'px';
    });
}

function createTableElement(table, index) {
    const tableDiv = document.createElement('div');
    tableDiv.className = 'table-node';
    tableDiv.id = `table-${table.name}`;
    tableDiv.setAttribute('data-table', table.name);
    
    // Create table header
    const header = document.createElement('div');
    header.className = 'table-header';
    header.innerHTML = `
        <div>
            <h4 class="table-name">${table.name}</h4>
            <div class="table-info">${table.columns.length} columns • ${table.row_count || 0} rows</div>
        </div>
        <div class="table-actions">
            <button class="table-action-btn" onclick="viewTableDetails('${table.name}')" title="View Details">
                <i class="fa fa-eye"></i>
            </button>
            <button class="table-action-btn" onclick="editTable('${table.name}')" title="Edit Table">
                <i class="fa fa-edit"></i>
            </button>
        </div>
    `;
    
    // Create columns container
    const columnsContainer = document.createElement('div');
    columnsContainer.className = 'columns-container';
    
    table.columns.forEach(column => {
        const columnRow = document.createElement('div');
        columnRow.className = 'column-row';
        
        const icons = [];
        if (column.primary_key) icons.push('<span class="column-icon icon-pk" title="Primary Key">PK</span>');
        if (column.foreign_key) icons.push('<span class="column-icon icon-fk" title="Foreign Key">FK</span>');
        if (column.unique) icons.push('<span class="column-icon icon-unique" title="Unique">U</span>');
        
        columnRow.innerHTML = `
            <div class="column-icons">
                ${icons.join('')}
            </div>
            <span class="column-name">${column.name}</span>
            <span class="column-type">${column.type}${column.length ? `(${column.length})` : ''}</span>
            ${!column.nullable ? '<span class="column-nullable">NOT NULL</span>' : ''}
        `;
        
        columnsContainer.appendChild(columnRow);
    });
    
    tableDiv.appendChild(header);
    tableDiv.appendChild(columnsContainer);
    
    // Add drag functionality
    makeDraggable(tableDiv);
    
    // Add click handler
    tableDiv.addEventListener('click', function(e) {
        if (!isDragging) {
            selectTable(table.name);
        }
    });
    
    return tableDiv;
}

function createRelationships() {
    const svg = document.getElementById('relationshipSVG');
    svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/></marker></defs>';
    
    erdData.relationships.forEach(rel => {
        createRelationshipLine(rel);
    });
}

function createRelationshipLine(relationship) {
    const sourceTable = document.getElementById(`table-${relationship.source}`);
    const targetTable = document.getElementById(`table-${relationship.target}`);
    
    if (!sourceTable || !targetTable) {
        console.warn('Could not find tables for relationship:', relationship);
        return;
    }
    
    const svg = document.getElementById('relationshipSVG');
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    path.classList.add('relationship-path', relationship.type);
    path.setAttribute('data-source', relationship.source);
    path.setAttribute('data-target', relationship.target);
    
    // Calculate path
    updateRelationshipPath(path, sourceTable, targetTable);
    
    svg.appendChild(path);
    
    // Add relationship label if constraint name exists
    if (relationship.constraint_name) {
        const label = document.createElement('div');
        label.className = 'relationship-label';
        label.textContent = relationship.constraint_name;
        label.style.display = 'none'; // Hidden by default
        document.getElementById('erdCanvas').appendChild(label);
        
        // Show label on hover
        path.addEventListener('mouseenter', function() {
            const pathBounds = path.getBBox();
            const midX = pathBounds.x + pathBounds.width / 2;
            const midY = pathBounds.y + pathBounds.height / 2;
            
            label.style.left = midX + 'px';
            label.style.top = midY + 'px';
            label.style.display = 'block';
        });
        
        path.addEventListener('mouseleave', function() {
            label.style.display = 'none';
        });
    }
}

function updateRelationshipPath(path, sourceElement, targetElement) {
    const sourceRect = sourceElement.getBoundingClientRect();
    const targetRect = targetElement.getBoundingClientRect();
    const canvasRect = document.getElementById('erdCanvas').getBoundingClientRect();
    
    // Calculate connection points
    const sourceCenter = {
        x: sourceRect.left - canvasRect.left + sourceRect.width / 2,
        y: sourceRect.top - canvasRect.top + sourceRect.height / 2
    };
    
    const targetCenter = {
        x: targetRect.left - canvasRect.left + targetRect.width / 2,
        y: targetRect.top - canvasRect.top + targetRect.height / 2
    };
    
    // Find best connection points (edges of rectangles)
    const sourcePoint = getConnectionPoint(sourceRect, targetCenter, canvasRect);
    const targetPoint = getConnectionPoint(targetRect, sourceCenter, canvasRect);
    
    // Create curved path
    const dx = targetPoint.x - sourcePoint.x;
    const dy = targetPoint.y - sourcePoint.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Control points for curve
    const controlOffset = Math.min(distance * 0.3, 50);
    const cp1x = sourcePoint.x + (dx > 0 ? controlOffset : -controlOffset);
    const cp1y = sourcePoint.y;
    const cp2x = targetPoint.x - (dx > 0 ? controlOffset : -controlOffset);
    const cp2y = targetPoint.y;
    
    const pathData = `M ${sourcePoint.x} ${sourcePoint.y} C ${cp1x} ${cp1y} ${cp2x} ${cp2y} ${targetPoint.x} ${targetPoint.y}`;
    path.setAttribute('d', pathData);
}

function getConnectionPoint(rect, targetCenter, canvasRect) {
    const centerX = rect.left - canvasRect.left + rect.width / 2;
    const centerY = rect.top - canvasRect.top + rect.height / 2;
    
    const dx = targetCenter.x - centerX;
    const dy = targetCenter.y - centerY;
    
    // Determine which edge to connect to based on direction
    if (Math.abs(dx) > Math.abs(dy)) {
        // Connect to left or right edge
        return {
            x: centerX + (dx > 0 ? rect.width / 2 : -rect.width / 2),
            y: centerY
        };
    } else {
        // Connect to top or bottom edge
        return {
            x: centerX,
            y: centerY + (dy > 0 ? rect.height / 2 : -rect.height / 2)
        };
    }
}

function makeDraggable(element) {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    element.addEventListener('mousedown', function(e) {
        isDragging = true;
        element.style.cursor = 'grabbing';
        
        startX = e.clientX;
        startY = e.clientY;
        initialX = parseInt(element.style.left) || 0;
        initialY = parseInt(element.style.top) || 0;
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const dx = (e.clientX - startX) / currentZoom;
        const dy = (e.clientY - startY) / currentZoom;
        
        const newX = initialX + dx;
        const newY = initialY + dy;
        
        element.style.left = newX + 'px';
        element.style.top = newY + 'px';
        
        // Update stored position
        const tableName = element.getAttribute('data-table');
        if (tableName) {
            tablePositions[tableName] = { x: newX, y: newY };
        }
        
        // Update relationship lines
        updateRelationshipsForTable(tableName);
    });
    
    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            element.style.cursor = 'move';
            
            // Save positions to server
            saveTablePositions();
        }
    });
}

function updateRelationshipsForTable(tableName) {
    const paths = document.querySelectorAll('.relationship-path');
    paths.forEach(path => {
        const source = path.getAttribute('data-source');
        const target = path.getAttribute('data-target');
        
        if (source === tableName || target === tableName) {
            const sourceElement = document.getElementById(`table-${source}`);
            const targetElement = document.getElementById(`table-${target}`);
            
            if (sourceElement && targetElement) {
                updateRelationshipPath(path, sourceElement, targetElement);
            }
        }
    });
}

function setupEventListeners() {
    // Zoom and pan
    const viewport = document.getElementById('erdViewport');
    
    viewport.addEventListener('wheel', function(e) {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const newZoom = Math.max(0.1, Math.min(3, currentZoom + delta));
        
        setZoom(newZoom);
    });
    
    // Pan functionality
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    
    viewport.addEventListener('mousedown', function(e) {
        if (e.target === viewport || e.target.classList.contains('erd-canvas')) {
            isPanning = true;
            viewport.classList.add('grabbing');
            panStart = { x: e.clientX - currentPan.x, y: e.clientY - currentPan.y };
        }
    });
    
    document.addEventListener('mousemove', function(e) {
        if (isPanning) {
            currentPan = {
                x: e.clientX - panStart.x,
                y: e.clientY - panStart.y
            };
            updateCanvasTransform();
        }
    });
    
    document.addEventListener('mouseup', function() {
        if (isPanning) {
            isPanning = false;
            viewport.classList.remove('grabbing');
        }
    });
    
    // Layout buttons
    document.querySelectorAll('[data-layout]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-layout]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyLayout(this.dataset.layout);
        });
    });
    
    // View filter buttons
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyViewFilter(this.dataset.view);
        });
    });
}

function setZoom(zoom) {
    currentZoom = zoom;
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    updateCanvasTransform();
}

function updateCanvasTransform() {
    const canvas = document.getElementById('erdCanvas');
    canvas.style.transform = `translate(${currentPan.x}px, ${currentPan.y}px) scale(${currentZoom})`;
}

function zoomIn() {
    setZoom(Math.min(3, currentZoom + 0.2));
}

function zoomOut() {
    setZoom(Math.max(0.1, currentZoom - 0.2));
}

function fitToScreen() {
    const viewport = document.getElementById('erdViewport');
    const canvas = document.getElementById('erdCanvas');
    const tables = canvas.querySelectorAll('.table-node');
    
    if (tables.length === 0) return;
    
    // Calculate bounds
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    tables.forEach(table => {
        const rect = table.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();
        
        const x = rect.left - canvasRect.left;
        const y = rect.top - canvasRect.top;
        
        minX = Math.min(minX, x);
        minY = Math.min(minY, y);
        maxX = Math.max(maxX, x + rect.width);
        maxY = Math.max(maxY, y + rect.height);
    });
    
    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;
    
    const viewportRect = viewport.getBoundingClientRect();
    const scaleX = (viewportRect.width - 100) / contentWidth;
    const scaleY = (viewportRect.height - 100) / contentHeight;
    
    const scale = Math.min(scaleX, scaleY, 1);
    
    setZoom(scale);
    
    // Center the content
    currentPan = {
        x: (viewportRect.width - contentWidth * scale) / 2 - minX * scale,
        y: (viewportRect.height - contentHeight * scale) / 2 - minY * scale
    };
    
    updateCanvasTransform();
}

function applyLayout(layoutType) {
    const tables = document.querySelectorAll('.table-node');
    
    switch (layoutType) {
        case 'grid':
            applyGridLayout(tables);
            break;
        case 'circular':
            applyCircularLayout(tables);
            break;
        case 'hierarchical':
            applyHierarchicalLayout(tables);
            break;
        default:
            applyAutoLayout(tables);
    }
    
    // Update relationships after layout
    setTimeout(() => {
        createRelationships();
    }, 100);
}

function applyGridLayout(tables) {
    const cols = Math.ceil(Math.sqrt(tables.length));
    const spacing = { x: 320, y: 280 };
    
    tables.forEach((table, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        
        const x = col * spacing.x + 50;
        const y = row * spacing.y + 50;
        
        table.style.left = x + 'px';
        table.style.top = y + 'px';
        
        const tableName = table.getAttribute('data-table');
        tablePositions[tableName] = { x, y };
    });
}

function applyCircularLayout(tables) {
    const centerX = 400;
    const centerY = 300;
    const radius = Math.max(200, tables.length * 30);
    
    tables.forEach((table, index) => {
        const angle = (index / tables.length) * 2 * Math.PI;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        table.style.left = x + 'px';
        table.style.top = y + 'px';
        
        const tableName = table.getAttribute('data-table');
        tablePositions[tableName] = { x, y };
    });
}

function applyHierarchicalLayout(tables) {
    // Simple hierarchical layout based on relationships
    const levels = {};
    const positioned = new Set();
    
    // Find root tables (tables with no incoming relationships)
    const incomingCounts = {};
    erdData.tables.forEach(table => {
        incomingCounts[table.name] = 0;
    });
    
    erdData.relationships.forEach(rel => {
        incomingCounts[rel.target_table]++;
    });
    
    const rootTables = erdData.tables.filter(table => incomingCounts[table.name] === 0);
    
    // Position root tables at level 0
    rootTables.forEach((table, index) => {
        const element = document.getElementById(`table-${table.name}`);
        const x = index * 320 + 50;
        const y = 50;
        
        element.style.left = x + 'px';
        element.style.top = y + 'px';
        
        tablePositions[table.name] = { x, y };
        positioned.add(table.name);
        levels[table.name] = 0;
    });
    
    // Position remaining tables in levels
    let currentLevel = 1;
    while (positioned.size < erdData.tables.length && currentLevel < 10) {
        const currentLevelTables = [];
        
        erdData.relationships.forEach(rel => {
            if (positioned.has(rel.source_table) && !positioned.has(rel.target_table)) {
                currentLevelTables.push(rel.target_table);
                positioned.add(rel.target_table);
                levels[rel.target_table] = currentLevel;
            }
        });
        
        currentLevelTables.forEach((tableName, index) => {
            const element = document.getElementById(`table-${tableName}`);
            const x = index * 320 + 50;
            const y = currentLevel * 280 + 50;
            
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            
            tablePositions[tableName] = { x, y };
        });
        
        currentLevel++;
    }
    
    // Position any remaining unconnected tables
    const remaining = erdData.tables.filter(table => !positioned.has(table.name));
    remaining.forEach((table, index) => {
        const element = document.getElementById(`table-${table.name}`);
        const x = index * 320 + 50;
        const y = currentLevel * 280 + 50;
        
        element.style.left = x + 'px';
        element.style.top = y + 'px';
        
        tablePositions[table.name] = { x, y };
    });
}

function applyAutoLayout(tables) {
    // Use a force-directed layout algorithm (simplified)
    const positions = {};
    
    // Initialize random positions
    tables.forEach((table, index) => {
        const tableName = table.getAttribute('data-table');
        positions[tableName] = {
            x: Math.random() * 800 + 100,
            y: Math.random() * 600 + 100
        };
    });
    
    // Apply forces for a few iterations
    for (let iteration = 0; iteration < 50; iteration++) {
        const forces = {};
        
        // Initialize forces
        Object.keys(positions).forEach(name => {
            forces[name] = { x: 0, y: 0 };
        });
        
        // Repulsion between all tables
        Object.keys(positions).forEach(name1 => {
            Object.keys(positions).forEach(name2 => {
                if (name1 !== name2) {
                    const dx = positions[name1].x - positions[name2].x;
                    const dy = positions[name1].y - positions[name2].y;
                    const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                    
                    const repulsion = Math.min(1000 / (distance * distance), 10);
                    forces[name1].x += (dx / distance) * repulsion;
                    forces[name1].y += (dy / distance) * repulsion;
                }
            });
        });
        
        // Attraction for related tables
        erdData.relationships.forEach(rel => {
            const source = rel.source_table;
            const target = rel.target_table;
            
            if (positions[source] && positions[target]) {
                const dx = positions[target].x - positions[source].x;
                const dy = positions[target].y - positions[source].y;
                const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                
                const attraction = Math.min(distance * 0.01, 2);
                forces[source].x += (dx / distance) * attraction;
                forces[source].y += (dy / distance) * attraction;
                forces[target].x -= (dx / distance) * attraction;
                forces[target].y -= (dy / distance) * attraction;
            }
        });
        
        // Apply forces
        Object.keys(positions).forEach(name => {
            positions[name].x += forces[name].x * 0.1;
            positions[name].y += forces[name].y * 0.1;
            
            // Keep within bounds
            positions[name].x = Math.max(50, Math.min(1000, positions[name].x));
            positions[name].y = Math.max(50, Math.min(800, positions[name].y));
        });
    }
    
    // Apply positions to elements
    Object.keys(positions).forEach(tableName => {
        const element = document.getElementById(`table-${tableName}`);
        if (element) {
            element.style.left = positions[tableName].x + 'px';
            element.style.top = positions[tableName].y + 'px';
            
            tablePositions[tableName] = positions[tableName];
        }
    });
}

function applyViewFilter(filterType) {
    const tables = document.querySelectorAll('.table-node');
    
    switch (filterType) {
        case 'related':
            // Show only tables with relationships
            const relatedTables = new Set();
            erdData.relationships.forEach(rel => {
                relatedTables.add(rel.source_table);
                relatedTables.add(rel.target_table);
            });
            
            tables.forEach(table => {
                const tableName = table.getAttribute('data-table');
                table.style.display = relatedTables.has(tableName) ? 'block' : 'none';
            });
            break;
            
        case 'large':
            // Show only tables with many columns or rows
            tables.forEach(table => {
                const tableName = table.getAttribute('data-table');
                const tableData = erdData.tables.find(t => t.name === tableName);
                const isLarge = tableData && (tableData.columns.length > 5 || (tableData.row_count || 0) > 1000);
                table.style.display = isLarge ? 'block' : 'none';
            });
            break;
            
        default:
            // Show all tables
            tables.forEach(table => {
                table.style.display = 'block';
            });
    }
    
    // Update relationships visibility
    updateRelationshipsVisibility();
}

function updateRelationshipsVisibility() {
    const paths = document.querySelectorAll('.relationship-path');
    paths.forEach(path => {
        const sourceTable = document.getElementById(`table-${path.getAttribute('data-source')}`);
        const targetTable = document.getElementById(`table-${path.getAttribute('data-target')}`);
        
        const visible = sourceTable && targetTable && 
                       sourceTable.style.display !== 'none' && 
                       targetTable.style.display !== 'none';
        
        path.style.display = visible ? 'block' : 'none';
    });
}

function searchTables() {
    const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
    const tables = document.querySelectorAll('.table-node');
    
    tables.forEach(table => {
        const tableName = table.getAttribute('data-table').toLowerCase();
        const columns = Array.from(table.querySelectorAll('.column-name')).map(col => col.textContent.toLowerCase());
        
        const matches = tableName.includes(searchTerm) || 
                       columns.some(col => col.includes(searchTerm));
        
        table.style.opacity = matches ? '1' : '0.3';
        table.style.pointerEvents = matches ? 'auto' : 'none';
    });
    
    // Highlight matching text
    if (searchTerm) {
        highlightText(searchTerm);
    } else {
        clearHighlights();
    }
}

function highlightText(term) {
    // Simple text highlighting - would need a more robust implementation
    const tables = document.querySelectorAll('.table-node');
    tables.forEach(table => {
        const textElements = table.querySelectorAll('.table-name, .column-name');
        textElements.forEach(el => {
            const text = el.textContent;
            const highlightedText = text.replace(
                new RegExp(term, 'gi'),
                match => `<mark style="background: yellow; padding: 2px;">${match}</mark>`
            );
            if (highlightedText !== text) {
                el.innerHTML = highlightedText;
            }
        });
    });
}

function clearHighlights() {
    const highlighted = document.querySelectorAll('mark');
    highlighted.forEach(mark => {
        mark.replaceWith(mark.textContent);
    });
}

function selectTable(tableName) {
    // Clear previous selection
    document.querySelectorAll('.table-node').forEach(table => {
        table.classList.remove('selected');
    });
    
    // Select new table
    const table = document.getElementById(`table-${tableName}`);
    if (table) {
        table.classList.add('selected');
        selectedTable = tableName;
        
        // Show table details in sidebar
        showTableDetails(tableName);
    }
}

function showTableDetails(tableName) {
    const tableData = erdData.tables.find(t => t.name === tableName);
    if (!tableData) return;
    
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebarTitle');
    const content = document.getElementById('sidebarContent');
    
    title.textContent = `Table: ${tableName}`;
    
    // Get relationships for this table
    const relationships = erdData.relationships.filter(rel => 
        rel.source_table === tableName || rel.target_table === tableName
    );
    
    content.innerHTML = `
        <div class="property-group">
            <label class="property-label">Table Information</label>
            <div class="property-value">
                <strong>Name:</strong> ${tableData.name}<br>
                <strong>Columns:</strong> ${tableData.columns.length}<br>
                <strong>Rows:</strong> ${tableData.row_count || 0}<br>
                ${tableData.comment ? `<strong>Comment:</strong> ${tableData.comment}<br>` : ''}
            </div>
        </div>
        
        <div class="property-group">
            <label class="property-label">Columns (${tableData.columns.length})</label>
            <div class="property-value">
                ${tableData.columns.map(col => `
                    <div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem;">
                        <strong>${col.name}</strong> 
                        <span style="color: #667eea;">${col.type}${col.length ? `(${col.length})` : ''}</span>
                        ${col.primary_key ? '<span style="color: #ffc107; font-size: 0.7rem;">PK</span>' : ''}
                        ${col.foreign_key ? '<span style="color: #28a745; font-size: 0.7rem;">FK</span>' : ''}
                        ${col.unique ? '<span style="color: #17a2b8; font-size: 0.7rem;">UNIQUE</span>' : ''}
                        ${!col.nullable ? '<span style="color: #dc3545; font-size: 0.7rem;">NOT NULL</span>' : ''}
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="property-group">
            <label class="property-label">Relationships (${relationships.length})</label>
            <div class="property-value">
                ${relationships.length > 0 ? relationships.map(rel => `
                    <div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem;">
                        <strong>${rel.source_table === tableName ? 'References' : 'Referenced by'}:</strong>
                        ${rel.source_table === tableName ? rel.target_table : rel.source_table}<br>
                        <span style="color: #6c757d;">
                            ${rel.constraint_name || 'Unnamed constraint'} 
                            (${rel.type.replace('_', ' ')})
                        </span>
                    </div>
                `).join('') : '<em>No relationships</em>'}
            </div>
        </div>
        
        <div class="property-group">
            <label class="property-label">Actions</label>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary btn-sm" onclick="viewTableData('${tableName}')">
                    <i class="fa fa-table"></i> View Data
                </button>
                <button class="btn btn-warning btn-sm" onclick="editTable('${tableName}')">
                    <i class="fa fa-edit"></i> Edit Structure
                </button>
                <button class="btn btn-info btn-sm" onclick="exportTableSchema('${tableName}')">
                    <i class="fa fa-download"></i> Export Schema
                </button>
            </div>
        </div>
    `;
    
    sidebar.classList.add('open');
}

function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    
    // Clear table selection
    document.querySelectorAll('.table-node').forEach(table => {
        table.classList.remove('selected');
    });
    selectedTable = null;
}

function toggleMinimap() {
    const minimap = document.getElementById('minimap');
    if (minimap.style.display === 'none') {
        minimap.style.display = 'block';
        updateMinimap();
    } else {
        minimap.style.display = 'none';
    }
}

function updateMinimap() {
    const minimap = document.getElementById('minimapContent');
    const viewport = document.getElementById('minimapViewport');
    
    // Clear existing minimap content
    minimap.innerHTML = '';
    
    // Add minimap tables
    const tables = document.querySelectorAll('.table-node');
    const canvasRect = document.getElementById('erdCanvas').getBoundingClientRect();
    
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    tables.forEach(table => {
        const rect = table.getBoundingClientRect();
        const x = rect.left - canvasRect.left;
        const y = rect.top - canvasRect.top;
        
        minX = Math.min(minX, x);
        minY = Math.min(minY, y);
        maxX = Math.max(maxX, x + rect.width);
        maxY = Math.max(maxY, y + rect.height);
        
        const minimapTable = document.createElement('div');
        minimapTable.className = 'minimap-table';
        minimapTable.style.left = x + 'px';
        minimapTable.style.top = y + 'px';
        minimapTable.style.width = rect.width + 'px';
        minimapTable.style.height = rect.height + 'px';
        
        minimap.appendChild(minimapTable);
    });
    
    // Scale minimap content
    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;
    const minimapRect = document.getElementById('minimap').getBoundingClientRect();
    
    const scaleX = minimapRect.width / contentWidth;
    const scaleY = minimapRect.height / contentHeight;
    const scale = Math.min(scaleX, scaleY) * 0.8; // 80% to leave some margin
    
    minimap.style.transform = `scale(${scale}) translate(${-minX}px, ${-minY}px)`;
    
    // Update viewport indicator
    updateMinimapViewport();
}

function updateMinimapViewport() {
    const viewport = document.getElementById('minimapViewport');
    const erdViewport = document.getElementById('erdViewport');
    
    // Calculate viewport position and size in minimap coordinates
    // This is a simplified version - would need more precise calculations
    const viewportRect = erdViewport.getBoundingClientRect();
    const minimapRect = document.getElementById('minimap').getBoundingClientRect();
    
    const scale = 0.2; // Simplified scale factor
    
    viewport.style.width = (viewportRect.width * scale) + 'px';
    viewport.style.height = (viewportRect.height * scale) + 'px';
    viewport.style.left = '10px'; // Simplified positioning
    viewport.style.top = '10px';
}

// Action functions
function viewTableDetails(tableName) {
    selectTable(tableName);
}

function editTable(tableName) {
    window.location.href = `/database/erd/table/${tableName}/edit/`;
}

function viewTableData(tableName) {
    window.open(`/database/erd/table/${tableName}/`, '_blank');
}

function exportTableSchema(tableName) {
    // Export individual table schema
    fetch(`/database/erd/api/table/${tableName}/schema/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const blob = new Blob([data.schema], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}_schema.sql`;
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                alert('Error exporting schema: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error exporting schema: ' + error.message);
        });
}

function openTablesList() {
    const tables = erdData.tables.map(table => ({
        name: table.name,
        columns: table.columns.length,
        rows: table.row_count || 0
    }));
    
    const tablesList = tables.map(table => 
        `<li style="padding: 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" 
             onclick="selectTable('${table.name}')">
            <strong>${table.name}</strong><br>
            <small>${table.columns} columns • ${table.rows} rows</small>
         </li>`
    ).join('');
    
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebarTitle');
    const content = document.getElementById('sidebarContent');
    
    title.textContent = 'All Tables';
    content.innerHTML = `
        <div class="property-group">
            <label class="property-label">Database Tables (${tables.length})</label>
            <ul style="list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto;">
                ${tablesList}
            </ul>
        </div>
    `;
    
    sidebar.classList.add('open');
}

function exportSchema() {
    const format = prompt('Export format (sql/json):', 'sql');
    if (!format) return;
    
    if (confirm(`Export database schema as ${format.toUpperCase()}?`)) {
        fetch(`/database/erd/api/backup/schema/?format=${format}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const content = format === 'json' ? JSON.stringify(erdData, null, 2) : data.backup_sql;
                    const blob = new Blob([content], { 
                        type: format === 'json' ? 'application/json' : 'text/plain' 
                    });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `database_schema.${format}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error exporting schema: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error exporting schema: ' + error.message);
            });
    }
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function saveTablePositions() {
    // Save table positions to server
    fetch('/database/erd/api/table-position/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            positions: tablePositions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.warn('Failed to save table positions:', data.error);
        }
    })
    .catch(error => {
        console.warn('Error saving table positions:', error);
    });
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'none';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
            case '=':
            case '+':
                e.preventDefault();
                zoomIn();
                break;
            case '-':
                e.preventDefault();
                zoomOut();
                break;
            case '0':
                e.preventDefault();
                fitToScreen();
                break;
            case 'f':
                e.preventDefault();
                document.getElementById('tableSearch').focus();
                break;
        }
    }
    
    if (e.key === 'Escape') {
        closeSidebar();
        clearSearch();
    }
});

function clearSearch() {
    const searchInput = document.getElementById('tableSearch');
    searchInput.value = '';
    searchTables();
}

// =========================
// ENHANCED DRAG AND DROP FUNCTIONALITY
// =========================

function setupDragAndDrop() {
    // Setup drag and drop for component items
    const componentItems = document.querySelectorAll('.component-item[draggable="true"]');
    componentItems.forEach(item => {
        item.addEventListener('dragstart', handleComponentDragStart);
        item.addEventListener('drag', handleComponentDrag);
        item.addEventListener('dragend', handleComponentDragEnd);
    });
    
    // Setup drop zone on canvas
    const canvas = document.getElementById('erdCanvas');
    canvas.addEventListener('dragover', handleCanvasDragOver);
    canvas.addEventListener('drop', handleCanvasDrop);
    
    // Setup table selection and multi-select
    setupMultiSelection();
}

function handleComponentDragStart(e) {
    draggedComponent = {
        type: e.target.getAttribute('data-template'),
        element: e.target
    };
    
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'copy';
    e.dataTransfer.setData('text/plain', draggedComponent.type);
    
    // Create a custom drag image
    const dragImage = e.target.cloneNode(true);
    dragImage.style.transform = 'rotate(5deg)';
    dragImage.style.opacity = '0.8';
    document.body.appendChild(dragImage);
    dragImage.style.position = 'absolute';
    dragImage.style.top = '-1000px';
    e.dataTransfer.setDragImage(dragImage, 50, 30);
    
    setTimeout(() => document.body.removeChild(dragImage), 0);
}

function handleComponentDrag(e) {
    // Visual feedback during drag
}

function handleComponentDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedComponent = null;
}

function handleCanvasDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    
    // Show drop indicator
    const canvas = e.target;
    canvas.style.background = 'rgba(102, 126, 234, 0.05)';
}

function handleCanvasDrop(e) {
    e.preventDefault();
    const canvas = e.target;
    canvas.style.background = '';
    
    if (!draggedComponent) return;
    
    const canvasRect = canvas.getBoundingClientRect();
    const x = (e.clientX - canvasRect.left - currentPan.x) / currentZoom;
    const y = (e.clientY - canvasRect.top - currentPan.y) / currentZoom;
    
    createTableFromTemplate(draggedComponent.type, x, y);
}

function createTableFromTemplate(templateType, x, y) {
    const templates = {
        'basic-table': {
            name: `new_table_${Date.now()}`,
            columns: [
                { name: 'id', type: 'INTEGER', primary_key: true, nullable: false },
                { name: 'name', type: 'VARCHAR', length: 255, nullable: false },
                { name: 'created_at', type: 'TIMESTAMP', nullable: false }
            ]
        },
        'user-table': {
            name: `users_${Date.now()}`,
            columns: [
                { name: 'user_id', type: 'INTEGER', primary_key: true, nullable: false },
                { name: 'username', type: 'VARCHAR', length: 100, nullable: false, unique: true },
                { name: 'email', type: 'VARCHAR', length: 255, nullable: false, unique: true },
                { name: 'password_hash', type: 'VARCHAR', length: 255, nullable: false },
                { name: 'created_at', type: 'TIMESTAMP', nullable: false }
            ]
        },
        'lookup-table': {
            name: `lookup_${Date.now()}`,
            columns: [
                { name: 'id', type: 'INTEGER', primary_key: true, nullable: false },
                { name: 'code', type: 'VARCHAR', length: 50, nullable: false, unique: true },
                { name: 'description', type: 'VARCHAR', length: 255, nullable: false },
                { name: 'sort_order', type: 'INTEGER', nullable: true }
            ]
        },
        'audit-table': {
            name: `activity_log_${Date.now()}`,
            columns: [
                { name: 'log_id', type: 'INTEGER', primary_key: true, nullable: false },
                { name: 'user_id', type: 'INTEGER', foreign_key: true, nullable: true },
                { name: 'action', type: 'VARCHAR', length: 100, nullable: false },
                { name: 'timestamp', type: 'TIMESTAMP', nullable: false },
                { name: 'details', type: 'TEXT', nullable: true }
            ]
        }
    };
    
    const template = templates[templateType];
    if (!template) return;
    
    // Add to erdData
    template.position = { x, y };
    template.row_count = 0;
    erdData.tables.push(template);
    
    // Create visual element
    const tableElement = createTableElement(template, erdData.tables.length - 1);
    document.getElementById('erdCanvas').appendChild(tableElement);
    
    tablePositions[template.name] = { x, y };
    tableElement.style.left = x + 'px';
    tableElement.style.top = y + 'px';
    
    // Add to history
    addToHistory('create_table', { table: template });
    
    // Auto-select the new table
    selectTable(template.name);
    
    // Create table in database
    createTableInDatabase(template);
}

function createTableInDatabase(tableData) {
    fetch('/database/erd/api/table/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: tableData.name,
            columns: tableData.columns,
            comment: tableData.comment || `Generated from ${tableData.name} template`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Table created successfully', 'success');
        } else {
            showNotification('Error creating table: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error creating table: ' + error.message, 'error');
    });
}

// =========================
// MODE HANDLING
// =========================

function setupModeButtons() {
    const modeButtons = document.querySelectorAll('[data-mode]');
    modeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            modeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            setMode(this.dataset.mode);
        });
    });
}

function setMode(mode) {
    currentMode = mode;
    const viewport = document.getElementById('erdViewport');
    
    // Clear previous mode classes
    viewport.classList.remove('select-mode', 'pan-mode', 'connect-mode');
    viewport.classList.add(mode + '-mode');
    
    // Reset connection state
    if (mode !== 'connect') {
        exitConnectionMode();
    }
    
    // Update cursor
    switch (mode) {
        case 'select':
            viewport.style.cursor = 'default';
            break;
        case 'pan':
            viewport.style.cursor = 'grab';
            break;
        case 'connect':
            viewport.style.cursor = 'crosshair';
            enterConnectionMode();
            break;
    }
}

function enterConnectionMode() {
    connectionMode = true;
    connectingFrom = null;
    connectingTo = null;
    
    // Add connection handlers to tables
    const tables = document.querySelectorAll('.table-node');
    tables.forEach(table => {
        table.classList.add('connection-ready');
        table.addEventListener('click', handleConnectionClick);
    });
}

function exitConnectionMode() {
    connectionMode = false;
    connectingFrom = null;
    connectingTo = null;
    
    // Remove temporary connection line
    if (tempConnection) {
        tempConnection.remove();
        tempConnection = null;
    }
    
    // Remove connection handlers
    const tables = document.querySelectorAll('.table-node');
    tables.forEach(table => {
        table.classList.remove('connection-ready', 'connection-source', 'connection-target');
        table.removeEventListener('click', handleConnectionClick);
    });
}

function handleConnectionClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const table = e.currentTarget;
    const tableName = table.getAttribute('data-table');
    
    if (!connectingFrom) {
        // First table selection
        connectingFrom = tableName;
        table.classList.add('connection-source');
        showNotification('Select target table to create relationship', 'info');
    } else if (connectingFrom === tableName) {
        // Clicked same table, cancel
        exitConnectionMode();
        setMode('select');
        showNotification('Connection cancelled', 'info');
    } else {
        // Second table selection - create relationship
        connectingTo = tableName;
        table.classList.add('connection-target');
        
        // Show relationship dialog
        showRelationshipDialog(connectingFrom, connectingTo);
    }
}

function showRelationshipDialog(sourceTable, targetTable) {
    const dialog = document.createElement('div');
    dialog.className = 'relationship-dialog';
    dialog.innerHTML = `
        <div class="dialog-overlay"></div>
        <div class="dialog-content">
            <h3>Create Relationship</h3>
            <div class="relationship-form">
                <div class="form-group">
                    <label>From: <strong>${sourceTable}</strong></label>
                    <select id="sourceColumns" multiple>
                        ${getTableColumns(sourceTable).map(col => 
                            `<option value="${col.name}">${col.name} (${col.type})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>To: <strong>${targetTable}</strong></label>
                    <select id="targetColumns" multiple>
                        ${getTableColumns(targetTable).map(col => 
                            `<option value="${col.name}">${col.name} (${col.type})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Relationship Type:</label>
                    <select id="relationshipType">
                        <option value="one-to-many">One to Many</option>
                        <option value="one-to-one">One to One</option>
                        <option value="many-to-many">Many to Many</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Constraint Name:</label>
                    <input type="text" id="constraintName" value="fk_${sourceTable}_${targetTable}">
                </div>
            </div>
            <div class="dialog-actions">
                <button onclick="createRelationship()" class="btn btn-primary">Create</button>
                <button onclick="closeRelationshipDialog()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

function getTableColumns(tableName) {
    const table = erdData.tables.find(t => t.name === tableName);
    return table ? table.columns : [];
}

function createRelationship() {
    const sourceColumns = Array.from(document.getElementById('sourceColumns').selectedOptions).map(o => o.value);
    const targetColumns = Array.from(document.getElementById('targetColumns').selectedOptions).map(o => o.value);
    const relationshipType = document.getElementById('relationshipType').value;
    const constraintName = document.getElementById('constraintName').value;
    
    if (sourceColumns.length === 0 || targetColumns.length === 0) {
        showNotification('Please select columns for both tables', 'error');
        return;
    }
    
    const relationship = {
        id: `rel_${Date.now()}`,
        source_table: connectingFrom,
        target_table: connectingTo,
        source_columns: sourceColumns,
        target_columns: targetColumns,
        relationship_type: relationshipType,
        constraint_name: constraintName
    };
    
    // Add to erdData
    erdData.relationships.push(relationship);
    
    // Create visual relationship
    createRelationshipLine(relationship);
    
    // Add to history
    addToHistory('create_relationship', { relationship });
    
    closeRelationshipDialog();
    exitConnectionMode();
    setMode('select');
    
    showNotification('Relationship created successfully', 'success');
}

function closeRelationshipDialog() {
    const dialog = document.querySelector('.relationship-dialog');
    if (dialog) {
        dialog.remove();
    }
}

// =========================
// MULTI-SELECTION
// =========================

function setupMultiSelection() {
    const canvas = document.getElementById('erdCanvas');
    let selectionBox = null;
    let isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    
    canvas.addEventListener('mousedown', function(e) {
        if (currentMode !== 'select' || e.target.classList.contains('table-node')) return;
        
        isSelecting = true;
        selectionStart = { x: e.clientX, y: e.clientY };
        
        // Create selection box
        selectionBox = document.createElement('div');
        selectionBox.className = 'selection-box';
        selectionBox.style.left = selectionStart.x + 'px';
        selectionBox.style.top = selectionStart.y + 'px';
        document.body.appendChild(selectionBox);
        
        // Clear previous selection if not holding Ctrl
        if (!e.ctrlKey && !e.metaKey) {
            clearSelection();
        }
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isSelecting || !selectionBox) return;
        
        const currentX = e.clientX;
        const currentY = e.clientY;
        
        const left = Math.min(selectionStart.x, currentX);
        const top = Math.min(selectionStart.y, currentY);
        const width = Math.abs(currentX - selectionStart.x);
        const height = Math.abs(currentY - selectionStart.y);
        
        selectionBox.style.left = left + 'px';
        selectionBox.style.top = top + 'px';
        selectionBox.style.width = width + 'px';
        selectionBox.style.height = height + 'px';
        
        // Highlight tables within selection
        highlightTablesInSelection({ left, top, width, height });
    });
    
    document.addEventListener('mouseup', function(e) {
        if (!isSelecting) return;
        
        isSelecting = false;
        
        if (selectionBox) {
            selectionBox.remove();
            selectionBox = null;
        }
    });
}

function highlightTablesInSelection(selectionRect) {
    const tables = document.querySelectorAll('.table-node');
    tables.forEach(table => {
        const rect = table.getBoundingClientRect();
        
        const intersects = !(
            rect.right < selectionRect.left ||
            rect.left > selectionRect.left + selectionRect.width ||
            rect.bottom < selectionRect.top ||
            rect.top > selectionRect.top + selectionRect.height
        );
        
        if (intersects) {
            table.classList.add('selection-highlight');
        } else {
            table.classList.remove('selection-highlight');
        }
    });
}

function clearSelection() {
    selectedTables = [];
    document.querySelectorAll('.table-node').forEach(table => {
        table.classList.remove('selected', 'selection-highlight');
    });
}

// =========================
// SIDEBAR TABS
// =========================

function setupSidebarTabs() {
    const tabs = document.querySelectorAll('.sidebar-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            const targetPane = document.getElementById(this.dataset.tab + 'Tab');
            if (targetPane) {
                targetPane.classList.add('active');
            }
        });
    });
}

// =========================
// HISTORY AND UNDO/REDO
// =========================

function addToHistory(action, data) {
    // Remove any history after current position
    actionHistory.splice(historyPosition + 1);
    
    // Add new action
    actionHistory.push({
        action,
        data,
        timestamp: new Date()
    });
    
    historyPosition++;
    
    // Limit history size
    if (actionHistory.length > 50) {
        actionHistory.shift();
        historyPosition--;
    }
    
    updateHistoryUI();
}

function undoLastAction() {
    if (historyPosition < 0) return;
    
    const action = actionHistory[historyPosition];
    
    switch (action.action) {
        case 'create_table':
            removeTable(action.data.table.name);
            break;
        case 'create_relationship':
            removeRelationship(action.data.relationship.id);
            break;
        // Add more undo actions as needed
    }
    
    historyPosition--;
    updateHistoryUI();
}

function redoLastAction() {
    if (historyPosition >= actionHistory.length - 1) return;
    
    historyPosition++;
    const action = actionHistory[historyPosition];
    
    switch (action.action) {
        case 'create_table':
            // Re-create table
            break;
        case 'create_relationship':
            // Re-create relationship
            break;
    }
    
    updateHistoryUI();
}

function updateHistoryUI() {
    const historyList = document.querySelector('.history-list');
    if (!historyList) return;
    
    historyList.innerHTML = actionHistory.slice(-10).map((action, index) => {
        const timeAgo = getTimeAgo(action.timestamp);
        const actionText = getActionText(action);
        
        return `
            <div class="history-item">
                <span><i class="fa ${getActionIcon(action.action)}"></i> ${actionText}</span>
                <span class="history-time">${timeAgo}</span>
            </div>
        `;
    }).reverse().join('');
}

function getActionText(action) {
    switch (action.action) {
        case 'create_table': return `Created table "${action.data.table.name}"`;
        case 'create_relationship': return `Created relationship`;
        case 'modify_table': return `Modified table`;
        default: return action.action;
    }
}

function getActionIcon(action) {
    switch (action) {
        case 'create_table': return 'fa-plus';
        case 'create_relationship': return 'fa-link';
        case 'modify_table': return 'fa-edit';
        default: return 'fa-cog';
    }
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes} min ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hr ago`;
    return `${Math.floor(hours / 24)} day ago`;
}

// =========================
// UTILITY FUNCTIONS
// =========================

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fa ${type === 'error' ? 'fa-exclamation-circle' : 
                     type === 'success' ? 'fa-check-circle' : 
                     'fa-info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function toggleLeftSidebar() {
    const sidebar = document.getElementById('leftSidebar');
    const icon = document.getElementById('leftSidebarIcon');
    
    sidebar.classList.toggle('collapsed');
    
    if (sidebar.classList.contains('collapsed')) {
        icon.className = 'fa fa-chevron-right';
    } else {
        icon.className = 'fa fa-chevron-left';
    }
}

// =========================
// NEW TOOLBAR FUNCTIONS
// =========================

function createNewTable() {
    const canvas = document.getElementById('erdCanvas');
    const rect = canvas.getBoundingClientRect();
    
    // Place new table in center of viewport
    const x = (rect.width / 2 - currentPan.x) / currentZoom;
    const y = (rect.height / 2 - currentPan.y) / currentZoom;
    
    createTableFromTemplate('basic-table', x, y);
}

function alignTables(direction) {
    if (selectedTables.length < 2) {
        showNotification('Select at least 2 tables to align', 'error');
        return;
    }
    
    const tables = selectedTables.map(name => ({
        name,
        element: document.getElementById(`table-${name}`),
        position: tablePositions[name]
    }));
    
    if (direction === 'horizontal') {
        // Align to the average Y position
        const avgY = tables.reduce((sum, table) => sum + table.position.y, 0) / tables.length;
        
        tables.forEach(table => {
            table.position.y = avgY;
            table.element.style.top = avgY + 'px';
            tablePositions[table.name] = table.position;
        });
    } else if (direction === 'vertical') {
        // Align to the average X position
        const avgX = tables.reduce((sum, table) => sum + table.position.x, 0) / tables.length;
        
        tables.forEach(table => {
            table.position.x = avgX;
            table.element.style.left = avgX + 'px';
            tablePositions[table.name] = table.position;
        });
    }
    
    // Update relationships
    tables.forEach(table => updateRelationshipsForTable(table.name));
    saveTablePositions();
    showNotification(`Tables aligned ${direction}ly`, 'success');
}

function distributeTables() {
    if (selectedTables.length < 3) {
        showNotification('Select at least 3 tables to distribute', 'error');
        return;
    }
    
    const tables = selectedTables.map(name => ({
        name,
        element: document.getElementById(`table-${name}`),
        position: tablePositions[name]
    }));
    
    // Sort by X position
    tables.sort((a, b) => a.position.x - b.position.x);
    
    // Calculate even spacing
    const leftmost = tables[0].position.x;
    const rightmost = tables[tables.length - 1].position.x;
    const totalWidth = rightmost - leftmost;
    const spacing = totalWidth / (tables.length - 1);
    
    tables.forEach((table, index) => {
        if (index > 0 && index < tables.length - 1) {
            table.position.x = leftmost + (spacing * index);
            table.element.style.left = table.position.x + 'px';
            tablePositions[table.name] = table.position;
            updateRelationshipsForTable(table.name);
        }
    });
    
    saveTablePositions();
    showNotification('Tables distributed evenly', 'success');
}

// =========================
// ADVANCED ACTIONS
// =========================

function generateFromSQL() {
    const dialog = document.createElement('div');
    dialog.className = 'sql-dialog';
    dialog.innerHTML = `
        <div class="dialog-overlay"></div>
        <div class="dialog-content">
            <h3>Generate Tables from SQL</h3>
            <textarea placeholder="Paste your CREATE TABLE statements here..." rows="15"></textarea>
            <div class="dialog-actions">
                <button onclick="processSQLGeneration(this)" class="btn btn-primary">Generate</button>
                <button onclick="this.closest('.sql-dialog').remove()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
}

function processSQLGeneration(button) {
    const sql = button.closest('.dialog-content').querySelector('textarea').value;
    if (!sql.trim()) {
        showNotification('Please enter SQL statements', 'error');
        return;
    }
    
    // This would parse SQL and create tables
    showNotification('SQL parsing functionality would be implemented here', 'info');
    button.closest('.sql-dialog').remove();
}

function reverseEngineer() {
    fetch('/database/erd/api/schema/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the ERD with latest schema
                erdData = data.schema;
                createTables();
                createRelationships();
                fitToScreen();
                showNotification('Schema refreshed from database', 'success');
            } else {
                showNotification('Error refreshing schema: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Error: ' + error.message, 'error');
        });
}

function validateSchema() {
    let issues = [];
    
    // Check for tables without primary keys
    erdData.tables.forEach(table => {
        const hasPK = table.columns.some(col => col.primary_key);
        if (!hasPK) {
            issues.push(`Table "${table.name}" has no primary key`);
        }
    });
    
    // Check for orphaned foreign keys
    erdData.relationships.forEach(rel => {
        const sourceTable = erdData.tables.find(t => t.name === rel.source_table);
        const targetTable = erdData.tables.find(t => t.name === rel.target_table);
        
        if (!sourceTable) {
            issues.push(`Relationship references missing table "${rel.source_table}"`);
        }
        if (!targetTable) {
            issues.push(`Relationship references missing table "${rel.target_table}"`);
        }
    });
    
    if (issues.length === 0) {
        showNotification('Schema validation passed!', 'success');
    } else {
        showNotification(`Found ${issues.length} issues. Check console for details.`, 'error');
        console.warn('Schema Issues:', issues);
    }
}

function optimizeLayout() {
    applyLayout('force');
    setTimeout(() => {
        fitToScreen();
        showNotification('Layout optimized', 'success');
    }, 1000);
}

// Layer management functions
function toggleLayer(layerName) {
    const btn = document.querySelector(`[data-layer="${layerName}"]`);
    const isActive = btn.classList.contains('active');
    
    switch (layerName) {
        case 'tables':
            document.querySelectorAll('.table-node').forEach(table => {
                table.style.display = isActive ? 'none' : 'block';
            });
            break;
        case 'relationships':
            document.querySelectorAll('.relationship-path').forEach(path => {
                path.style.display = isActive ? 'none' : 'block';
            });
            break;
    }
    
    btn.classList.toggle('active');
}
</script>
{% endblock %}