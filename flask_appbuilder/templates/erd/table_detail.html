{% extends "appbuilder/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_css %}
{{ super() }}
<style>
/* Table Detail Styles */
.table-detail-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.detail-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-title {
    font-size: 2rem;
    margin: 0;
    font-weight: 600;
}

.table-meta {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-top: 5px;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-light {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}

.btn-light:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    text-decoration: none;
}

.content-tabs {
    margin-bottom: 30px;
}

.nav-tabs {
    border-bottom: 2px solid #e9ecef;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 500;
    padding: 15px 20px;
}

.nav-tabs .nav-link.active {
    color: #28a745;
    border-bottom-color: #28a745;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #28a745;
    color: #28a745;
}

.tab-content {
    margin-top: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    text-align: center;
    border-left: 4px solid #28a745;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #28a745;
    margin: 0;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 5px;
}

.columns-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.columns-table table {
    width: 100%;
    margin: 0;
}

.columns-table th {
    background: #f8f9fa;
    padding: 15px;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
}

.columns-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f1f1;
    vertical-align: middle;
}

.column-name {
    font-family: 'Monaco', 'Consolas', monospace;
    font-weight: 600;
    color: #495057;
}

.column-type {
    font-family: 'Monaco', 'Consolas', monospace;
    color: #007bff;
    font-weight: 500;
}

.column-flags {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.flag-badge {
    padding: 2px 6px;
    font-size: 0.7rem;
    border-radius: 3px;
    font-weight: bold;
    text-transform: uppercase;
}

.flag-primary {
    background: #007bff;
    color: white;
}

.flag-warning {
    background: #ffc107;
    color: #212529;
}

.flag-success {
    background: #28a745;
    color: white;
}

.flag-info {
    background: #17a2b8;
    color: white;
}

.relationships-list {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.relationship-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.relationship-item:hover {
    background: #f8f9fa;
    border-color: #28a745;
}

.relationship-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #28a745;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1.2rem;
}

.relationship-details {
    flex: 1;
}

.relationship-title {
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.relationship-desc {
    color: #6c757d;
    font-size: 0.9rem;
    margin: 0;
    font-family: 'Monaco', 'Consolas', monospace;
}

.data-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-top: 20px;
}

.data-table table {
    width: 100%;
    margin: 0;
}

.data-table th {
    background: #f8f9fa;
    padding: 12px;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    font-size: 0.9rem;
}

.data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #f1f1f1;
    font-size: 0.9rem;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.data-table td.null-value {
    color: #6c757d;
    font-style: italic;
}

.load-more {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
}

@media (max-width: 768px) {
    .detail-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .columns-table,
    .data-table {
        overflow-x: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="table-detail-container">
    <!-- Header -->
    <div class="detail-header">
        <div>
            <h1 class="table-title">{{ table.name }}</h1>
            <div class="table-meta">
                {{ table.columns|length }} columns • 
                {% if table.row_count is not none %}{{ table.row_count }} rows{% else %}Unknown rows{% endif %}
                {% if table.comment %} • {{ table.comment }}{% endif %}
            </div>
        </div>
        <div class="action-buttons">
            <a href="{{ url_for('DatabaseERDView.edit_table', table_name=table.name) }}" class="btn btn-light">
                <i class="fa fa-edit"></i> Edit Table
            </a>
            <a href="{{ url_for('DatabaseERDView.schema') }}" class="btn btn-light">
                <i class="fa fa-sitemap"></i> View Schema
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ table.columns|length }}</div>
            <div class="stat-label">Columns</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ table.primary_keys|length }}</div>
            <div class="stat-label">Primary Keys</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ table.foreign_keys|length }}</div>
            <div class="stat-label">Foreign Keys</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ table.indexes|length }}</div>
            <div class="stat-label">Indexes</div>
        </div>
    </div>

    <!-- Content Tabs -->
    <div class="content-tabs">
        <ul class="nav nav-tabs" id="tableTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="columns-tab" data-toggle="tab" href="#columns" role="tab">
                    <i class="fa fa-columns"></i> Columns
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="relationships-tab" data-toggle="tab" href="#relationships" role="tab">
                    <i class="fa fa-link"></i> Relationships
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="data-tab" data-toggle="tab" href="#data" role="tab">
                    <i class="fa fa-table"></i> Sample Data
                </a>
            </li>
        </ul>
        
        <div class="tab-content" id="tableTabContent">
            <!-- Columns Tab -->
            <div class="tab-pane fade show active" id="columns" role="tabpanel">
                <div class="columns-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Data Type</th>
                                <th>Nullable</th>
                                <th>Default</th>
                                <th>Flags</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for column in table.columns %}
                            <tr>
                                <td class="column-name">{{ column.name }}</td>
                                <td class="column-type">
                                    {{ column.type }}
                                    {% if column.length %}({{ column.length }}){% endif %}
                                </td>
                                <td>
                                    {% if column.nullable %}
                                        <span class="text-success">✓</span>
                                    {% else %}
                                        <span class="text-danger">✗</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if column.default %}
                                        <code>{{ column.default }}</code>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="column-flags">
                                        {% if column.primary_key %}
                                            <span class="flag-badge flag-primary">PK</span>
                                        {% endif %}
                                        {% if column.foreign_key %}
                                            <span class="flag-badge flag-warning">FK</span>
                                        {% endif %}
                                        {% if column.unique %}
                                            <span class="flag-badge flag-info">UQ</span>
                                        {% endif %}
                                        {% if column.autoincrement %}
                                            <span class="flag-badge flag-success">AI</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if column.comment %}
                                        {{ column.comment }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Relationships Tab -->
            <div class="tab-pane fade" id="relationships" role="tabpanel">
                <div class="relationships-list">
                    {% if relationships %}
                        {% for rel in relationships %}
                        <div class="relationship-item">
                            <div class="relationship-icon">
                                <i class="fa fa-link"></i>
                            </div>
                            <div class="relationship-details">
                                <div class="relationship-title">
                                    {% if rel.source_table == table.name %}
                                        {{ table.name }} → {{ rel.target_table }}
                                    {% else %}
                                        {{ rel.source_table }} → {{ table.name }}
                                    {% endif %}
                                </div>
                                <div class="relationship-desc">
                                    {{ rel.source_columns|join(', ') }} → {{ rel.target_columns|join(', ') }}
                                    {% if rel.constraint_name %}({{ rel.constraint_name }}){% endif %}
                                </div>
                            </div>
                            <div class="relationship-type">
                                <span class="badge badge-secondary">{{ rel.relationship_type }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fa fa-info-circle fa-2x mb-3"></i>
                            <p>No relationships found for this table</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sample Data Tab -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <div class="data-table">
                    {% if sample_data %}
                        <table>
                            <thead>
                                <tr>
                                    {% for column in table.columns %}
                                    <th>{{ column.name }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in sample_data %}
                                <tr>
                                    {% for column in table.columns %}
                                    <td {% if row[column.name] is none %}class="null-value"{% endif %}>
                                        {% if row[column.name] is none %}
                                            NULL
                                        {% else %}
                                            {{ row[column.name] }}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        {% if sample_data|length >= 50 %}
                        <div class="load-more">
                            <button class="btn btn-outline-primary" onclick="loadMoreData()">
                                <i class="fa fa-refresh"></i> Load More Data
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fa fa-database fa-2x mb-3"></i>
                            <p>No data available in this table</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/js/bootstrap.bundle.min.js"></script>
<script>
function loadMoreData() {
    const button = event.target;
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading...';
    button.disabled = true;
    
    fetch(`/database/erd/api/table/{{ table.name }}/data/?limit=100`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // In a full implementation, this would append more rows
                alert(`Loaded ${data.count} rows of data`);
            } else {
                alert('Error loading data: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading data');
        })
        .finally(() => {
            button.innerHTML = '<i class="fa fa-refresh"></i> Load More Data';
            button.disabled = false;
        });
}

// Initialize tooltips if available
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}