<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Intelligent Recommendations</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<style>
		.recommendation-card {
			transition: all 0.3s ease-in-out;
			border-left: 4px solid #6c757d;
			margin-bottom: 1rem;
		}
		
		.recommendation-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
		}
		
		.confidence-high { border-left-color: #28a745; }
		.confidence-medium { border-left-color: #ffc107; }
		.confidence-low { border-left-color: #dc3545; }
		
		.impact-high { 
			background: linear-gradient(135deg, #d4edda, #c3e6cb); 
		}
		.impact-medium { 
			background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
		}
		.impact-low { 
			background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
		}
		
		.confidence-badge {
			position: absolute;
			top: 10px;
			right: 10px;
			border-radius: 50px;
			padding: 0.25rem 0.75rem;
			font-size: 0.75rem;
			font-weight: 600;
		}
		
		.effort-indicator {
			display: inline-flex;
			align-items: center;
			gap: 0.25rem;
			padding: 0.25rem 0.5rem;
			border-radius: 1rem;
			font-size: 0.75rem;
			font-weight: 500;
		}
		
		.effort-easy { background-color: #d4edda; color: #155724; }
		.effort-moderate { background-color: #fff3cd; color: #856404; }
		.effort-complex { background-color: #f8d7da; color: #721c24; }
		
		.category-tabs {
			border-bottom: 2px solid #e9ecef;
			margin-bottom: 2rem;
		}
		
		.category-tab {
			position: relative;
			padding: 1rem 1.5rem;
			margin-right: 0.5rem;
			border: none;
			background: none;
			color: #6c757d;
			font-weight: 500;
			transition: all 0.2s ease-in-out;
			border-radius: 0.5rem 0.5rem 0 0;
		}
		
		.category-tab:hover {
			color: #495057;
			background-color: #f8f9fa;
		}
		
		.category-tab.active {
			color: #495057;
			background-color: #fff;
			border-bottom: 2px solid #007bff;
		}
		
		.analytics-summary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 1rem;
			padding: 2rem;
			margin-bottom: 2rem;
		}
		
		.stat-card {
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			border-radius: 0.5rem;
			padding: 1.5rem;
			text-align: center;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		
		.stat-number {
			font-size: 2.5rem;
			font-weight: bold;
			line-height: 1;
			margin-bottom: 0.5rem;
		}
		
		.stat-label {
			font-size: 0.875rem;
			opacity: 0.9;
		}
		
		.action-buttons {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
			margin-top: 1rem;
		}
		
		.action-btn {
			padding: 0.5rem 1rem;
			border-radius: 50px;
			font-size: 0.875rem;
			font-weight: 500;
			border: none;
			transition: all 0.2s ease-in-out;
			cursor: pointer;
		}
		
		.btn-implement {
			background-color: #28a745;
			color: white;
		}
		
		.btn-implement:hover {
			background-color: #218838;
			transform: scale(1.05);
		}
		
		.btn-dismiss {
			background-color: #6c757d;
			color: white;
		}
		
		.btn-feedback {
			background-color: #17a2b8;
			color: white;
		}
		
		.filter-controls {
			background-color: #f8f9fa;
			padding: 1.5rem;
			border-radius: 0.5rem;
			margin-bottom: 2rem;
		}
		
		.recommendation-meta {
			display: flex;
			align-items: center;
			gap: 1rem;
			margin-top: 1rem;
			font-size: 0.875rem;
			color: #6c757d;
		}
		
		.graph-selector {
			background-color: #fff;
			border: 2px solid #e9ecef;
			border-radius: 0.5rem;
			padding: 0.75rem;
			transition: border-color 0.2s ease-in-out;
		}
		
		.graph-selector:focus {
			border-color: #007bff;
			outline: none;
			box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
		}
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<h1 class="h2 mb-0">
							<i class="fas fa-lightbulb text-warning me-2"></i>
							{{ title }}
						</h1>
						<p class="text-muted mb-0">AI-powered insights to optimize your graph analytics workflow</p>
					</div>
					<div class="btn-group">
						<a href="{{ url_for('RecommendationView.analytics') }}" class="btn btn-outline-primary">
							<i class="fas fa-chart-bar me-1"></i> Analytics
						</a>
						<button class="btn btn-primary" onclick="refreshRecommendations()">
							<i class="fas fa-sync me-1"></i> Refresh
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Analytics Summary -->
		<div class="analytics-summary">
			<div class="row">
				<div class="col-md-8">
					<h3 class="mb-3">Recommendation Insights</h3>
					<p class="mb-4">Personalized recommendations based on your usage patterns and best practices</p>
					
					<div class="row">
						<div class="col-md-4">
							<div class="stat-card">
								<div class="stat-number">{{ recommendations|length }}</div>
								<div class="stat-label">Active Recommendations</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="stat-card">
								<div class="stat-number">{{ "%.0f"|format(analytics.implementation_rate * 100) }}%</div>
								<div class="stat-label">Implementation Rate</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="stat-card">
								<div class="stat-number">{{ analytics.total_recommendations }}</div>
								<div class="stat-label">Total Generated</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="text-center">
						<i class="fas fa-robot fa-4x mb-3" style="opacity: 0.7;"></i>
						<h5>AI-Powered Insights</h5>
						<p class="mb-0">Machine learning algorithms analyze your patterns to provide personalized suggestions</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Filter Controls -->
		<div class="filter-controls">
			<div class="row align-items-end">
				<div class="col-md-3">
					<label for="graphSelector" class="form-label">
						<i class="fas fa-project-diagram me-1"></i>
						Select Graph
					</label>
					<select id="graphSelector" class="form-select graph-selector" onchange="changeGraph()">
						{% for graph in available_graphs %}
							<option value="{{ graph }}" {% if graph == selected_graph %}selected{% endif %}>
								{{ graph|title }}
							</option>
						{% endfor %}
					</select>
				</div>
				<div class="col-md-3">
					<label for="impactFilter" class="form-label">
						<i class="fas fa-exclamation-circle me-1"></i>
						Filter by Impact
					</label>
					<select id="impactFilter" class="form-select" onchange="filterByImpact()">
						<option value="">All Impact Levels</option>
						<option value="high">High Impact</option>
						<option value="medium">Medium Impact</option>
						<option value="low">Low Impact</option>
					</select>
				</div>
				<div class="col-md-3">
					<label for="effortFilter" class="form-label">
						<i class="fas fa-tasks me-1"></i>
						Filter by Effort
					</label>
					<select id="effortFilter" class="form-select" onchange="filterByEffort()">
						<option value="">All Effort Levels</option>
						<option value="easy">Easy Implementation</option>
						<option value="moderate">Moderate Effort</option>
						<option value="complex">Complex Implementation</option>
					</select>
				</div>
				<div class="col-md-3">
					<button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
						<i class="fas fa-times me-1"></i> Clear Filters
					</button>
				</div>
			</div>
		</div>

		<!-- Category Tabs -->
		<div class="category-tabs">
			<button class="category-tab active" data-category="all">
				All Recommendations
				<span class="badge bg-primary ms-2">{{ recommendations|length }}</span>
			</button>
			{% for category, recs in categorized_recommendations.items() %}
				{% if recs %}
					<button class="category-tab" data-category="{{ category|lower }}">
						{{ category }}
						<span class="badge bg-secondary ms-2">{{ recs|length }}</span>
					</button>
				{% endif %}
			{% endfor %}
		</div>

		<!-- Recommendations List -->
		<div id="recommendationsContainer">
			{% if recommendations %}
				{% for rec in recommendations %}
					<div class="recommendation-card card impact-{{ rec.potential_impact }} confidence-{{ 'high' if rec.confidence_score > 0.8 else ('medium' if rec.confidence_score > 0.5 else 'low') }}" 
						 data-category="{{ rec.category|lower }}" 
						 data-impact="{{ rec.potential_impact }}" 
						 data-effort="{{ rec.implementation_effort }}">
						
						<div class="confidence-badge bg-{{ 'success' if rec.confidence_score > 0.8 else ('warning' if rec.confidence_score > 0.5 else 'danger') }}">
							{{ "%.0f"|format(rec.confidence_score * 100) }}%
						</div>
						
						<div class="card-body position-relative">
							<div class="d-flex justify-content-between align-items-start mb-3">
								<div>
									<h5 class="card-title mb-1">{{ rec.title }}</h5>
									<span class="badge bg-primary me-2">{{ rec.type.replace('_', ' ')|title }}</span>
									<span class="effort-indicator effort-{{ rec.implementation_effort }}">
										<i class="fas fa-{{ 'leaf' if rec.implementation_effort == 'easy' else ('cog' if rec.implementation_effort == 'moderate' else 'tools') }}"></i>
										{{ rec.implementation_effort|title }}
									</span>
								</div>
								<div class="text-end">
									<div class="text-muted small">{{ rec.category }}</div>
									<div class="badge bg-{{ 'danger' if rec.potential_impact == 'high' else ('warning' if rec.potential_impact == 'medium' else 'secondary') }}">
										{{ rec.potential_impact|title }} Impact
									</div>
								</div>
							</div>
							
							<p class="card-text">{{ rec.description }}</p>
							
							<div class="recommendation-details">
								<div class="row">
									<div class="col-md-6">
										<h6 class="text-muted mb-2">
											<i class="fas fa-bullseye me-1"></i>
											Suggested Action
										</h6>
										<p class="mb-3">{{ rec.suggested_action }}</p>
									</div>
									<div class="col-md-6">
										<h6 class="text-muted mb-2">
											<i class="fas fa-info-circle me-1"></i>
											Rationale
										</h6>
										<p class="mb-3">{{ rec.rationale }}</p>
									</div>
								</div>
							</div>
							
							<div class="action-buttons">
								<button class="action-btn btn-implement" 
										onclick="implementRecommendation('{{ rec.recommendation_id }}')">
									<i class="fas fa-check me-1"></i>
									Implement
								</button>
								<button class="action-btn btn-feedback" 
										onclick="provideFeedback('{{ rec.recommendation_id }}')">
									<i class="fas fa-comment me-1"></i>
									Feedback
								</button>
								<button class="action-btn btn-dismiss" 
										onclick="dismissRecommendation('{{ rec.recommendation_id }}')">
									<i class="fas fa-times me-1"></i>
									Dismiss
								</button>
								{% if rec.supporting_data %}
									<button class="action-btn btn-outline-secondary" 
											onclick="viewDetails('{{ rec.recommendation_id }}')">
										<i class="fas fa-info me-1"></i>
										Details
									</button>
								{% endif %}
							</div>
							
							<div class="recommendation-meta">
								<span>
									<i class="fas fa-clock me-1"></i>
									{{ rec.created_at[:16] }}
								</span>
								{% if rec.applicable_graphs %}
									<span>
										<i class="fas fa-project-diagram me-1"></i>
										{{ rec.applicable_graphs|join(', ') }}
									</span>
								{% endif %}
								<span>
									<i class="fas fa-user me-1"></i>
									Personalized for you
								</span>
							</div>
						</div>
					</div>
				{% endfor %}
			{% else %}
				<div class="text-center py-5">
					<i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
					<h4 class="text-muted">No Recommendations Available</h4>
					<p class="text-muted">Start using the graph analytics features to receive personalized recommendations.</p>
					<button class="btn btn-primary" onclick="refreshRecommendations()">
						<i class="fas fa-sync me-1"></i>
						Generate Recommendations
					</button>
				</div>
			{% endif %}
		</div>
	</div>

	<!-- Implementation Modal -->
	<div class="modal fade" id="implementModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-check text-success me-2"></i>
						Implement Recommendation
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to mark this recommendation as implemented?</p>
					<div class="mb-3">
						<label for="implementationNotes" class="form-label">Implementation Notes (Optional)</label>
						<textarea class="form-control" id="implementationNotes" rows="3" 
								  placeholder="Add any notes about how you implemented this recommendation..."></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-success" onclick="confirmImplementation()">
						<i class="fas fa-check me-1"></i>
						Mark as Implemented
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Feedback Modal -->
	<div class="modal fade" id="feedbackModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-comment text-info me-2"></i>
						Provide Feedback
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="feedbackText" class="form-label">Your Feedback</label>
						<textarea class="form-control" id="feedbackText" rows="4" 
								  placeholder="Share your thoughts on this recommendation..."></textarea>
					</div>
					<div class="mb-3">
						<label for="feedbackRating" class="form-label">Rating</label>
						<select class="form-select" id="feedbackRating">
							<option value="">Select Rating</option>
							<option value="5">⭐⭐⭐⭐⭐ Excellent</option>
							<option value="4">⭐⭐⭐⭐ Good</option>
							<option value="3">⭐⭐⭐ Average</option>
							<option value="2">⭐⭐ Poor</option>
							<option value="1">⭐ Very Poor</option>
						</select>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="willImplement">
						<label class="form-check-label" for="willImplement">
							I plan to implement this recommendation
						</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-info" onclick="submitFeedback()">
						<i class="fas fa-paper-plane me-1"></i>
						Submit Feedback
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Details Modal -->
	<div class="modal fade" id="detailsModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-info-circle text-primary me-2"></i>
						Recommendation Details
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="detailsContent">
						<!-- Details will be loaded here -->
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		// Global variables
		let currentRecommendationId = null;
		let allRecommendations = {{ recommendations | tojson }};
		
		// Initialize page
		document.addEventListener('DOMContentLoaded', function() {
			setupCategoryTabs();
		});
		
		// Category tab functionality
		function setupCategoryTabs() {
			const tabs = document.querySelectorAll('.category-tab');
			tabs.forEach(tab => {
				tab.addEventListener('click', function() {
					const category = this.dataset.category;
					filterByCategory(category);
					
					// Update active tab
					tabs.forEach(t => t.classList.remove('active'));
					this.classList.add('active');
				});
			});
		}
		
		function filterByCategory(category) {
			const cards = document.querySelectorAll('.recommendation-card');
			
			cards.forEach(card => {
				if (category === 'all' || card.dataset.category === category) {
					card.style.display = 'block';
				} else {
					card.style.display = 'none';
				}
			});
		}
		
		function filterByImpact() {
			const impact = document.getElementById('impactFilter').value;
			const cards = document.querySelectorAll('.recommendation-card');
			
			cards.forEach(card => {
				if (!impact || card.dataset.impact === impact) {
					card.style.display = 'block';
				} else {
					card.style.display = 'none';
				}
			});
		}
		
		function filterByEffort() {
			const effort = document.getElementById('effortFilter').value;
			const cards = document.querySelectorAll('.recommendation-card');
			
			cards.forEach(card => {
				if (!effort || card.dataset.effort === effort) {
					card.style.display = 'block';
				} else {
					card.style.display = 'none';
				}
			});
		}
		
		function clearFilters() {
			document.getElementById('impactFilter').value = '';
			document.getElementById('effortFilter').value = '';
			
			const cards = document.querySelectorAll('.recommendation-card');
			cards.forEach(card => card.style.display = 'block');
		}
		
		function changeGraph() {
			const selectedGraph = document.getElementById('graphSelector').value;
			window.location.href = `?graph=${selectedGraph}`;
		}
		
		// Recommendation actions
		function implementRecommendation(recommendationId) {
			currentRecommendationId = recommendationId;
			const modal = new bootstrap.Modal(document.getElementById('implementModal'));
			modal.show();
		}
		
		async function confirmImplementation() {
			const notes = document.getElementById('implementationNotes').value;
			
			try {
				const response = await fetch('/recommendations/api/recommendations/implement/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						recommendation_id: currentRecommendationId,
						notes: notes
					})
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert('Recommendation marked as implemented successfully!');
					location.reload();
				} else {
					alert('Error: ' + result.error);
				}
			} catch (error) {
				console.error('Error implementing recommendation:', error);
				alert('Error implementing recommendation: ' + error.message);
			}
			
			bootstrap.Modal.getInstance(document.getElementById('implementModal')).hide();
		}
		
		function provideFeedback(recommendationId) {
			currentRecommendationId = recommendationId;
			const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
			modal.show();
		}
		
		async function submitFeedback() {
			const feedbackText = document.getElementById('feedbackText').value;
			const rating = document.getElementById('feedbackRating').value;
			const willImplement = document.getElementById('willImplement').checked;
			
			if (!feedbackText.trim()) {
				alert('Please provide feedback text');
				return;
			}
			
			try {
				const response = await fetch('/recommendations/api/recommendations/feedback/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						recommendation_id: currentRecommendationId,
						feedback: feedbackText,
						rating: rating ? parseInt(rating) : null,
						implemented: willImplement
					})
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert('Feedback submitted successfully!');
					document.getElementById('feedbackText').value = '';
					document.getElementById('feedbackRating').value = '';
					document.getElementById('willImplement').checked = false;
				} else {
					alert('Error: ' + result.error);
				}
			} catch (error) {
				console.error('Error submitting feedback:', error);
				alert('Error submitting feedback: ' + error.message);
			}
			
			bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
		}
		
		function dismissRecommendation(recommendationId) {
			if (confirm('Are you sure you want to dismiss this recommendation?')) {
				// Implementation for dismissing recommendation
				console.log('Dismissing recommendation:', recommendationId);
			}
		}
		
		function viewDetails(recommendationId) {
			const rec = allRecommendations.find(r => r.recommendation_id === recommendationId);
			
			if (rec && rec.supporting_data) {
				const content = document.getElementById('detailsContent');
				content.innerHTML = `
					<div class="row">
						<div class="col-md-6">
							<h6>Supporting Data</h6>
							<pre class="bg-light p-3 rounded">${JSON.stringify(rec.supporting_data, null, 2)}</pre>
						</div>
						<div class="col-md-6">
							<h6>Recommendation Details</h6>
							<ul class="list-unstyled">
								<li><strong>Type:</strong> ${rec.type}</li>
								<li><strong>Category:</strong> ${rec.category}</li>
								<li><strong>Confidence:</strong> ${Math.round(rec.confidence_score * 100)}%</li>
								<li><strong>Created:</strong> ${rec.created_at}</li>
								<li><strong>Applicable Graphs:</strong> ${rec.applicable_graphs.join(', ')}</li>
							</ul>
						</div>
					</div>
				`;
				
				const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
				modal.show();
			}
		}
		
		async function refreshRecommendations() {
			const graphName = document.getElementById('graphSelector').value;
			
			try {
				const response = await fetch('/recommendations/api/recommendations/refresh/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						graph_name: graphName
					})
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert(`Generated ${result.count} fresh recommendations!`);
					location.reload();
				} else {
					alert('Error: ' + result.error);
				}
			} catch (error) {
				console.error('Error refreshing recommendations:', error);
				alert('Error refreshing recommendations: ' + error.message);
			}
		}
	</script>
</body>
</html>