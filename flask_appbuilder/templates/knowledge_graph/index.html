<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Knowledge Graph Construction</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<style>
		.construction-card {
			transition: all 0.3s ease-in-out;
			border-left: 4px solid #6c757d;
			margin-bottom: 1rem;
		}
		
		.construction-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			border-left-color: #007bff;
		}
		
		.graph-card {
			background: linear-gradient(135deg, #f8f9fa, #e9ecef);
			border-radius: 1rem;
			padding: 2rem;
			margin-bottom: 1.5rem;
			transition: all 0.2s ease-in-out;
		}
		
		.graph-card:hover {
			transform: scale(1.02);
			box-shadow: 0 10px 30px rgba(0,0,0,0.1);
		}
		
		.stats-overview {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 1rem;
			padding: 2rem;
			margin-bottom: 2rem;
		}
		
		.stat-item {
			text-align: center;
			padding: 1.5rem;
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			border-radius: 0.5rem;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		
		.stat-number {
			font-size: 2.5rem;
			font-weight: bold;
			line-height: 1;
			margin-bottom: 0.5rem;
		}
		
		.stat-label {
			font-size: 0.875rem;
			opacity: 0.9;
		}
		
		.upload-zone {
			border: 3px dashed #dee2e6;
			border-radius: 1rem;
			padding: 3rem;
			text-align: center;
			background-color: #f8f9fa;
			transition: all 0.2s ease-in-out;
			margin-bottom: 2rem;
		}
		
		.upload-zone.dragover {
			border-color: #007bff;
			background-color: rgba(0, 123, 255, 0.1);
		}
		
		.upload-zone:hover {
			border-color: #007bff;
		}
		
		.process-button {
			background: linear-gradient(135deg, #28a745, #20c997);
			border: none;
			border-radius: 50px;
			padding: 0.75rem 2rem;
			color: white;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			transition: all 0.2s ease-in-out;
		}
		
		.process-button:hover {
			transform: scale(1.05);
			box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
		}
		
		.activity-item {
			padding: 1rem;
			border-left: 3px solid #007bff;
			margin-bottom: 0.5rem;
			background-color: #f8f9fa;
			border-radius: 0 0.5rem 0.5rem 0;
		}
		
		.activity-timestamp {
			font-size: 0.875rem;
			color: #6c757d;
		}
		
		.extraction-preview {
			background-color: #f8f9fa;
			border-radius: 0.5rem;
			padding: 1.5rem;
			margin: 1rem 0;
		}
		
		.entity-tag {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			margin: 0.125rem;
			border-radius: 1rem;
			font-size: 0.75rem;
			font-weight: 500;
		}
		
		.entity-person { background-color: #d4edda; color: #155724; }
		.entity-org { background-color: #d1ecf1; color: #0c5460; }
		.entity-location { background-color: #fff3cd; color: #856404; }
		.entity-concept { background-color: #f8d7da; color: #721c24; }
		
		.graph-selector {
			background-color: #fff;
			border: 2px solid #e9ecef;
			border-radius: 0.5rem;
			padding: 0.75rem;
			transition: border-color 0.2s ease-in-out;
		}
		
		.graph-selector:focus {
			border-color: #007bff;
			outline: none;
			box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
		}
		
		.progress-container {
			display: none;
			margin: 1rem 0;
		}
		
		.processing-status {
			padding: 1rem;
			border-radius: 0.5rem;
			margin: 1rem 0;
			display: none;
		}
		
		.status-processing { background-color: #d1ecf1; color: #0c5460; }
		.status-success { background-color: #d4edda; color: #155724; }
		.status-error { background-color: #f8d7da; color: #721c24; }
		
		.nlp-features {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 1rem;
			margin: 2rem 0;
		}
		
		.feature-item {
			text-align: center;
			padding: 1.5rem;
			background: linear-gradient(135deg, #f8f9fa, #e9ecef);
			border-radius: 0.5rem;
			transition: transform 0.2s ease-in-out;
		}
		
		.feature-item:hover {
			transform: translateY(-3px);
		}
		
		.feature-icon {
			font-size: 2.5rem;
			color: #007bff;
			margin-bottom: 1rem;
		}
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<h1 class="h2 mb-0">
							<i class="fas fa-brain text-info me-2"></i>
							{{ title }}
						</h1>
						<p class="text-muted mb-0">Automatically build knowledge graphs from text using advanced NLP</p>
					</div>
					<div class="btn-group">
						<a href="{{ url_for('KnowledgeGraphView.analyze_graph', graph_name='default') }}" class="btn btn-outline-info">
							<i class="fas fa-chart-network me-1"></i> Analyze Graphs
						</a>
						<button class="btn btn-info" onclick="showBatchProcessor()">
							<i class="fas fa-layer-group me-1"></i> Batch Process
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Statistics Overview -->
		<div class="stats-overview">
			<div class="row">
				<div class="col-md-8">
					<h3 class="mb-3">Knowledge Construction Overview</h3>
					<p class="mb-4">Transform unstructured text into structured knowledge graphs using state-of-the-art NLP and entity extraction</p>
					
					<div class="row">
						<div class="col-md-3">
							<div class="stat-item">
								<div class="stat-number">{{ construction_stats.total_documents_processed }}</div>
								<div class="stat-label">Documents Processed</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-item">
								<div class="stat-number">{{ construction_stats.total_entities_extracted }}</div>
								<div class="stat-label">Entities Extracted</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-item">
								<div class="stat-number">{{ construction_stats.total_relationships_extracted }}</div>
								<div class="stat-label">Relationships Found</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-item">
								<div class="stat-number">{{ construction_stats.graphs_built }}</div>
								<div class="stat-label">Graphs Built</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="text-center">
						<i class="fas fa-robot fa-4x mb-3" style="opacity: 0.7;"></i>
						<h5>AI-Powered Extraction</h5>
						<p class="mb-0">Advanced NLP algorithms automatically identify entities and relationships in your text</p>
						<div class="mt-3">
							<span class="badge bg-light text-dark me-2">spaCy NER</span>
							<span class="badge bg-light text-dark me-2">Pattern Matching</span>
							<span class="badge bg-light text-dark">Statistical Analysis</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- NLP Features -->
		<div class="nlp-features">
			<div class="feature-item">
				<div class="feature-icon">
					<i class="fas fa-user-tag"></i>
				</div>
				<h6>Entity Extraction</h6>
				<p class="small text-muted">Identify people, organizations, locations, and concepts</p>
			</div>
			<div class="feature-item">
				<div class="feature-icon">
					<i class="fas fa-project-diagram"></i>
				</div>
				<h6>Relationship Detection</h6>
				<p class="small text-muted">Discover connections and dependencies between entities</p>
			</div>
			<div class="feature-item">
				<div class="feature-icon">
					<i class="fas fa-language"></i>
				</div>
				<h6>Multi-Method NLP</h6>
				<p class="small text-muted">Combine statistical and rule-based approaches</p>
			</div>
			<div class="feature-item">
				<div class="feature-icon">
					<i class="fas fa-chart-line"></i>
				</div>
				<h6>Quality Scoring</h6>
				<p class="small text-muted">Confidence scores for all extracted knowledge</p>
			</div>
		</div>

		<div class="row">
			<!-- Document Processing -->
			<div class="col-md-8">
				<div class="card construction-card">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="fas fa-file-alt text-primary me-2"></i>
							Document Processing
						</h5>
					</div>
					<div class="card-body">
						<!-- Graph Selection -->
						<div class="row mb-3">
							<div class="col-md-6">
								<label for="targetGraph" class="form-label">
									<i class="fas fa-project-diagram me-1"></i>
									Target Knowledge Graph
								</label>
								<select id="targetGraph" class="form-select graph-selector">
									{% for graph in available_graphs %}
										<option value="{{ graph }}">{{ graph|title }}</option>
									{% endfor %}
								</select>
							</div>
							<div class="col-md-6">
								<label class="form-label">
									<i class="fas fa-file-import me-1"></i>
									Supported Formats
								</label>
								<div class="form-control-plaintext">
									{% for ext in supported_extensions %}
										<span class="badge bg-secondary me-1">{{ ext }}</span>
									{% endfor %}
								</div>
							</div>
						</div>

						<!-- File Upload Zone -->
						<div class="upload-zone" id="uploadZone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event);">
							<i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
							<h5>Drop files here or click to browse</h5>
							<p class="text-muted mb-3">Upload documents for automatic knowledge extraction</p>
							<input type="file" id="fileInput" class="d-none" multiple accept=".txt,.csv,.json,.xml,.html" onchange="handleFileSelect(event)">
							<button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
								<i class="fas fa-folder-open me-1"></i>
								Browse Files
							</button>
						</div>

						<!-- Text Input -->
						<div class="mb-3">
							<label for="textInput" class="form-label">
								<i class="fas fa-keyboard me-1"></i>
								Or paste text directly
							</label>
							<textarea id="textInput" class="form-control" rows="6" 
									  placeholder="Paste your text here for knowledge extraction..."></textarea>
						</div>

						<!-- Processing Controls -->
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<button class="process-button" onclick="processText()" id="processBtn">
									<i class="fas fa-cogs me-1"></i>
									Extract Knowledge
								</button>
								<button class="btn btn-outline-secondary ms-2" onclick="clearInput()">
									<i class="fas fa-trash me-1"></i>
									Clear
								</button>
							</div>
							<div>
								<button class="btn btn-outline-info" onclick="testEntityExtraction()">
									<i class="fas fa-vial me-1"></i>
									Test Extraction
								</button>
							</div>
						</div>

						<!-- Progress Bar -->
						<div class="progress-container" id="progressContainer">
							<div class="progress mb-2">
								<div class="progress-bar progress-bar-striped progress-bar-animated" 
									 id="progressBar" role="progressbar" style="width: 0%"></div>
							</div>
							<div class="text-center">
								<small class="text-muted" id="progressText">Processing...</small>
							</div>
						</div>

						<!-- Processing Status -->
						<div class="processing-status" id="processingStatus">
							<!-- Status messages will appear here -->
						</div>

						<!-- Extraction Preview -->
						<div class="extraction-preview" id="extractionPreview" style="display: none;">
							<h6>
								<i class="fas fa-eye me-2"></i>
								Extraction Preview
							</h6>
							<div id="previewContent">
								<!-- Preview content will be loaded here -->
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Available Graphs & Recent Activity -->
			<div class="col-md-4">
				<!-- Available Graphs -->
				<div class="card construction-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-project-diagram text-success me-2"></i>
							Available Knowledge Graphs
						</h6>
					</div>
					<div class="card-body">
						{% for graph in available_graphs %}
							<div class="graph-card">
								<div class="d-flex justify-content-between align-items-center">
									<div>
										<h6 class="mb-1">{{ graph|title }}</h6>
										<small class="text-muted">Active Graph</small>
									</div>
									<div class="btn-group-vertical btn-group-sm">
										<a href="{{ url_for('KnowledgeGraphView.build_interface', graph_name=graph) }}" 
										   class="btn btn-outline-primary">
											<i class="fas fa-hammer"></i> Build
										</a>
										<a href="{{ url_for('KnowledgeGraphView.analyze_graph', graph_name=graph) }}" 
										   class="btn btn-outline-info">
											<i class="fas fa-chart-line"></i> Analyze
										</a>
									</div>
								</div>
							</div>
						{% endfor %}
						
						<div class="text-center mt-3">
							<button class="btn btn-success btn-sm" onclick="createNewGraph()">
								<i class="fas fa-plus me-1"></i>
								Create New Graph
							</button>
						</div>
					</div>
				</div>

				<!-- Recent Activity -->
				<div class="card construction-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-history text-warning me-2"></i>
							Recent Activity
						</h6>
					</div>
					<div class="card-body" style="max-height: 400px; overflow-y: auto;">
						{% for activity in recent_activities %}
							<div class="activity-item">
								<div class="d-flex justify-content-between align-items-start">
									<div class="flex-grow-1">
										<strong>{{ activity.action }}</strong>
										<div class="small text-muted">{{ activity.graph }}</div>
										<div class="small">{{ activity.details }}</div>
									</div>
									<div class="activity-timestamp">
										{{ activity.timestamp[:16] }}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Batch Processing Modal -->
	<div class="modal fade" id="batchModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-layer-group text-info me-2"></i>
						Batch Document Processing
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="batchGraph" class="form-label">Target Graph</label>
						<select id="batchGraph" class="form-select">
							{% for graph in available_graphs %}
								<option value="{{ graph }}">{{ graph|title }}</option>
							{% endfor %}
						</select>
					</div>
					
					<div class="mb-3">
						<label for="batchFiles" class="form-label">Select Multiple Files</label>
						<input type="file" id="batchFiles" class="form-control" multiple 
							   accept=".txt,.csv,.json,.xml,.html">
					</div>
					
					<div class="mb-3">
						<label for="maxWorkers" class="form-label">
							Max Parallel Workers (1-8)
						</label>
						<input type="number" id="maxWorkers" class="form-control" 
							   min="1" max="8" value="4">
					</div>
					
					<div id="batchProgress" style="display: none;">
						<div class="progress mb-2">
							<div class="progress-bar" id="batchProgressBar" style="width: 0%"></div>
						</div>
						<div id="batchStatus" class="text-center small text-muted"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-info" onclick="processBatch()">
						<i class="fas fa-rocket me-1"></i>
						Start Batch Processing
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Entity Test Modal -->
	<div class="modal fade" id="entityTestModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-vial text-success me-2"></i>
						Entity Extraction Test
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="testText" class="form-label">Test Text</label>
						<textarea id="testText" class="form-control" rows="4" 
								  placeholder="Enter text to test entity extraction...">John Smith works at Microsoft in Seattle. He graduated from MIT in 2010 and specializes in artificial intelligence.</textarea>
					</div>
					
					<button class="btn btn-primary" onclick="runEntityTest()">
						<i class="fas fa-play me-1"></i>
						Run Extraction
					</button>
					
					<div id="testResults" class="mt-3" style="display: none;">
						<h6>Extracted Entities:</h6>
						<div id="testEntities"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		// Global variables
		let selectedFiles = [];
		let isProcessing = false;
		
		// File handling
		function dropHandler(ev) {
			ev.preventDefault();
			
			const uploadZone = document.getElementById('uploadZone');
			uploadZone.classList.remove('dragover');
			
			const files = Array.from(ev.dataTransfer.files);
			handleFiles(files);
		}
		
		function dragOverHandler(ev) {
			ev.preventDefault();
			document.getElementById('uploadZone').classList.add('dragover');
		}
		
		function dragLeaveHandler(ev) {
			ev.preventDefault();
			document.getElementById('uploadZone').classList.remove('dragover');
		}
		
		function handleFileSelect(event) {
			const files = Array.from(event.target.files);
			handleFiles(files);
		}
		
		function handleFiles(files) {
			selectedFiles = files;
			
			if (files.length > 0) {
				const fileNames = files.map(f => f.name).join(', ');
				const uploadZone = document.getElementById('uploadZone');
				uploadZone.innerHTML = `
					<i class="fas fa-files fa-2x text-success mb-2"></i>
					<h6>Selected Files (${files.length})</h6>
					<p class="text-muted small">${fileNames}</p>
					<button class="btn btn-outline-secondary btn-sm" onclick="clearFiles()">
						<i class="fas fa-times me-1"></i>
						Clear Selection
					</button>
				`;
			}
		}
		
		function clearFiles() {
			selectedFiles = [];
			document.getElementById('fileInput').value = '';
			resetUploadZone();
		}
		
		function resetUploadZone() {
			const uploadZone = document.getElementById('uploadZone');
			uploadZone.innerHTML = `
				<i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
				<h5>Drop files here or click to browse</h5>
				<p class="text-muted mb-3">Upload documents for automatic knowledge extraction</p>
				<button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
					<i class="fas fa-folder-open me-1"></i>
					Browse Files
				</button>
			`;
		}
		
		// Text processing
		async function processText() {
			if (isProcessing) return;
			
			const textInput = document.getElementById('textInput').value.trim();
			const graphName = document.getElementById('targetGraph').value;
			
			if (!textInput && selectedFiles.length === 0) {
				alert('Please provide text or select files to process');
				return;
			}
			
			isProcessing = true;
			showProcessingStatus('Processing document...', 'processing');
			updateProgress(10);
			
			try {
				let result;
				
				if (selectedFiles.length > 0) {
					// Process files
					result = await processFiles();
				} else {
					// Process text
					result = await processTextContent(textInput, graphName);
				}
				
				updateProgress(100);
				showProcessingStatus(`Success! Extracted ${result.entity_count || 0} entities and ${result.relationship_count || 0} relationships`, 'success');
				showExtractionPreview(result);
				
			} catch (error) {
				console.error('Processing failed:', error);
				showProcessingStatus(`Error: ${error.message}`, 'error');
			} finally {
				isProcessing = false;
				setTimeout(() => {
					document.getElementById('progressContainer').style.display = 'none';
					updateProgress(0);
				}, 3000);
			}
		}
		
		async function processTextContent(text, graphName) {
			const response = await fetch('/knowledge-graph/api/process-document/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					graph_name: graphName,
					content: text,
					metadata: {
						title: 'Direct Text Input',
						source: 'user_input',
						type: 'text'
					}
				})
			});
			
			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			
			const result = await response.json();
			
			if (!result.success) {
				throw new Error(result.error);
			}
			
			return result.document_metadata;
		}
		
		async function processFiles() {
			if (selectedFiles.length === 0) return;
			
			const graphName = document.getElementById('targetGraph').value;
			let totalEntities = 0;
			let totalRelationships = 0;
			
			for (let i = 0; i < selectedFiles.length; i++) {
				const file = selectedFiles[i];
				updateProgress(20 + (i / selectedFiles.length) * 60);
				showProcessingStatus(`Processing file ${i + 1} of ${selectedFiles.length}: ${file.name}`, 'processing');
				
				const formData = new FormData();
				formData.append('file', file);
				formData.append('graph_name', graphName);
				
				const response = await fetch('/knowledge-graph/api/upload-file/', {
					method: 'POST',
					body: formData
				});
				
				if (!response.ok) {
					throw new Error(`Failed to process file: ${file.name}`);
				}
				
				const result = await response.json();
				
				if (!result.success) {
					throw new Error(result.error);
				}
				
				totalEntities += result.document_metadata.entity_count;
				totalRelationships += result.document_metadata.relationship_count;
			}
			
			return {
				entity_count: totalEntities,
				relationship_count: totalRelationships,
				files_processed: selectedFiles.length
			};
		}
		
		function showProcessingStatus(message, type) {
			const statusDiv = document.getElementById('processingStatus');
			statusDiv.className = `processing-status status-${type}`;
			statusDiv.innerHTML = `
				<i class="fas fa-${type === 'processing' ? 'spinner fa-spin' : (type === 'success' ? 'check-circle' : 'exclamation-triangle')} me-2"></i>
				${message}
			`;
			statusDiv.style.display = 'block';
			
			document.getElementById('progressContainer').style.display = 'block';
		}
		
		function updateProgress(percent) {
			const progressBar = document.getElementById('progressBar');
			progressBar.style.width = `${percent}%`;
			progressBar.setAttribute('aria-valuenow', percent);
			
			const progressText = document.getElementById('progressText');
			progressText.textContent = `${percent}% Complete`;
		}
		
		function showExtractionPreview(result) {
			// This would show a preview of extracted entities and relationships
			const previewDiv = document.getElementById('extractionPreview');
			const contentDiv = document.getElementById('previewContent');
			
			contentDiv.innerHTML = `
				<div class="row">
					<div class="col-md-6">
						<h6><i class="fas fa-user-tag me-1"></i> Entities: ${result.entity_count || 0}</h6>
						<div class="small text-muted">Automatically identified concepts, people, and organizations</div>
					</div>
					<div class="col-md-6">
						<h6><i class="fas fa-project-diagram me-1"></i> Relationships: ${result.relationship_count || 0}</h6>
						<div class="small text-muted">Discovered connections between entities</div>
					</div>
				</div>
			`;
			
			previewDiv.style.display = 'block';
		}
		
		function clearInput() {
			document.getElementById('textInput').value = '';
			document.getElementById('processingStatus').style.display = 'none';
			document.getElementById('extractionPreview').style.display = 'none';
			document.getElementById('progressContainer').style.display = 'none';
			clearFiles();
		}
		
		// Batch processing
		function showBatchProcessor() {
			const modal = new bootstrap.Modal(document.getElementById('batchModal'));
			modal.show();
		}
		
		async function processBatch() {
			const batchFiles = document.getElementById('batchFiles').files;
			const graphName = document.getElementById('batchGraph').value;
			const maxWorkers = parseInt(document.getElementById('maxWorkers').value);
			
			if (batchFiles.length === 0) {
				alert('Please select files for batch processing');
				return;
			}
			
			// Show progress
			document.getElementById('batchProgress').style.display = 'block';
			document.getElementById('batchStatus').textContent = 'Preparing documents...';
			
			try {
				// Prepare documents array
				const documents = [];
				for (let file of batchFiles) {
					const content = await readFileAsText(file);
					documents.push({
						content: content,
						metadata: {
							title: file.name,
							source: 'batch_upload',
							type: file.name.split('.').pop(),
							size: file.size
						}
					});
				}
				
				// Submit batch
				const response = await fetch('/knowledge-graph/api/process-batch/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						graph_name: graphName,
						documents: documents,
						max_workers: maxWorkers
					})
				});
				
				const result = await response.json();
				
				if (result.success) {
					document.getElementById('batchStatus').textContent = 
						`Success! Processed ${result.summary.documents_processed} documents, ` +
						`extracted ${result.summary.total_entities} entities and ${result.summary.total_relationships} relationships`;
					
					// Update progress bar to 100%
					document.getElementById('batchProgressBar').style.width = '100%';
				} else {
					throw new Error(result.error);
				}
				
			} catch (error) {
				console.error('Batch processing failed:', error);
				document.getElementById('batchStatus').textContent = `Error: ${error.message}`;
			}
		}
		
		function readFileAsText(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = e => resolve(e.target.result);
				reader.onerror = reject;
				reader.readAsText(file);
			});
		}
		
		// Entity extraction test
		function testEntityExtraction() {
			const modal = new bootstrap.Modal(document.getElementById('entityTestModal'));
			modal.show();
		}
		
		async function runEntityTest() {
			const text = document.getElementById('testText').value.trim();
			
			if (!text) {
				alert('Please enter text to test');
				return;
			}
			
			try {
				const response = await fetch('/knowledge-graph/api/extract-entities/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ text: text })
				});
				
				const result = await response.json();
				
				if (result.success) {
					displayTestResults(result.entities);
				} else {
					throw new Error(result.error);
				}
				
			} catch (error) {
				console.error('Entity extraction test failed:', error);
				alert(`Error: ${error.message}`);
			}
		}
		
		function displayTestResults(entities) {
			const resultsDiv = document.getElementById('testResults');
			const entitiesDiv = document.getElementById('testEntities');
			
			if (entities.length === 0) {
				entitiesDiv.innerHTML = '<p class="text-muted">No entities extracted</p>';
			} else {
				const entitiesHtml = entities.map(entity => {
					const labelClass = entity.label.toLowerCase().includes('person') ? 'entity-person' :
									  entity.label.toLowerCase().includes('org') ? 'entity-org' :
									  entity.label.toLowerCase().includes('gpe') ? 'entity-location' :
									  'entity-concept';
					
					return `<span class="entity-tag ${labelClass}" title="Confidence: ${(entity.confidence * 100).toFixed(1)}%">
						${entity.text} (${entity.label})
					</span>`;
				}).join(' ');
				
				entitiesDiv.innerHTML = entitiesHtml;
			}
			
			resultsDiv.style.display = 'block';
		}
		
		function createNewGraph() {
			const graphName = prompt('Enter new knowledge graph name:');
			if (graphName && graphName.trim()) {
				window.location.href = `/knowledge-graph/build/${graphName.trim()}/`;
			}
		}
	</script>
</body>
</html>