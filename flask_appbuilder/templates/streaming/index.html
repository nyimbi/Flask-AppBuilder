{% extends "appbuilder/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_css %}
{{ super() }}
<style>
/* Real-Time Streaming Dashboard Styles */
.streaming-dashboard {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
    background: #f8fafc;
    min-height: 100vh;
}

.dashboard-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(50%, -50%);
}

.header-content {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dashboard-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.dashboard-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.btn-header {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-header:hover {
    background: rgba(255, 255, 255, 0.3);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

/* Statistics Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.stat-card.real-time {
    border-left: 4px solid #10b981;
}

.stat-card.sessions {
    border-left: 4px solid #3b82f6;
}

.stat-card.events {
    border-left: 4px solid #f59e0b;
}

.stat-card.filtered {
    border-left: 4px solid #ef4444;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.4rem;
    margin-bottom: 15px;
}

.stat-icon.real-time { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.sessions { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.stat-icon.events { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stat-icon.filtered { background: linear-gradient(135deg, #ef4444, #dc2626); }

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 5px 0;
}

.stat-label {
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
    margin: 0;
}

.stat-status {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.active { background: #10b981; }
.status-indicator.warning { background: #f59e0b; }
.status-indicator.error { background: #ef4444; }

/* Main Content Grid */
.main-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.card-header {
    background: #f8fafc;
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-actions {
    display: flex;
    gap: 8px;
}

.btn-card-action {
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-card-action:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.btn-card-action.primary {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.btn-card-action.primary:hover {
    background: #2563eb;
}

.card-content {
    padding: 25px;
}

/* Activity Monitor */
.activity-monitor {
    height: 400px;
    display: flex;
    flex-direction: column;
}

.monitor-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.monitor-filter {
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
}

.activity-list {
    flex: 1;
    overflow-y: auto;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
}

.activity-item {
    display: flex;
    align-items: start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid #f1f5f9;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.activity-icon.node-created { background: #10b981; }
.activity-icon.node-updated { background: #3b82f6; }
.activity-icon.node-deleted { background: #ef4444; }
.activity-icon.edge-created { background: #8b5cf6; }
.activity-icon.edge-updated { background: #06b6d4; }
.activity-icon.edge-deleted { background: #f59e0b; }

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-title {
    font-weight: 500;
    color: #1e293b;
    margin: 0 0 4px 0;
    font-size: 0.9rem;
}

.activity-description {
    color: #64748b;
    font-size: 0.8rem;
    margin: 0 0 4px 0;
}

.activity-time {
    color: #9ca3af;
    font-size: 0.75rem;
    margin: 0;
}

.activity-empty {
    text-align: center;
    color: #6b7280;
    padding: 40px 20px;
    font-style: italic;
}

/* Session Management */
.sessions-panel {
    max-height: 500px;
    overflow-y: auto;
}

.session-item {
    padding: 15px;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.session-item:last-child {
    border-bottom: none;
}

.session-item:hover {
    background: #f8fafc;
}

.session-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.session-id {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    color: #374151;
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 4px;
}

.session-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    font-weight: 500;
}

.session-status.active { color: #10b981; }
.session-status.inactive { color: #6b7280; }

.session-details {
    font-size: 0.85rem;
    color: #64748b;
    line-height: 1.4;
}

.session-stats {
    display: flex;
    gap: 15px;
    margin-top: 8px;
    font-size: 0.8rem;
    color: #9ca3af;
}

.session-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Controls Panel */
.controls-panel {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.controls-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 15px 0;
}

.controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.control-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #374151;
}

.control-input {
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.85rem;
}

.control-actions {
    display: flex;
    gap: 10px;
}

.btn-control {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.btn-control.primary {
    background: #10b981;
    color: white;
}

.btn-control.primary:hover {
    background: #059669;
}

.btn-control.secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-control.secondary:hover {
    background: #e5e7eb;
}

.btn-control.danger {
    background: #ef4444;
    color: white;
}

.btn-control.danger:hover {
    background: #dc2626;
}

/* Real-time Indicator */
.realtime-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 1000;
    transition: all 0.3s ease;
}

.realtime-indicator.connected {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5, #ffffff);
}

.realtime-indicator.disconnected {
    border-color: #ef4444;
    background: linear-gradient(135deg, #fef2f2, #ffffff);
}

.realtime-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.realtime-dot.connected { background: #10b981; }
.realtime-dot.disconnected { background: #ef4444; }

.realtime-text {
    font-size: 0.85rem;
    font-weight: 500;
}

.realtime-text.connected { color: #065f46; }
.realtime-text.disconnected { color: #991b1b; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    .streaming-dashboard {
        padding: 15px;
    }
    
    .dashboard-header {
        padding: 20px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .dashboard-title {
        font-size: 1.8rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .controls-grid {
        grid-template-columns: 1fr;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
}
</style>
{% endblock %}

{% block content %}
<div class="streaming-dashboard">
    <!-- Real-time Status Indicator -->
    <div class="realtime-indicator connected" id="realtime-indicator">
        <div class="realtime-dot connected" id="realtime-dot"></div>
        <div class="realtime-text connected" id="realtime-text">Real-time Connected</div>
    </div>
    
    <!-- Header -->
    <div class="dashboard-header fade-in">
        <div class="header-content">
            <div>
                <h1 class="dashboard-title">
                    <i class="fa fa-broadcast-tower"></i>
                    Real-Time Graph Streaming
                </h1>
                <p class="dashboard-subtitle">
                    Live monitoring and streaming of graph changes with WebSocket support
                </p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('GraphStreamingView.monitor') }}" class="btn-header">
                    <i class="fa fa-tv"></i> Live Monitor
                </a>
                <a href="{{ url_for('GraphStreamingView.sessions') }}" class="btn-header">
                    <i class="fa fa-users"></i> Sessions
                </a>
            </div>
        </div>
    </div>
    
    <!-- Statistics Grid -->
    <div class="stats-grid fade-in">
        <div class="stat-card real-time">
            <div class="stat-icon real-time">
                <i class="fa fa-wifi"></i>
            </div>
            <div class="stat-number" id="active-sessions">{{ statistics.active_sessions | default(0) }}</div>
            <div class="stat-label">Active Streaming Sessions</div>
            <div class="stat-status">
                <div class="status-indicator active"></div>
                <span>Real-time monitoring active</span>
            </div>
        </div>
        
        <div class="stat-card sessions">
            <div class="stat-icon sessions">
                <i class="fa fa-users"></i>
            </div>
            <div class="stat-number" id="total-sessions">{{ statistics.total_sessions | default(0) }}</div>
            <div class="stat-label">Total Sessions</div>
            <div class="stat-status">
                <div class="status-indicator active"></div>
                <span>Session management enabled</span>
            </div>
        </div>
        
        <div class="stat-card events">
            <div class="stat-icon events">
                <i class="fa fa-bolt"></i>
            </div>
            <div class="stat-number" id="events-sent">{{ statistics.total_events_sent | default(0) }}</div>
            <div class="stat-label">Events Streamed</div>
            <div class="stat-status">
                <div class="status-indicator active"></div>
                <span>Event processing active</span>
            </div>
        </div>
        
        <div class="stat-card filtered">
            <div class="stat-icon filtered">
                <i class="fa fa-filter"></i>
            </div>
            <div class="stat-number" id="events-filtered">{{ statistics.total_events_filtered | default(0) }}</div>
            <div class="stat-label">Events Filtered</div>
            <div class="stat-status">
                <div class="status-indicator warning"></div>
                <span>Filtering applied</span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Activity Monitor -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fa fa-activity"></i>
                    Live Activity Monitor
                </h2>
                <div class="card-actions">
                    <button class="btn-card-action" onclick="clearActivityLog()">
                        <i class="fa fa-trash"></i> Clear
                    </button>
                    <button class="btn-card-action primary" onclick="simulateActivity()">
                        <i class="fa fa-play"></i> Simulate
                    </button>
                </div>
            </div>
            <div class="card-content">
                <div class="activity-monitor">
                    <div class="monitor-controls">
                        <select class="monitor-filter" id="change-type-filter" onchange="filterActivity()">
                            <option value="">All Change Types</option>
                            <option value="node_created">Node Created</option>
                            <option value="node_updated">Node Updated</option>
                            <option value="node_deleted">Node Deleted</option>
                            <option value="edge_created">Edge Created</option>
                            <option value="edge_updated">Edge Updated</option>
                            <option value="edge_deleted">Edge Deleted</option>
                        </select>
                        
                        <select class="monitor-filter" id="graph-filter" onchange="filterActivity()">
                            <option value="">All Graphs</option>
                            <option value="default_graph">Default Graph</option>
                        </select>
                        
                        <button class="btn-card-action" onclick="pauseMonitoring()" id="pause-btn">
                            <i class="fa fa-pause"></i> Pause
                        </button>
                    </div>
                    
                    <div class="activity-list" id="activity-list">
                        <div class="activity-empty">
                            No recent activity. Click "Simulate" to generate test events.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls & Sessions -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fa fa-cog"></i>
                    Stream Controls
                </h2>
                <div class="card-actions">
                    <button class="btn-card-action" onclick="refreshSessions()">
                        <i class="fa fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-content">
                <!-- Controls Panel -->
                <div class="controls-panel">
                    <h3 class="controls-title">Quick Actions</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label class="control-label">Graph Name</label>
                            <select class="control-input" id="control-graph-name">
                                <option value="default_graph">Default Graph</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Message Type</label>
                            <select class="control-input" id="control-message-type">
                                <option value="announcement">Announcement</option>
                                <option value="alert">Alert</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="control-actions">
                        <button class="btn-control primary" onclick="broadcastMessage()">
                            <i class="fa fa-bullhorn"></i> Broadcast Message
                        </button>
                        <button class="btn-control secondary" onclick="cleanupSessions()">
                            <i class="fa fa-broom"></i> Cleanup Sessions
                        </button>
                        <button class="btn-control danger" onclick="simulateActivity()">
                            <i class="fa fa-bolt"></i> Simulate Activity
                        </button>
                    </div>
                </div>
                
                <!-- Active Sessions -->
                <div class="sessions-panel">
                    <h3 class="controls-title">Active Sessions</h3>
                    <div id="sessions-list">
                        {% if statistics.session_details %}
                            {% for session in statistics.session_details %}
                            <div class="session-item slide-in">
                                <div class="session-header">
                                    <div class="session-id">{{ session.session_id[:8] }}...</div>
                                    <div class="session-status {{ 'active' if session.is_active else 'inactive' }}">
                                        <div class="status-indicator {{ 'active' if session.is_active else 'inactive' }}"></div>
                                        {{ 'Active' if session.is_active else 'Inactive' }}
                                    </div>
                                </div>
                                <div class="session-details">
                                    User: {{ session.user_id }} | Graph: {{ session.graph_name }} | Mode: {{ session.mode }}
                                </div>
                                <div class="session-stats">
                                    <div class="session-stat">
                                        <i class="fa fa-paper-plane"></i>
                                        {{ session.statistics.events_sent }} sent
                                    </div>
                                    <div class="session-stat">
                                        <i class="fa fa-filter"></i>
                                        {{ session.statistics.events_filtered }} filtered
                                    </div>
                                    <div class="session-stat">
                                        <i class="fa fa-clock"></i>
                                        {{ session.last_activity }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="activity-empty">
                                No active streaming sessions
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
// Real-time Streaming Dashboard JavaScript
class StreamingDashboard {
    constructor() {
        this.activities = [];
        this.isMonitoring = true;
        this.isPaused = false;
        this.websocket = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        
        this.initializeWebSocket();
        this.startPeriodicUpdates();
    }
    
    initializeWebSocket() {
        // In production, this would establish actual WebSocket connection
        // For demonstration, we'll simulate WebSocket events
        console.log('WebSocket connection would be established here');
        this.simulateWebSocketConnection();
    }
    
    simulateWebSocketConnection() {
        // Simulate connection status
        this.updateConnectionStatus(true);
        
        // Simulate periodic events
        setInterval(() => {
            if (this.isMonitoring && !this.isPaused) {
                this.simulateRandomActivity();
            }
        }, 10000); // Every 10 seconds
    }
    
    simulateRandomActivity() {
        const changeTypes = ['node_created', 'node_updated', 'edge_created', 'edge_updated'];
        const changeType = changeTypes[Math.floor(Math.random() * changeTypes.length)];
        
        const activity = {
            id: `activity_${Date.now()}`,
            timestamp: new Date(),
            change_type: changeType,
            graph_name: 'default_graph',
            element_id: `element_${Math.floor(Math.random() * 1000)}`,
            element_type: changeType.includes('node') ? 'node' : 'edge',
            description: `${changeType.replace('_', ' ')} event simulated`,
            metadata: { simulated: true }
        };
        
        this.addActivity(activity);
    }
    
    addActivity(activity) {
        this.activities.unshift(activity);
        
        // Keep only last 50 activities
        if (this.activities.length > 50) {
            this.activities = this.activities.slice(0, 50);
        }
        
        this.renderActivity();
        this.updateStatistics();
    }
    
    renderActivity() {
        const activityList = document.getElementById('activity-list');
        const filteredActivities = this.getFilteredActivities();
        
        if (filteredActivities.length === 0) {
            activityList.innerHTML = '<div class="activity-empty">No activities match the current filters</div>';
            return;
        }
        
        const html = filteredActivities.map(activity => `
            <div class="activity-item fade-in">
                <div class="activity-icon ${activity.change_type}">
                    <i class="fa fa-${this.getActivityIcon(activity.change_type)}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.description}</div>
                    <div class="activity-description">
                        ${activity.element_type} ${activity.element_id} in ${activity.graph_name}
                    </div>
                    <div class="activity-time">${this.formatTime(activity.timestamp)}</div>
                </div>
            </div>
        `).join('');
        
        activityList.innerHTML = html;
    }
    
    getFilteredActivities() {
        const changeTypeFilter = document.getElementById('change-type-filter').value;
        const graphFilter = document.getElementById('graph-filter').value;
        
        return this.activities.filter(activity => {
            if (changeTypeFilter && activity.change_type !== changeTypeFilter) return false;
            if (graphFilter && activity.graph_name !== graphFilter) return false;
            return true;
        });
    }
    
    getActivityIcon(changeType) {
        const icons = {
            'node_created': 'plus-circle',
            'node_updated': 'edit',
            'node_deleted': 'trash',
            'edge_created': 'link',
            'edge_updated': 'exchange',
            'edge_deleted': 'unlink'
        };
        return icons[changeType] || 'circle';
    }
    
    formatTime(timestamp) {
        const now = new Date();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return timestamp.toLocaleDateString();
    }
    
    updateConnectionStatus(connected) {
        const indicator = document.getElementById('realtime-indicator');
        const dot = document.getElementById('realtime-dot');
        const text = document.getElementById('realtime-text');
        
        if (connected) {
            indicator.className = 'realtime-indicator connected';
            dot.className = 'realtime-dot connected';
            text.className = 'realtime-text connected';
            text.textContent = 'Real-time Connected';
        } else {
            indicator.className = 'realtime-indicator disconnected';
            dot.className = 'realtime-dot disconnected';
            text.className = 'realtime-text disconnected';
            text.textContent = 'Disconnected';
        }
    }
    
    updateStatistics() {
        // Update statistics from activities
        const eventsSent = this.activities.length;
        const eventsFiltered = Math.floor(eventsSent * 0.2); // Simulate 20% filtering
        
        document.getElementById('events-sent').textContent = eventsSent;
        document.getElementById('events-filtered').textContent = eventsFiltered;
    }
    
    startPeriodicUpdates() {
        // Refresh statistics periodically
        setInterval(() => {
            this.refreshStatistics();
        }, 30000); // Every 30 seconds
    }
    
    refreshStatistics() {
        fetch('/graph/streaming/api/statistics/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('active-sessions').textContent = stats.active_sessions || 0;
                    document.getElementById('total-sessions').textContent = stats.total_sessions || 0;
                    document.getElementById('events-sent').textContent = stats.total_events_sent || 0;
                    document.getElementById('events-filtered').textContent = stats.total_events_filtered || 0;
                }
            })
            .catch(error => console.error('Failed to refresh statistics:', error));
    }
}

// Global dashboard instance
let dashboard;

document.addEventListener('DOMContentLoaded', function() {
    dashboard = new StreamingDashboard();
});

// Global functions
function filterActivity() {
    dashboard.renderActivity();
}

function clearActivityLog() {
    dashboard.activities = [];
    dashboard.renderActivity();
    showNotification('Activity log cleared', 'success');
}

function pauseMonitoring() {
    const pauseBtn = document.getElementById('pause-btn');
    
    if (dashboard.isPaused) {
        dashboard.isPaused = false;
        pauseBtn.innerHTML = '<i class="fa fa-pause"></i> Pause';
        pauseBtn.classList.remove('primary');
        showNotification('Monitoring resumed', 'success');
    } else {
        dashboard.isPaused = true;
        pauseBtn.innerHTML = '<i class="fa fa-play"></i> Resume';
        pauseBtn.classList.add('primary');
        showNotification('Monitoring paused', 'warning');
    }
}

function simulateActivity() {
    showLoading();
    
    fetch('/graph/streaming/api/simulate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            graph_name: document.getElementById('control-graph-name').value
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification('Graph activity simulated successfully', 'success');
            // Add some simulated activities to the UI
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    dashboard.simulateRandomActivity();
                }, i * 1000);
            }
        } else {
            showNotification(`Simulation failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Simulation error:', error);
        showNotification('Simulation failed', 'error');
    });
}

function broadcastMessage() {
    const graphName = document.getElementById('control-graph-name').value;
    const messageType = document.getElementById('control-message-type').value;
    
    const message = {
        type: messageType,
        content: `Test ${messageType} message from dashboard`,
        timestamp: new Date().toISOString()
    };
    
    showLoading();
    
    fetch('/graph/streaming/api/broadcast/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            graph_name: graphName,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification(`Message broadcast to ${data.recipients} sessions`, 'success');
        } else {
            showNotification(`Broadcast failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Broadcast error:', error);
        showNotification('Broadcast failed', 'error');
    });
}

function cleanupSessions() {
    if (!confirm('This will remove inactive streaming sessions. Continue?')) {
        return;
    }
    
    showLoading();
    
    fetch('/graph/streaming/api/cleanup/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification(`Cleaned up ${data.sessions_cleaned} inactive sessions`, 'success');
            refreshSessions();
        } else {
            showNotification(`Cleanup failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Cleanup error:', error);
        showNotification('Cleanup failed', 'error');
    });
}

function refreshSessions() {
    // Refresh the sessions list
    window.location.reload();
}

// Utility functions
function showLoading() {
    // Add loading spinner to body
    if (!document.querySelector('.loading-overlay-streaming')) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay-streaming';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        overlay.innerHTML = `
            <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; 
                           border-top: 3px solid #10b981; border-radius: 50%; 
                           animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
                <div style="color: #374151; font-size: 0.9rem;">Processing...</div>
            </div>
        `;
        document.body.appendChild(overlay);
    }
}

function hideLoading() {
    const overlay = document.querySelector('.loading-overlay-streaming');
    if (overlay) {
        overlay.remove();
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-left: 4px solid ${type === 'success' ? '#10b981' : 
                                   type === 'error' ? '#ef4444' : 
                                   type === 'warning' ? '#f59e0b' : '#3b82f6'};
        border-radius: 6px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fa fa-${type === 'error' ? 'exclamation-circle' : 
                              type === 'success' ? 'check-circle' : 
                              type === 'warning' ? 'exclamation-triangle' :
                              'info-circle'}" 
               style="color: ${type === 'success' ? '#10b981' : 
                               type === 'error' ? '#ef4444' : 
                               type === 'warning' ? '#f59e0b' : '#3b82f6'};"></i>
            <span style="color: #374151; font-weight: 500;">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Add required CSS animations
const streamingAnimations = document.createElement('style');
streamingAnimations.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(streamingAnimations);
</script>
{% endblock %}