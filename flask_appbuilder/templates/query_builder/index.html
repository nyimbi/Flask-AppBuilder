{% extends "appbuilder/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_css %}
{{ super() }}
<style>
/* Visual Query Builder Styles */
.query-builder-container {
    display: flex;
    height: 100vh;
    background: #f8fafc;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Left Sidebar - Component Palette */
.component-palette {
    width: 280px;
    background: white;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.palette-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}

.palette-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 10px 0;
}

.palette-search {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9rem;
}

.palette-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.component-category {
    margin-bottom: 25px;
}

.category-title {
    font-weight: 600;
    color: #374151;
    margin: 0 0 12px 0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.component-item {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
}

.component-item:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
}

.component-item.dragging {
    opacity: 0.6;
    cursor: grabbing;
    transform: rotate(5deg);
}

.component-icon {
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    margin-right: 8px;
    vertical-align: middle;
}

.component-name {
    font-weight: 500;
    color: #1f2937;
    font-size: 0.9rem;
}

.component-description {
    font-size: 0.8rem;
    color: #6b7280;
    margin: 4px 0 0 28px;
}

/* Main Canvas Area */
.canvas-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.canvas-toolbar {
    background: white;
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toolbar-separator {
    width: 1px;
    height: 24px;
    background: #e5e7eb;
}

.btn-toolbar {
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-toolbar:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.btn-toolbar.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.btn-primary {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.btn-success {
    background: #10b981;
    border-color: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
    border-color: #059669;
}

.query-canvas {
    flex: 1;
    background: radial-gradient(circle at 20px 20px, #e5e7eb 1px, transparent 1px);
    background-size: 20px 20px;
    position: relative;
    overflow: auto;
    cursor: grab;
}

.query-canvas.panning {
    cursor: grabbing;
}

/* Query Components */
.query-component {
    position: absolute;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    min-width: 180px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: move;
    transition: all 0.2s ease;
    z-index: 10;
}

.query-component:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.query-component.selected {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.query-component.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}

.component-header {
    padding: 12px 15px;
    border-bottom: 1px solid #f3f4f6;
    background: #f9fafb;
    border-radius: 10px 10px 0 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.component-type-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    font-weight: 600;
}

.component-type-icon.match { background: #3b82f6; }
.component-type-icon.where { background: #f59e0b; }
.component-type-icon.return { background: #10b981; }
.component-type-icon.create { background: #8b5cf6; }
.component-type-icon.set { background: #ef4444; }
.component-type-icon.delete { background: #dc2626; }

.component-title {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.9rem;
}

.component-actions {
    margin-left: auto;
    display: flex;
    gap: 4px;
}

.btn-component-action {
    width: 20px;
    height: 20px;
    border: none;
    background: transparent;
    color: #6b7280;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
}

.btn-component-action:hover {
    background: #f3f4f6;
    color: #374151;
}

.component-content {
    padding: 15px;
}

.component-field {
    margin-bottom: 12px;
}

.component-field:last-child {
    margin-bottom: 0;
}

.field-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
}

.field-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.85rem;
}

.field-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

/* Connection Lines */
.connection-line {
    position: absolute;
    z-index: 5;
    pointer-events: none;
}

.connection-path {
    stroke: #6b7280;
    stroke-width: 2;
    fill: none;
    marker-end: url(#arrowhead);
}

.connection-path.active {
    stroke: #3b82f6;
    stroke-width: 3;
}

/* Right Sidebar - Properties & Output */
.right-sidebar {
    width: 320px;
    background: white;
    border-left: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
}

.sidebar-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
}

.sidebar-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    background: #f9fafb;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.2s ease;
}

.sidebar-tab.active {
    background: white;
    color: #3b82f6;
    border-bottom: 2px solid #3b82f6;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Properties Panel */
.properties-panel {
    display: none;
}

.properties-panel.active {
    display: block;
}

.properties-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 15px 0;
}

.properties-empty {
    color: #6b7280;
    font-style: italic;
    text-align: center;
    padding: 40px 20px;
}

.property-group {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f3f4f6;
}

.property-group:last-child {
    border-bottom: none;
}

.property-group-title {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
    margin: 0 0 10px 0;
}

/* Output Panel */
.output-panel {
    display: none;
}

.output-panel.active {
    display: block;
}

.output-tabs {
    display: flex;
    margin-bottom: 15px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
}

.output-tab {
    flex: 1;
    padding: 8px 12px;
    background: #f9fafb;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    color: #6b7280;
    transition: all 0.2s ease;
}

.output-tab.active {
    background: #3b82f6;
    color: white;
}

.output-content {
    background: #1f2937;
    color: #f9fafb;
    border-radius: 6px;
    padding: 15px;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
}

.output-empty {
    color: #6b7280;
    font-style: italic;
    text-align: center;
    padding: 20px;
}

/* Query Preview */
.query-preview {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 15px;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
}

/* Validation Messages */
.validation-messages {
    margin-top: 15px;
}

.validation-message {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    margin-bottom: 8px;
}

.validation-error {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.validation-warning {
    background: #fffbeb;
    color: #d97706;
    border: 1px solid #fed7aa;
}

.validation-suggestion {
    background: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

/* Natural Language Interface */
.nl-interface {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.nl-title {
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 10px 0;
    font-size: 0.9rem;
}

.nl-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.nl-button {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.2s ease;
}

.nl-button:hover {
    background: #2563eb;
}

/* Templates Modal */
.templates-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.templates-modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 80%;
    max-width: 800px;
    max-height: 80%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: #f3f4f6;
    color: #374151;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}

.template-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.template-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.template-name {
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.template-description {
    font-size: 0.85rem;
    color: #6b7280;
    line-height: 1.4;
    margin: 0 0 10px 0;
}

.template-category {
    display: inline-block;
    background: #f3f4f6;
    color: #374151;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 12px;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .component-palette {
        width: 240px;
    }
    
    .right-sidebar {
        width: 280px;
    }
}

@media (max-width: 768px) {
    .query-builder-container {
        flex-direction: column;
    }
    
    .component-palette,
    .right-sidebar {
        width: 100%;
        height: 200px;
    }
}

/* Loading and Animation States */
.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e5e7eb;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block content %}
<div class="query-builder-container">
    <!-- Left Sidebar - Component Palette -->
    <div class="component-palette">
        <div class="palette-header">
            <h3 class="palette-title">Components</h3>
            <input type="text" class="palette-search" placeholder="Search components..." id="component-search">
        </div>
        <div class="palette-content">
            <!-- Natural Language Interface -->
            <div class="nl-interface">
                <div class="nl-title">Natural Language</div>
                <textarea class="nl-input" id="nl-input" placeholder="Describe your query in plain English..." rows="3"></textarea>
                <button class="nl-button" onclick="convertNaturalLanguage()">
                    <i class="fa fa-magic"></i> Convert to Query
                </button>
            </div>
            
            <!-- Component Categories -->
            <div class="component-category">
                <h4 class="category-title">Query Clauses</h4>
                
                <div class="component-item" draggable="true" data-component-type="match">
                    <div class="component-icon">M</div>
                    <div class="component-name">MATCH</div>
                    <div class="component-description">Find patterns in the graph</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="where">
                    <div class="component-icon">W</div>
                    <div class="component-name">WHERE</div>
                    <div class="component-description">Filter results with conditions</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="return">
                    <div class="component-icon">R</div>
                    <div class="component-name">RETURN</div>
                    <div class="component-description">Specify what to return</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="with">
                    <div class="component-icon">W</div>
                    <div class="component-name">WITH</div>
                    <div class="component-description">Pass results between queries</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="order_by">
                    <div class="component-icon">O</div>
                    <div class="component-name">ORDER BY</div>
                    <div class="component-description">Sort results</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="limit">
                    <div class="component-icon">L</div>
                    <div class="component-name">LIMIT</div>
                    <div class="component-description">Limit number of results</div>
                </div>
            </div>
            
            <div class="component-category">
                <h4 class="category-title">Modification</h4>
                
                <div class="component-item" draggable="true" data-component-type="create">
                    <div class="component-icon">C</div>
                    <div class="component-name">CREATE</div>
                    <div class="component-description">Create new nodes/relationships</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="set">
                    <div class="component-icon">S</div>
                    <div class="component-name">SET</div>
                    <div class="component-description">Update properties</div>
                </div>
                
                <div class="component-item" draggable="true" data-component-type="delete">
                    <div class="component-icon">D</div>
                    <div class="component-name">DELETE</div>
                    <div class="component-description">Delete nodes/relationships</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Canvas Area -->
    <div class="canvas-container">
        <!-- Toolbar -->
        <div class="canvas-toolbar">
            <div class="toolbar-group">
                <button class="btn-toolbar" onclick="showTemplatesModal()">
                    <i class="fa fa-templates"></i> Templates
                </button>
                <button class="btn-toolbar" onclick="clearCanvas()">
                    <i class="fa fa-trash"></i> Clear
                </button>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <button class="btn-toolbar" onclick="validateQuery()">
                    <i class="fa fa-check-circle"></i> Validate
                </button>
                <button class="btn-toolbar" onclick="optimizeQuery()">
                    <i class="fa fa-optimize"></i> Optimize
                </button>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <button class="btn-toolbar btn-success" onclick="executeQuery()">
                    <i class="fa fa-play"></i> Execute Query
                </button>
            </div>
        </div>
        
        <!-- Canvas -->
        <div class="query-canvas" id="query-canvas">
            <!-- Components will be added here dynamically -->
            
            <!-- SVG for connection lines -->
            <svg class="connection-lines" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>
    
    <!-- Right Sidebar - Properties & Output -->
    <div class="right-sidebar">
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="showSidebarTab('properties')">Properties</button>
            <button class="sidebar-tab" onclick="showSidebarTab('output')">Output</button>
        </div>
        
        <div class="sidebar-content">
            <!-- Properties Panel -->
            <div class="properties-panel active" id="properties-panel">
                <h3 class="properties-title">Component Properties</h3>
                <div class="properties-empty" id="properties-empty">
                    Select a component to edit its properties
                </div>
                <div id="properties-content"></div>
            </div>
            
            <!-- Output Panel -->
            <div class="output-panel" id="output-panel">
                <div class="output-tabs">
                    <button class="output-tab active" onclick="showOutputTab('query')">Query</button>
                    <button class="output-tab" onclick="showOutputTab('results')">Results</button>
                    <button class="output-tab" onclick="showOutputTab('validation')">Validation</button>
                </div>
                
                <div class="output-content" id="output-query">
                    <div class="output-empty">Build your query to see the generated Cypher</div>
                </div>
                
                <div class="output-content" id="output-results" style="display: none;">
                    <div class="output-empty">Execute the query to see results</div>
                </div>
                
                <div class="output-content" id="output-validation" style="display: none;">
                    <div class="output-empty">Validate the query to see analysis</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates Modal -->
<div class="templates-modal" id="templates-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Query Templates</h3>
            <button class="modal-close" onclick="hideTemplatesModal()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="template-grid" id="template-grid">
                <!-- Templates loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
// Visual Query Builder JavaScript
class VisualQueryBuilder {
    constructor() {
        this.components = [];
        this.selectedComponent = null;
        this.componentIdCounter = 1;
        this.isDragging = false;
        this.dragOffset = { x: 0, y: 0 };
        this.canvas = document.getElementById('query-canvas');
        this.schema = {{ schema | tojson | safe }};
        
        this.initializeEventListeners();
        this.loadTemplates();
    }
    
    initializeEventListeners() {
        // Component palette drag events
        const componentItems = document.querySelectorAll('.component-item');
        componentItems.forEach(item => {
            item.addEventListener('dragstart', this.handleDragStart.bind(this));
            item.addEventListener('dragend', this.handleDragEnd.bind(this));
        });
        
        // Canvas drop events
        this.canvas.addEventListener('dragover', this.handleDragOver.bind(this));
        this.canvas.addEventListener('drop', this.handleDrop.bind(this));
        
        // Canvas click events
        this.canvas.addEventListener('click', this.handleCanvasClick.bind(this));
        
        // Component search
        document.getElementById('component-search').addEventListener('input', this.filterComponents.bind(this));
        
        // Auto-generate query on component changes
        this.canvas.addEventListener('componentChanged', this.generateQuery.bind(this));
    }
    
    handleDragStart(e) {
        const item = e.target.closest('.component-item');
        item.classList.add('dragging');
        
        e.dataTransfer.setData('text/plain', item.dataset.componentType);
        e.dataTransfer.effectAllowed = 'copy';
    }
    
    handleDragEnd(e) {
        const item = e.target.closest('.component-item');
        item.classList.remove('dragging');
    }
    
    handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }
    
    handleDrop(e) {
        e.preventDefault();
        
        const componentType = e.dataTransfer.getData('text/plain');
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left + this.canvas.scrollLeft;
        const y = e.clientY - rect.top + this.canvas.scrollTop;
        
        this.createComponent(componentType, { x, y });
    }
    
    handleCanvasClick(e) {
        if (e.target === this.canvas) {
            this.deselectAllComponents();
        }
    }
    
    createComponent(type, position) {
        const componentId = `component_${this.componentIdCounter++}`;
        
        const componentData = {
            id: componentId,
            type: type,
            position: position,
            config: this.getDefaultConfig(type),
            connections: [],
            validation: { valid: true, messages: [] }
        };
        
        this.components.push(componentData);
        this.renderComponent(componentData);
        this.generateQuery();
        
        return componentData;
    }
    
    getDefaultConfig(type) {
        const configs = {
            'match': {
                pattern: '(n)',
                variable: 'n',
                label: '',
                properties: {}
            },
            'where': {
                conditions: [],
                operator: 'AND'
            },
            'return': {
                expressions: ['n'],
                distinct: false
            },
            'create': {
                pattern: '(n)',
                variable: 'n',
                label: '',
                properties: {}
            },
            'set': {
                assignments: []
            },
            'delete': {
                variables: [],
                detach: false
            },
            'with': {
                expressions: [],
                distinct: false
            },
            'order_by': {
                expressions: []
            },
            'limit': {
                count: '25'
            },
            'skip': {
                count: '0'
            }
        };
        
        return configs[type] || {};
    }
    
    renderComponent(componentData) {
        const element = document.createElement('div');
        element.className = 'query-component fade-in';
        element.id = componentData.id;
        element.style.left = `${componentData.position.x}px`;
        element.style.top = `${componentData.position.y}px`;
        
        element.innerHTML = this.generateComponentHTML(componentData);
        
        // Add event listeners
        element.addEventListener('click', (e) => {
            e.stopPropagation();
            this.selectComponent(componentData.id);
        });
        
        element.addEventListener('mousedown', this.startDrag.bind(this));
        
        this.canvas.appendChild(element);
    }
    
    generateComponentHTML(componentData) {
        const typeIcons = {
            'match': 'M',
            'where': 'W',
            'return': 'R',
            'create': 'C',
            'set': 'S',
            'delete': 'D',
            'with': 'W',
            'order_by': 'O',
            'limit': 'L',
            'skip': 'K'
        };
        
        const typeNames = {
            'match': 'MATCH',
            'where': 'WHERE',
            'return': 'RETURN',
            'create': 'CREATE',
            'set': 'SET',
            'delete': 'DELETE',
            'with': 'WITH',
            'order_by': 'ORDER BY',
            'limit': 'LIMIT',
            'skip': 'SKIP'
        };
        
        const icon = typeIcons[componentData.type] || '?';
        const name = typeNames[componentData.type] || componentData.type.toUpperCase();
        
        return `
            <div class="component-header">
                <div class="component-type-icon ${componentData.type}">${icon}</div>
                <div class="component-title">${name}</div>
                <div class="component-actions">
                    <button class="btn-component-action" onclick="queryBuilder.duplicateComponent('${componentData.id}')">
                        <i class="fa fa-copy"></i>
                    </button>
                    <button class="btn-component-action" onclick="queryBuilder.deleteComponent('${componentData.id}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="component-content">
                ${this.generateComponentFields(componentData)}
            </div>
        `;
    }
    
    generateComponentFields(componentData) {
        const type = componentData.type;
        const config = componentData.config;
        
        switch (type) {
            case 'match':
                return `
                    <div class="component-field">
                        <label class="field-label">Pattern</label>
                        <input type="text" class="field-input" value="${config.pattern || ''}" 
                               onchange="queryBuilder.updateComponentConfig('${componentData.id}', 'pattern', this.value)">
                    </div>
                `;
            
            case 'where':
                return `
                    <div class="component-field">
                        <label class="field-label">Conditions</label>
                        <textarea class="field-input" rows="3" placeholder="n.property = 'value'"
                                  onchange="queryBuilder.updateComponentConfig('${componentData.id}', 'conditions', this.value.split('\\n').filter(c => c.trim()))">${(config.conditions || []).join('\\n')}</textarea>
                    </div>
                `;
            
            case 'return':
                return `
                    <div class="component-field">
                        <label class="field-label">Expressions</label>
                        <input type="text" class="field-input" value="${(config.expressions || []).join(', ')}" 
                               placeholder="n, r, m"
                               onchange="queryBuilder.updateComponentConfig('${componentData.id}', 'expressions', this.value.split(',').map(e => e.trim()))">
                    </div>
                    <div class="component-field">
                        <label class="field-label">
                            <input type="checkbox" ${config.distinct ? 'checked' : ''} 
                                   onchange="queryBuilder.updateComponentConfig('${componentData.id}', 'distinct', this.checked)">
                            Distinct
                        </label>
                    </div>
                `;
            
            case 'limit':
                return `
                    <div class="component-field">
                        <label class="field-label">Count</label>
                        <input type="number" class="field-input" value="${config.count || '25'}" min="1"
                               onchange="queryBuilder.updateComponentConfig('${componentData.id}', 'count', this.value)">
                    </div>
                `;
            
            default:
                return '<div class="component-field">No additional configuration</div>';
        }
    }
    
    updateComponentConfig(componentId, key, value) {
        const component = this.components.find(c => c.id === componentId);
        if (component) {
            component.config[key] = value;
            this.generateQuery();
            this.canvas.dispatchEvent(new CustomEvent('componentChanged'));
        }
    }
    
    selectComponent(componentId) {
        this.deselectAllComponents();
        
        const element = document.getElementById(componentId);
        const component = this.components.find(c => c.id === componentId);
        
        if (element && component) {
            element.classList.add('selected');
            this.selectedComponent = component;
            this.showComponentProperties(component);
        }
    }
    
    deselectAllComponents() {
        document.querySelectorAll('.query-component').forEach(el => {
            el.classList.remove('selected');
        });
        this.selectedComponent = null;
        this.hideComponentProperties();
    }
    
    showComponentProperties(component) {
        const propertiesContent = document.getElementById('properties-content');
        const propertiesEmpty = document.getElementById('properties-empty');
        
        propertiesEmpty.style.display = 'none';
        propertiesContent.style.display = 'block';
        
        propertiesContent.innerHTML = `
            <div class="property-group">
                <div class="property-group-title">Component: ${component.type.toUpperCase()}</div>
                <div class="component-field">
                    <label class="field-label">ID</label>
                    <input type="text" class="field-input" value="${component.id}" readonly>
                </div>
                <div class="component-field">
                    <label class="field-label">Position X</label>
                    <input type="number" class="field-input" value="${component.position.x}" 
                           onchange="queryBuilder.updateComponentPosition('${component.id}', 'x', parseFloat(this.value))">
                </div>
                <div class="component-field">
                    <label class="field-label">Position Y</label>
                    <input type="number" class="field-input" value="${component.position.y}" 
                           onchange="queryBuilder.updateComponentPosition('${component.id}', 'y', parseFloat(this.value))">
                </div>
            </div>
        `;
    }
    
    hideComponentProperties() {
        const propertiesContent = document.getElementById('properties-content');
        const propertiesEmpty = document.getElementById('properties-empty');
        
        propertiesEmpty.style.display = 'block';
        propertiesContent.style.display = 'none';
    }
    
    updateComponentPosition(componentId, axis, value) {
        const component = this.components.find(c => c.id === componentId);
        const element = document.getElementById(componentId);
        
        if (component && element) {
            component.position[axis] = value;
            element.style[axis === 'x' ? 'left' : 'top'] = `${value}px`;
        }
    }
    
    deleteComponent(componentId) {
        const index = this.components.findIndex(c => c.id === componentId);
        if (index !== -1) {
            this.components.splice(index, 1);
            const element = document.getElementById(componentId);
            if (element) {
                element.remove();
            }
            
            if (this.selectedComponent && this.selectedComponent.id === componentId) {
                this.selectedComponent = null;
                this.hideComponentProperties();
            }
            
            this.generateQuery();
        }
    }
    
    duplicateComponent(componentId) {
        const original = this.components.find(c => c.id === componentId);
        if (original) {
            const duplicate = JSON.parse(JSON.stringify(original));
            duplicate.id = `component_${this.componentIdCounter++}`;
            duplicate.position.x += 20;
            duplicate.position.y += 20;
            
            this.components.push(duplicate);
            this.renderComponent(duplicate);
            this.generateQuery();
        }
    }
    
    generateQuery() {
        if (this.components.length === 0) {
            this.updateQueryOutput('Build components to generate Cypher query');
            return;
        }
        
        // Send components to backend for query generation
        fetch('/graph/query-builder/api/build/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                components: this.components
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.updateQueryOutput(data.query);
                this.updateValidationOutput(data.validation);
            } else {
                this.updateQueryOutput(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Query generation error:', error);
            this.updateQueryOutput(`Error generating query: ${error.message}`);
        });
    }
    
    updateQueryOutput(query) {
        document.getElementById('output-query').innerHTML = `<pre>${query}</pre>`;
    }
    
    updateValidationOutput(validation) {
        const validationElement = document.getElementById('output-validation');
        
        if (!validation) {
            validationElement.innerHTML = '<div class="output-empty">No validation data</div>';
            return;
        }
        
        let html = `<div>Valid: ${validation.valid ? 'Yes' : 'No'}</div>`;
        html += `<div>Complexity Score: ${validation.complexity_score || 0}</div>`;
        
        if (validation.errors && validation.errors.length > 0) {
            html += '<h4>Errors:</h4><ul>';
            validation.errors.forEach(error => {
                html += `<li style="color: #ef4444;">${error}</li>`;
            });
            html += '</ul>';
        }
        
        if (validation.warnings && validation.warnings.length > 0) {
            html += '<h4>Warnings:</h4><ul>';
            validation.warnings.forEach(warning => {
                html += `<li style="color: #f59e0b;">${warning}</li>`;
            });
            html += '</ul>';
        }
        
        if (validation.suggestions && validation.suggestions.length > 0) {
            html += '<h4>Suggestions:</h4><ul>';
            validation.suggestions.forEach(suggestion => {
                html += `<li style="color: #3b82f6;">${suggestion}</li>`;
            });
            html += '</ul>';
        }
        
        validationElement.innerHTML = html;
    }
    
    filterComponents(e) {
        const searchTerm = e.target.value.toLowerCase();
        const components = document.querySelectorAll('.component-item');
        
        components.forEach(component => {
            const name = component.querySelector('.component-name').textContent.toLowerCase();
            const description = component.querySelector('.component-description').textContent.toLowerCase();
            
            if (name.includes(searchTerm) || description.includes(searchTerm)) {
                component.style.display = 'block';
            } else {
                component.style.display = 'none';
            }
        });
    }
    
    loadTemplates() {
        fetch('/graph/query-builder/api/templates/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.renderTemplates(data.templates);
                }
            })
            .catch(error => console.error('Failed to load templates:', error));
    }
    
    renderTemplates(templates) {
        const grid = document.getElementById('template-grid');
        
        grid.innerHTML = templates.map(template => `
            <div class="template-card" onclick="queryBuilder.loadTemplate('${template.id}')">
                <div class="template-name">${template.name}</div>
                <div class="template-description">${template.description}</div>
                <div class="template-category">${template.category}</div>
            </div>
        `).join('');
    }
    
    loadTemplate(templateId) {
        fetch(`/graph/query-builder/api/templates/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const template = data.templates.find(t => t.id === templateId);
                    if (template) {
                        this.clearCanvas();
                        
                        template.components.forEach(comp => {
                            const componentData = {
                                id: `component_${this.componentIdCounter++}`,
                                type: comp.type,
                                position: comp.position,
                                config: comp.config,
                                connections: comp.connections || [],
                                validation: comp.validation || { valid: true, messages: [] }
                            };
                            
                            this.components.push(componentData);
                            this.renderComponent(componentData);
                        });
                        
                        this.generateQuery();
                        this.hideTemplatesModal();
                    }
                }
            })
            .catch(error => console.error('Failed to load template:', error));
    }
    
    clearCanvas() {
        this.components = [];
        this.selectedComponent = null;
        document.querySelectorAll('.query-component').forEach(el => el.remove());
        this.hideComponentProperties();
        this.updateQueryOutput('Canvas cleared');
        document.getElementById('output-results').innerHTML = '<div class="output-empty">Execute the query to see results</div>';
    }
    
    startDrag(e) {
        if (e.target.closest('.btn-component-action')) return;
        
        const component = e.currentTarget;
        this.isDragging = true;
        this.dragOffset = {
            x: e.clientX - component.offsetLeft,
            y: e.clientY - component.offsetTop
        };
        
        const handleMouseMove = (moveEvent) => {
            if (this.isDragging) {
                const newX = moveEvent.clientX - this.dragOffset.x;
                const newY = moveEvent.clientY - this.dragOffset.y;
                
                component.style.left = `${newX}px`;
                component.style.top = `${newY}px`;
                
                // Update component data
                const componentData = this.components.find(c => c.id === component.id);
                if (componentData) {
                    componentData.position.x = newX;
                    componentData.position.y = newY;
                }
            }
        };
        
        const handleMouseUp = () => {
            this.isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
}

// Global functions
let queryBuilder;

document.addEventListener('DOMContentLoaded', function() {
    queryBuilder = new VisualQueryBuilder();
});

function showSidebarTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.sidebar-tab[onclick*="${tabName}"]`).classList.add('active');
    
    // Show/hide panels
    document.querySelectorAll('.properties-panel, .output-panel').forEach(panel => {
        panel.classList.remove('active');
        panel.style.display = 'none';
    });
    
    const targetPanel = document.getElementById(`${tabName}-panel`);
    if (targetPanel) {
        targetPanel.classList.add('active');
        targetPanel.style.display = 'block';
    }
}

function showOutputTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.output-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide content
    document.querySelectorAll('[id^="output-"]').forEach(content => {
        content.style.display = 'none';
    });
    
    const targetContent = document.getElementById(`output-${tabName}`);
    if (targetContent) {
        targetContent.style.display = 'block';
    }
}

function showTemplatesModal() {
    document.getElementById('templates-modal').classList.add('show');
}

function hideTemplatesModal() {
    document.getElementById('templates-modal').classList.remove('show');
}

function validateQuery() {
    // Get current generated query
    const queryText = document.getElementById('output-query').textContent;
    
    if (!queryText || queryText.includes('Build components')) {
        showNotification('Please build a query first', 'warning');
        return;
    }
    
    fetch('/graph/query-builder/api/validate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: queryText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            queryBuilder.updateValidationOutput(data.validation);
            showSidebarTab('output');
            showOutputTab('validation');
            
            const isValid = data.validation.valid;
            showNotification(
                isValid ? 'Query is valid!' : 'Query has validation errors',
                isValid ? 'success' : 'error'
            );
        } else {
            showNotification(`Validation error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
        showNotification('Validation failed', 'error');
    });
}

function optimizeQuery() {
    const queryText = document.getElementById('output-query').textContent;
    
    if (!queryText || queryText.includes('Build components')) {
        showNotification('Please build a query first', 'warning');
        return;
    }
    
    fetch('/graph/query-builder/api/optimize/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: queryText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.optimization_applied) {
                queryBuilder.updateQueryOutput(data.optimized_query);
                showNotification(`Query optimized with ${data.improvements.length} improvements`, 'success');
            } else {
                showNotification('No optimizations needed', 'info');
            }
        } else {
            showNotification(`Optimization error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Optimization error:', error);
        showNotification('Optimization failed', 'error');
    });
}

function executeQuery() {
    const queryText = document.getElementById('output-query').textContent;
    
    if (!queryText || queryText.includes('Build components')) {
        showNotification('Please build a query first', 'warning');
        return;
    }
    
    showLoadingSpinner();
    
    fetch('/graph/query-builder/api/execute/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: queryText,
            parameters: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingSpinner();
        
        if (data.success) {
            const resultsHtml = `
                <div>
                    <div>Query executed successfully</div>
                    <div>Results: ${data.count} rows</div>
                    <div>Execution time: ${data.execution_time}</div>
                    <hr style="margin: 10px 0;">
                    <pre>${JSON.stringify(data.results, null, 2)}</pre>
                </div>
            `;
            document.getElementById('output-results').innerHTML = resultsHtml;
            
            showSidebarTab('output');
            showOutputTab('results');
            showNotification('Query executed successfully!', 'success');
        } else {
            document.getElementById('output-results').innerHTML = `<div style="color: #ef4444;">Error: ${data.error}</div>`;
            showNotification(`Query execution failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        hideLoadingSpinner();
        console.error('Execution error:', error);
        showNotification('Query execution failed', 'error');
    });
}

function convertNaturalLanguage() {
    const naturalQuery = document.getElementById('nl-input').value.trim();
    
    if (!naturalQuery) {
        showNotification('Please enter a natural language query', 'warning');
        return;
    }
    
    fetch('/graph/query-builder/api/natural-language/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            natural_query: naturalQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            queryBuilder.updateQueryOutput(data.cypher);
            showNotification(`Converted with ${(data.confidence * 100).toFixed(0)}% confidence`, 'success');
        } else {
            showNotification(`Conversion failed: ${data.error}`, 'error');
            
            if (data.suggestions) {
                console.log('Suggestions:', data.suggestions);
            }
        }
    })
    .catch(error => {
        console.error('Natural language processing error:', error);
        showNotification('Natural language processing failed', 'error');
    });
}

// Utility functions
function showLoadingSpinner() {
    // Implementation would add loading spinner
    console.log('Loading...');
}

function hideLoadingSpinner() {
    // Implementation would hide loading spinner
    console.log('Loading complete');
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-left: 4px solid ${type === 'success' ? '#10b981' : 
                                   type === 'error' ? '#ef4444' : 
                                   type === 'warning' ? '#f59e0b' : '#3b82f6'};
        border-radius: 6px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fa fa-${type === 'error' ? 'exclamation-circle' : 
                              type === 'success' ? 'check-circle' : 
                              type === 'warning' ? 'exclamation-triangle' :
                              'info-circle'}" 
               style="color: ${type === 'success' ? '#10b981' : 
                               type === 'error' ? '#ef4444' : 
                               type === 'warning' ? '#f59e0b' : '#3b82f6'};"></i>
            <span style="color: #374151;">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Add required CSS animations
const animationStyles = document.createElement('style');
animationStyles.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(animationStyles);
</script>
{% endblock %}