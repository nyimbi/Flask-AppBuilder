{% extends "appbuilder/base.html" %}

{% block head_css %}
  {{ super() }}
  <style>
    .trigger-designer {
      background: #f8f9fa;
      min-height: calc(100vh - 150px);
    }
    
    .designer-header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    
    .trigger-config-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .panel-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
    }
    
    .panel-body {
      padding: 20px;
    }
    
    .trigger-type-selection {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .trigger-type-card {
      flex: 1;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    
    .trigger-type-card:hover {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    }
    
    .trigger-type-card.selected {
      border-color: #007bff;
      background: #f0f8ff;
      color: #007bff;
    }
    
    .trigger-type-card i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    .condition-builder {
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      background: #fafafa;
      margin-bottom: 15px;
    }
    
    .condition-group {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      background: white;
    }
    
    .condition-item {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .condition-item:last-child {
      margin-bottom: 0;
    }
    
    .condition-field {
      flex: 2;
    }
    
    .condition-operator {
      flex: 1;
    }
    
    .condition-value {
      flex: 2;
    }
    
    .ml-config-panel {
      background: #e8f4fd;
      border: 1px solid #b3d9f7;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .ml-model-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .ml-model-card {
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    
    .ml-model-card.selected {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    .ml-model-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 5px;
    }
    
    .ml-model-status.trained {
      background: #d4edda;
      color: #155724;
    }
    
    .ml-model-status.not-trained {
      background: #f8d7da;
      color: #721c24;
    }
    
    .schedule-builder {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .schedule-options {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .schedule-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .actions-builder {
      background: #f0f9ff;
      border: 1px solid #bde0ff;
      border-radius: 6px;
      padding: 15px;
    }
    
    .action-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      margin-bottom: 10px;
      background: white;
    }
    
    .action-type {
      min-width: 120px;
      font-weight: 600;
      color: #495057;
    }
    
    .json-editor {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      background: #2d3748;
      color: #e2e8f0;
      border-radius: 6px;
      padding: 15px;
      min-height: 300px;
      resize: vertical;
    }
    
    .preview-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .test-results {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .btn-test {
      background: #17a2b8;
      border-color: #17a2b8;
    }
    
    .btn-test:hover {
      background: #138496;
      border-color: #117a8b;
    }
  </style>
{% endblock %}

{% block content %}
<div class="trigger-designer">
  <div class="designer-header">
    <div class="row align-items-center">
      <div class="col">
        <h3><i class="fa fa-bolt"></i> Trigger Designer - {{ trigger.name }}</h3>
        <p class="text-muted mb-0">Configure intelligent process triggers and automation rules</p>
      </div>
      <div class="col-auto">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-secondary" id="preview-trigger">
            <i class="fa fa-eye"></i> Preview
          </button>
          <button type="button" class="btn btn-test" id="test-trigger">
            <i class="fa fa-flask"></i> Test
          </button>
          <button type="button" class="btn btn-success" id="save-trigger">
            <i class="fa fa-save"></i> Save
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <!-- Trigger Type Selection -->
        <div class="trigger-config-panel">
          <div class="panel-header">
            <i class="fa fa-cog"></i> Trigger Type Configuration
          </div>
          <div class="panel-body">
            <div class="trigger-type-selection">
              <div class="trigger-type-card" data-type="schedule">
                <i class="fa fa-clock-o"></i>
                <div><strong>Schedule</strong></div>
                <small>Time-based triggers</small>
              </div>
              <div class="trigger-type-card" data-type="data_condition">
                <i class="fa fa-database"></i>
                <div><strong>Data Condition</strong></div>
                <small>Data-driven triggers</small>
              </div>
              <div class="trigger-type-card" data-type="event_driven">
                <i class="fa fa-bolt"></i>
                <div><strong>Event Driven</strong></div>
                <small>Event-based triggers</small>
              </div>
              <div class="trigger-type-card" data-type="ml_prediction">
                <i class="fa fa-brain"></i>
                <div><strong>ML Prediction</strong></div>
                <small>AI-powered triggers</small>
              </div>
              <div class="trigger-type-card" data-type="anomaly_detection">
                <i class="fa fa-exclamation-triangle"></i>
                <div><strong>Anomaly Detection</strong></div>
                <small>Anomaly-based triggers</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Schedule Configuration -->
        <div class="trigger-config-panel" id="schedule-config" style="display: none;">
          <div class="panel-header">
            <i class="fa fa-clock-o"></i> Schedule Configuration
          </div>
          <div class="panel-body">
            <div class="schedule-builder">
              <div class="schedule-options">
                <div class="schedule-option">
                  <input type="radio" name="schedule_type" value="interval" id="schedule-interval">
                  <label for="schedule-interval">Interval</label>
                </div>
                <div class="schedule-option">
                  <input type="radio" name="schedule_type" value="cron" id="schedule-cron">
                  <label for="schedule-cron">Cron Expression</label>
                </div>
                <div class="schedule-option">
                  <input type="radio" name="schedule_type" value="daily" id="schedule-daily">
                  <label for="schedule-daily">Daily</label>
                </div>
              </div>
              
              <div id="interval-config" class="schedule-config-section">
                <div class="form-group">
                  <label>Interval (seconds)</label>
                  <input type="number" class="form-control" id="interval-seconds" min="60" value="3600">
                  <small class="form-text text-muted">Minimum interval is 60 seconds</small>
                </div>
              </div>
              
              <div id="cron-config" class="schedule-config-section" style="display: none;">
                <div class="form-group">
                  <label>Cron Expression</label>
                  <input type="text" class="form-control" id="cron-expression" placeholder="0 9 * * *">
                  <small class="form-text text-muted">Examples: "0 9 * * *" (daily at 9 AM), "0 */2 * * *" (every 2 hours)</small>
                </div>
              </div>
              
              <div id="daily-config" class="schedule-config-section" style="display: none;">
                <div class="form-group">
                  <label>Time of Day</label>
                  <input type="time" class="form-control" id="daily-time" value="09:00">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Data Condition Configuration -->
        <div class="trigger-config-panel" id="condition-config" style="display: none;">
          <div class="panel-header">
            <i class="fa fa-database"></i> Data Condition Configuration
          </div>
          <div class="panel-body">
            <div class="condition-builder">
              <div id="conditions-list">
                <div class="condition-group">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong>Condition Group 1</strong>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCondition(this)">
                      <i class="fa fa-plus"></i> Add Condition
                    </button>
                  </div>
                  
                  <div class="condition-item">
                    <select class="form-control condition-field">
                      <option value="">Select Field</option>
                      <option value="database">Database Query</option>
                      <option value="api">API Response</option>
                      <option value="file">File Content</option>
                      <option value="metric">System Metric</option>
                    </select>
                    
                    <select class="form-control condition-operator">
                      <option value="==">=</option>
                      <option value="!=">&ne;</option>
                      <option value=">">&gt;</option>
                      <option value="<">&lt;</option>
                      <option value=">=">&ge;</option>
                      <option value="<=">&le;</option>
                      <option value="contains">Contains</option>
                    </select>
                    
                    <input type="text" class="form-control condition-value" placeholder="Value">
                    
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCondition(this)">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <button type="button" class="btn btn-outline-primary" onclick="addConditionGroup()">
                <i class="fa fa-plus"></i> Add Condition Group
              </button>
            </div>
          </div>
        </div>
        
        <!-- ML Prediction Configuration -->
        <div class="trigger-config-panel" id="ml-config" style="display: none;">
          <div class="panel-header">
            <i class="fa fa-brain"></i> ML Prediction Configuration
          </div>
          <div class="panel-body">
            <div class="ml-config-panel">
              <div class="ml-model-selection">
                <div class="ml-model-card" data-model="outcome_predictor">
                  <i class="fa fa-chart-line"></i>
                  <div><strong>Outcome Predictor</strong></div>
                  <div class="ml-model-status trained">Trained</div>
                  <small>Predicts process success</small>
                </div>
                <div class="ml-model-card" data-model="duration_predictor">
                  <i class="fa fa-clock-o"></i>
                  <div><strong>Duration Predictor</strong></div>
                  <div class="ml-model-status not-trained">Not Trained</div>
                  <small>Predicts execution time</small>
                </div>
              </div>
              
              <div class="form-group">
                <label>Confidence Threshold</label>
                <input type="range" class="form-control-range" id="ml-threshold" min="0.1" max="1.0" step="0.1" value="0.8">
                <div class="d-flex justify-content-between">
                  <small>0.1 (Low)</small>
                  <small id="threshold-value">0.8</small>
                  <small>1.0 (High)</small>
                </div>
              </div>
              
              <div class="form-group">
                <label>Prediction Context</label>
                <textarea class="form-control" rows="3" placeholder="Additional context for ML prediction"></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Process Target Configuration -->
        <div class="trigger-config-panel">
          <div class="panel-header">
            <i class="fa fa-target"></i> Target Process
          </div>
          <div class="panel-body">
            <div class="form-group">
              <label for="target-process">Process Definition</label>
              <select class="form-control" id="target-process">
                <option value="">Select Process</option>
                {% for definition in definitions %}
                <option value="{{ definition.id }}" {% if trigger.process_definition_id == definition.id %}selected{% endif %}>
                  {{ definition.name }} (v{{ definition.version }})
                </option>
                {% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label>Input Data Template</label>
              <textarea class="form-control" rows="4" id="input-template" 
                        placeholder='{"key": "value", "user_id": "${trigger.context.user_id}"}'></textarea>
              <small class="form-text text-muted">JSON template for process input data. Use ${} for dynamic values.</small>
            </div>
          </div>
        </div>
        
        <!-- Actions Configuration -->
        <div class="trigger-config-panel">
          <div class="panel-header">
            <i class="fa fa-tasks"></i> Additional Actions
          </div>
          <div class="panel-body">
            <div class="actions-builder">
              <div id="actions-list">
                <!-- Actions will be added dynamically -->
              </div>
              
              <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-toggle="dropdown">
                  <i class="fa fa-plus"></i> Add Action
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="#" onclick="addAction('webhook')">
                    <i class="fa fa-globe"></i> Webhook
                  </a>
                  <a class="dropdown-item" href="#" onclick="addAction('notification')">
                    <i class="fa fa-bell"></i> Notification
                  </a>
                  <a class="dropdown-item" href="#" onclick="addAction('data_update')">
                    <i class="fa fa-database"></i> Data Update
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <!-- JSON Configuration -->
        <div class="trigger-config-panel">
          <div class="panel-header">
            <i class="fa fa-code"></i> JSON Configuration
            <button type="button" class="btn btn-sm btn-outline-secondary float-right" onclick="formatJson()">
              <i class="fa fa-indent"></i> Format
            </button>
          </div>
          <div class="panel-body">
            <textarea class="json-editor" id="json-config">{{ configuration }}</textarea>
          </div>
        </div>
        
        <!-- Preview Panel -->
        <div class="preview-panel">
          <h6><i class="fa fa-eye"></i> Trigger Preview</h6>
          <div id="preview-content">
            <p class="text-muted">Configure trigger settings to see preview</p>
          </div>
        </div>
        
        <!-- Test Results -->
        <div class="test-results" id="test-results" style="display: none;">
          <h6><i class="fa fa-flask"></i> Test Results</h6>
          <div id="test-output">
            <!-- Test results will appear here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block tail_js %}
  {{ super() }}
  <script>
    $(document).ready(function() {
      var triggerId = {{ trigger.id }};
      var currentConfig = {};
      
      try {
        currentConfig = JSON.parse($('#json-config').val());
      } catch (e) {
        currentConfig = {};
      }
      
      // Initialize trigger type selection
      $('.trigger-type-card').click(function() {
        $('.trigger-type-card').removeClass('selected');
        $(this).addClass('selected');
        
        var type = $(this).data('type');
        showConfigForType(type);
        updateJsonConfig();
      });
      
      // Set initial trigger type
      var initialType = '{{ trigger.trigger_type }}';
      if (initialType) {
        $('.trigger-type-card[data-type="' + initialType + '"]').addClass('selected');
        showConfigForType(initialType);
      }
      
      // Schedule configuration
      $('input[name="schedule_type"]').change(function() {
        $('.schedule-config-section').hide();
        $('#' + $(this).val() + '-config').show();
        updateJsonConfig();
      });
      
      // ML threshold slider
      $('#ml-threshold').on('input', function() {
        $('#threshold-value').text($(this).val());
        updateJsonConfig();
      });
      
      // ML model selection
      $('.ml-model-card').click(function() {
        $('.ml-model-card').removeClass('selected');
        $(this).addClass('selected');
        updateJsonConfig();
      });
      
      // Save trigger
      $('#save-trigger').click(function() {
        saveTrigger();
      });
      
      // Test trigger
      $('#test-trigger').click(function() {
        testTrigger();
      });
      
      // Preview trigger
      $('#preview-trigger').click(function() {
        updatePreview();
      });
      
      // JSON editor sync
      $('#json-config').on('input', function() {
        try {
          var config = JSON.parse($(this).val());
          currentConfig = config;
          updatePreview();
        } catch (e) {
          // Invalid JSON - don't update
        }
      });
      
      function showConfigForType(type) {
        $('.trigger-config-panel[id$="-config"]').hide();
        
        switch (type) {
          case 'schedule':
            $('#schedule-config').show();
            break;
          case 'data_condition':
            $('#condition-config').show();
            break;
          case 'ml_prediction':
            $('#ml-config').show();
            break;
          case 'anomaly_detection':
            // Show anomaly-specific config if needed
            break;
        }
      }
      
      function updateJsonConfig() {
        var config = buildConfigFromUI();
        $('#json-config').val(JSON.stringify(config, null, 2));
        currentConfig = config;
        updatePreview();
      }
      
      function buildConfigFromUI() {
        var config = {};
        var selectedType = $('.trigger-type-card.selected').data('type');
        
        if (selectedType === 'schedule') {
          var scheduleType = $('input[name="schedule_type"]:checked').val();
          config.schedule = { frequency: scheduleType };
          
          if (scheduleType === 'interval') {
            config.schedule.interval_seconds = parseInt($('#interval-seconds').val());
          } else if (scheduleType === 'cron') {
            config.schedule.cron = $('#cron-expression').val();
          } else if (scheduleType === 'daily') {
            config.schedule.frequency = 'daily';
            config.schedule.time = $('#daily-time').val();
          }
        } else if (selectedType === 'data_condition') {
          config.conditions = buildConditionsFromUI();
        } else if (selectedType === 'ml_prediction') {
          config.model = $('.ml-model-card.selected').data('model');
          config.threshold = parseFloat($('#ml-threshold').val());
        }
        
        // Add target process
        var targetProcess = $('#target-process').val();
        if (targetProcess) {
          config.target_process_id = parseInt(targetProcess);
        }
        
        // Add input template
        var inputTemplate = $('#input-template').val();
        if (inputTemplate) {
          try {
            config.input_data = JSON.parse(inputTemplate);
          } catch (e) {
            config.input_data = {};
          }
        }
        
        // Add actions
        config.actions = buildActionsFromUI();
        
        return config;
      }
      
      function buildConditionsFromUI() {
        var conditions = [];
        
        $('.condition-item').each(function() {
          var field = $(this).find('.condition-field').val();
          var operator = $(this).find('.condition-operator').val();
          var value = $(this).find('.condition-value').val();
          
          if (field && operator && value) {
            conditions.push({
              source: field,
              query: value,
              operator: operator,
              value: value
            });
          }
        });
        
        return conditions;
      }
      
      function buildActionsFromUI() {
        var actions = [];
        
        $('.action-item').each(function() {
          var type = $(this).data('action-type');
          var config = {};
          
          $(this).find('input, textarea').each(function() {
            var name = $(this).attr('name');
            if (name) {
              config[name] = $(this).val();
            }
          });
          
          if (type && Object.keys(config).length > 0) {
            actions.push({
              type: type,
              ...config
            });
          }
        });
        
        return actions;
      }
      
      function updatePreview() {
        var preview = '<div class="small">';
        preview += '<strong>Type:</strong> ' + ($('.trigger-type-card.selected').find('strong').text() || 'Not selected') + '<br>';
        
        var targetProcess = $('#target-process option:selected').text();
        if (targetProcess && targetProcess !== 'Select Process') {
          preview += '<strong>Target:</strong> ' + targetProcess + '<br>';
        }
        
        if (currentConfig.schedule) {
          preview += '<strong>Schedule:</strong> ' + JSON.stringify(currentConfig.schedule) + '<br>';
        }
        
        if (currentConfig.conditions && currentConfig.conditions.length > 0) {
          preview += '<strong>Conditions:</strong> ' + currentConfig.conditions.length + ' condition(s)<br>';
        }
        
        if (currentConfig.model) {
          preview += '<strong>ML Model:</strong> ' + currentConfig.model + ' (threshold: ' + currentConfig.threshold + ')<br>';
        }
        
        if (currentConfig.actions && currentConfig.actions.length > 0) {
          preview += '<strong>Actions:</strong> ' + currentConfig.actions.length + ' action(s)<br>';
        }
        
        preview += '</div>';
        
        $('#preview-content').html(preview);
      }
      
      function saveTrigger() {
        var config = currentConfig;
        var targetProcessId = $('#target-process').val();
        
        var data = {
          configuration: JSON.stringify(config),
          process_definition_id: targetProcessId ? parseInt(targetProcessId) : null
        };
        
        $.ajax({
          url: '/api/v1/smart_trigger/' + triggerId,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function(response) {
            showMessage('Trigger saved successfully!', 'success');
          },
          error: function(xhr) {
            var message = 'Failed to save trigger';
            try {
              var error = JSON.parse(xhr.responseText);
              message = error.message || message;
            } catch (e) {}
            showMessage(message, 'error');
          }
        });
      }
      
      function testTrigger() {
        $('#test-results').show();
        $('#test-output').html('<div class="text-info"><i class="fa fa-spinner fa-spin"></i> Testing trigger...</div>');
        
        $.ajax({
          url: '/api/v1/smart_trigger/test/' + triggerId,
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            test_data: { test_mode: true }
          }),
          success: function(response) {
            var output = '<div class="text-success"><i class="fa fa-check"></i> Test completed successfully</div>';
            output += '<pre class="mt-2">' + JSON.stringify(response, null, 2) + '</pre>';
            $('#test-output').html(output);
          },
          error: function(xhr) {
            var message = 'Test failed';
            try {
              var error = JSON.parse(xhr.responseText);
              message = error.message || message;
            } catch (e) {}
            $('#test-output').html('<div class="text-danger"><i class="fa fa-times"></i> ' + message + '</div>');
          }
        });
      }
      
      function showMessage(message, type) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var alert = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                   message +
                   '<button type="button" class="close" data-dismiss="alert">' +
                   '<span>&times;</span></button></div>';
        
        $('.designer-header').after(alert);
        
        setTimeout(function() {
          $('.alert').alert('close');
        }, 5000);
      }
    });
    
    function formatJson() {
      try {
        var config = JSON.parse($('#json-config').val());
        $('#json-config').val(JSON.stringify(config, null, 2));
      } catch (e) {
        alert('Invalid JSON format');
      }
    }
    
    function addCondition(button) {
      var conditionGroup = $(button).closest('.condition-group');
      var newCondition = `
        <div class="condition-item">
          <select class="form-control condition-field">
            <option value="">Select Field</option>
            <option value="database">Database Query</option>
            <option value="api">API Response</option>
            <option value="file">File Content</option>
            <option value="metric">System Metric</option>
          </select>
          
          <select class="form-control condition-operator">
            <option value="==">=</option>
            <option value="!=">&ne;</option>
            <option value=">">&gt;</option>
            <option value="<">&lt;</option>
            <option value=">=">&ge;</option>
            <option value="<=">&le;</option>
            <option value="contains">Contains</option>
          </select>
          
          <input type="text" class="form-control condition-value" placeholder="Value">
          
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCondition(this)">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      `;
      
      conditionGroup.find('.condition-item:last').after(newCondition);
    }
    
    function removeCondition(button) {
      $(button).closest('.condition-item').remove();
    }
    
    function addConditionGroup() {
      var groupCount = $('.condition-group').length + 1;
      var newGroup = `
        <div class="condition-group">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>Condition Group ` + groupCount + `</strong>
            <div>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCondition(this)">
                <i class="fa fa-plus"></i> Add Condition
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('.condition-group').remove()">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      $('#conditions-list').append(newGroup);
    }
    
    function addAction(type) {
      var actionHtml = '';
      var actionTitle = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      if (type === 'webhook') {
        actionHtml = `
          <div class="action-item" data-action-type="webhook">
            <div class="action-type">
              <i class="fa fa-globe"></i> Webhook
            </div>
            <div class="flex-fill">
              <input type="url" class="form-control mb-2" name="url" placeholder="Webhook URL">
              <select class="form-control" name="method">
                <option value="POST">POST</option>
                <option value="GET">GET</option>
                <option value="PUT">PUT</option>
              </select>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('.action-item').remove()">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
      } else if (type === 'notification') {
        actionHtml = `
          <div class="action-item" data-action-type="notification">
            <div class="action-type">
              <i class="fa fa-bell"></i> Notification
            </div>
            <div class="flex-fill">
              <input type="text" class="form-control mb-2" name="recipients" placeholder="Recipients (comma-separated)">
              <input type="text" class="form-control" name="message" placeholder="Notification message">
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('.action-item').remove()">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
      } else if (type === 'data_update') {
        actionHtml = `
          <div class="action-item" data-action-type="data_update">
            <div class="action-type">
              <i class="fa fa-database"></i> Data Update
            </div>
            <div class="flex-fill">
              <input type="text" class="form-control mb-2" name="target" placeholder="Target table/collection">
              <textarea class="form-control" name="update_data" rows="2" placeholder="Update data (JSON)"></textarea>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('.action-item').remove()">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
      }
      
      $('#actions-list').append(actionHtml);
    }
  </script>
{% endblock %}