<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Credential Management</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<style>
		.credential-card {
			transition: transform 0.2s ease-in-out;
			border-left: 4px solid #6c757d;
		}
		
		.credential-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
		}
		
		.integration-type-sso { border-left-color: #007bff; }
		.integration-type-ldap { border-left-color: #28a745; }
		.integration-type-api { border-left-color: #ffc107; }
		.integration-type-database { border-left-color: #dc3545; }
		.integration-type-other { border-left-color: #6f42c1; }
		
		.credential-actions {
			opacity: 0;
			transition: opacity 0.2s ease-in-out;
		}
		
		.credential-card:hover .credential-actions {
			opacity: 1;
		}
		
		.security-indicator {
			display: inline-flex;
			align-items: center;
			gap: 0.25rem;
			font-size: 0.875rem;
		}
		
		.security-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
		}
		
		.security-high .security-dot { background-color: #28a745; }
		.security-medium .security-dot { background-color: #ffc107; }
		.security-low .security-dot { background-color: #dc3545; }
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<h1 class="h2 mb-0">
							<i class="fas fa-key text-primary me-2"></i>
							{{ title }}
						</h1>
						<p class="text-muted mb-0">Securely manage authentication credentials for enterprise integrations</p>
					</div>
					<div class="btn-group">
						<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCredentialModal">
							<i class="fas fa-plus me-1"></i> Add Credential
						</button>
						<a href="{{ url_for('EnterpriseIntegrationView.index') }}" class="btn btn-outline-secondary">
							<i class="fas fa-arrow-left me-1"></i> Back to Dashboard
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Credentials Summary -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card bg-primary text-white">
					<div class="card-body text-center">
						<i class="fas fa-key fa-2x mb-2"></i>
						<h4>{{ credentials|length }}</h4>
						<small>Total Credentials</small>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-success text-white">
					<div class="card-body text-center">
						<i class="fas fa-check-circle fa-2x mb-2"></i>
						<h4>{{ credentials|selectattr('is_active')|list|length }}</h4>
						<small>Active</small>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-warning text-white">
					<div class="card-body text-center">
						<i class="fas fa-clock fa-2x mb-2"></i>
						<h4>{{ credentials|selectattr('expires_soon')|list|length }}</h4>
						<small>Expiring Soon</small>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-danger text-white">
					<div class="card-body text-center">
						<i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
						<h4>{{ credentials|selectattr('is_expired')|list|length }}</h4>
						<small>Expired</small>
					</div>
				</div>
			</div>
		</div>

		<!-- Filters -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="card">
					<div class="card-body">
						<div class="row align-items-end">
							<div class="col-md-3">
								<label class="form-label">Integration Type</label>
								<select class="form-select" id="typeFilter">
									<option value="">All Types</option>
									<option value="SSO_SAML">SAML SSO</option>
									<option value="SSO_OAUTH2">OAuth2 SSO</option>
									<option value="LDAP_DIRECTORY">LDAP Directory</option>
									<option value="REST_API">REST API</option>
									<option value="DATABASE_CONNECTOR">Database</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">Authentication Method</label>
								<select class="form-select" id="authFilter">
									<option value="">All Methods</option>
									<option value="BASIC_AUTH">Basic Auth</option>
									<option value="BEARER_TOKEN">Bearer Token</option>
									<option value="API_KEY">API Key</option>
									<option value="CERTIFICATE">Certificate</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">Status</label>
								<select class="form-select" id="statusFilter">
									<option value="">All Statuses</option>
									<option value="active">Active</option>
									<option value="expired">Expired</option>
									<option value="expiring">Expiring Soon</option>
								</select>
							</div>
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100" onclick="applyFilters()">
									<i class="fas fa-filter me-1"></i> Apply Filters
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Credentials List -->
		<div class="row" id="credentialsList">
			{% for credential in credentials %}
				<div class="col-md-6 col-lg-4 mb-3 credential-item" 
					 data-type="{{ credential.integration_type }}"
					 data-auth="{{ credential.auth_method }}"
					 data-status="{{ 'expired' if credential.is_expired else ('expiring' if credential.expires_soon else 'active') }}">
					<div class="card credential-card integration-type-{{ credential.integration_type.lower().replace('_', '-') }}">
						<div class="card-header d-flex justify-content-between align-items-center">
							<div>
								<h6 class="mb-0">{{ credential.name }}</h6>
								<small class="text-muted">{{ credential.integration_type.replace('_', ' ') }}</small>
							</div>
							<div class="credential-actions">
								<div class="btn-group btn-group-sm">
									<button class="btn btn-outline-primary" onclick="editCredential('{{ credential.credential_id }}')">
										<i class="fas fa-edit"></i>
									</button>
									<button class="btn btn-outline-danger" onclick="deleteCredential('{{ credential.credential_id }}')">
										<i class="fas fa-trash"></i>
									</button>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div class="mb-2">
								<span class="badge bg-secondary">{{ credential.auth_method.replace('_', ' ') }}</span>
								{% if credential.is_expired %}
									<span class="badge bg-danger">Expired</span>
								{% elif credential.expires_soon %}
									<span class="badge bg-warning">Expires Soon</span>
								{% else %}
									<span class="badge bg-success">Active</span>
								{% endif %}
							</div>
							
							<div class="security-indicator security-{{ credential.security_level|default('medium') }}">
								<div class="security-dot"></div>
								<span>{{ credential.security_level|default('Medium')|title }} Security</span>
							</div>
							
							<div class="mt-3">
								<small class="text-muted d-block">
									Created: {{ credential.created_at[:10] if credential.created_at else 'Unknown' }}
								</small>
								{% if credential.expires_at %}
									<small class="text-muted d-block">
										Expires: {{ credential.expires_at[:10] }}
									</small>
								{% endif %}
								<small class="text-muted d-block">
									Last Used: {{ credential.last_used[:10] if credential.last_used else 'Never' }}
								</small>
							</div>
						</div>
					</div>
				</div>
			{% else %}
				<div class="col-12">
					<div class="text-center text-muted py-5">
						<i class="fas fa-key fa-3x mb-3"></i>
						<h4>No Credentials Found</h4>
						<p>Start by adding your first enterprise integration credential.</p>
						<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCredentialModal">
							<i class="fas fa-plus me-1"></i> Add First Credential
						</button>
					</div>
				</div>
			{% endfor %}
		</div>
	</div>

	<!-- Add Credential Modal -->
	<div class="modal fade" id="addCredentialModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add New Credential</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="addCredentialForm">
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Credential Name</label>
									<input type="text" class="form-control" name="name" required>
								</div>
								<div class="mb-3">
									<label class="form-label">Integration Type</label>
									<select class="form-select" name="integration_type" required onchange="updateCredentialForm()">
										<option value="">Select Type...</option>
										<option value="SSO_SAML">SAML SSO</option>
										<option value="SSO_OAUTH2">OAuth2 SSO</option>
										<option value="LDAP_DIRECTORY">LDAP Directory</option>
										<option value="REST_API">REST API</option>
										<option value="DATABASE_CONNECTOR">Database Connector</option>
									</select>
								</div>
								<div class="mb-3">
									<label class="form-label">Authentication Method</label>
									<select class="form-select" name="auth_method" required>
										<option value="">Select Method...</option>
										<option value="BASIC_AUTH">Basic Authentication</option>
										<option value="BEARER_TOKEN">Bearer Token</option>
										<option value="API_KEY">API Key</option>
										<option value="CERTIFICATE">Certificate</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Expiration Date (Optional)</label>
									<input type="date" class="form-control" name="expires_at">
								</div>
								<div class="mb-3">
									<label class="form-label">Description</label>
									<textarea class="form-control" name="description" rows="2"></textarea>
								</div>
							</div>
						</div>
						
						<div id="credentialDataContainer">
							<div class="alert alert-info">
								<i class="fas fa-info-circle me-1"></i>
								Please select an integration type to configure credential data.
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="saveCredential()">
						<i class="fas fa-save me-1"></i> Save Credential
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		function updateCredentialForm() {
			const type = document.querySelector('[name="integration_type"]').value;
			const container = document.getElementById('credentialDataContainer');
			
			if (!type) {
				container.innerHTML = `
					<div class="alert alert-info">
						<i class="fas fa-info-circle me-1"></i>
						Please select an integration type to configure credential data.
					</div>
				`;
				return;
			}
			
			let formHTML = '<h6>Credential Data</h6>';
			
			switch(type) {
				case 'SSO_SAML':
				case 'SSO_OAUTH2':
					formHTML += `
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Client ID</label>
									<input type="text" class="form-control" name="client_id" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Client Secret</label>
									<input type="password" class="form-control" name="client_secret" required>
								</div>
							</div>
						</div>
					`;
					break;
				case 'LDAP_DIRECTORY':
					formHTML += `
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Bind DN</label>
									<input type="text" class="form-control" name="bind_dn" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Bind Password</label>
									<input type="password" class="form-control" name="bind_password" required>
								</div>
							</div>
						</div>
					`;
					break;
				case 'REST_API':
					formHTML += `
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">API Key</label>
									<input type="text" class="form-control" name="api_key" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">API Secret (Optional)</label>
									<input type="password" class="form-control" name="api_secret">
								</div>
							</div>
						</div>
					`;
					break;
				case 'DATABASE_CONNECTOR':
					formHTML += `
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Username</label>
									<input type="text" class="form-control" name="username" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Password</label>
									<input type="password" class="form-control" name="password" required>
								</div>
							</div>
						</div>
						<div class="mb-3">
							<label class="form-label">Connection String (Optional)</label>
							<input type="text" class="form-control" name="connection_string">
						</div>
					`;
					break;
			}
			
			container.innerHTML = formHTML;
		}
		
		async function saveCredential() {
			const form = document.getElementById('addCredentialForm');
			const formData = new FormData(form);
			
			// Build credential data object based on integration type
			const credentialData = {};
			const integrationType = formData.get('integration_type');
			
			switch(integrationType) {
				case 'SSO_SAML':
				case 'SSO_OAUTH2':
					credentialData.client_id = formData.get('client_id');
					credentialData.client_secret = formData.get('client_secret');
					break;
				case 'LDAP_DIRECTORY':
					credentialData.bind_dn = formData.get('bind_dn');
					credentialData.bind_password = formData.get('bind_password');
					break;
				case 'REST_API':
					credentialData.api_key = formData.get('api_key');
					if (formData.get('api_secret')) {
						credentialData.api_secret = formData.get('api_secret');
					}
					break;
				case 'DATABASE_CONNECTOR':
					credentialData.username = formData.get('username');
					credentialData.password = formData.get('password');
					if (formData.get('connection_string')) {
						credentialData.connection_string = formData.get('connection_string');
					}
					break;
			}
			
			const payload = {
				name: formData.get('name'),
				integration_type: integrationType,
				auth_method: formData.get('auth_method'),
				credential_data: credentialData,
				expires_at: formData.get('expires_at') || null,
				description: formData.get('description')
			};
			
			try {
				const response = await fetch('/enterprise/api/credentials/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert('Credential saved successfully!');
					bootstrap.Modal.getInstance(document.getElementById('addCredentialModal')).hide();
					location.reload();
				} else {
					alert('Error saving credential: ' + result.error);
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		}
		
		function applyFilters() {
			const typeFilter = document.getElementById('typeFilter').value;
			const authFilter = document.getElementById('authFilter').value;
			const statusFilter = document.getElementById('statusFilter').value;
			
			const items = document.querySelectorAll('.credential-item');
			
			items.forEach(item => {
				let show = true;
				
				if (typeFilter && item.dataset.type !== typeFilter) show = false;
				if (authFilter && item.dataset.auth !== authFilter) show = false;
				if (statusFilter && item.dataset.status !== statusFilter) show = false;
				
				item.style.display = show ? 'block' : 'none';
			});
		}
		
		async function deleteCredential(credentialId) {
			if (!confirm('Are you sure you want to delete this credential?')) return;
			
			try {
				const response = await fetch(`/enterprise/api/credentials/${credentialId}/`, {
					method: 'DELETE'
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert('Credential deleted successfully!');
					location.reload();
				} else {
					alert('Error deleting credential: ' + result.error);
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		}
		
		function editCredential(credentialId) {
			// Implementation would load credential data for editing
			alert(`Edit credential ${credentialId} - feature would be implemented here`);
		}
	</script>
</body>
</html>