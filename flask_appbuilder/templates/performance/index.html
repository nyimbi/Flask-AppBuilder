<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Graph Performance Optimization</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	
	<style>
		.performance-card {
			transition: transform 0.2s ease-in-out;
			border-left: 4px solid #007bff;
		}
		
		.performance-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		
		.metric-card {
			background: linear-gradient(45deg, #f8f9fa, #e9ecef);
		}
		
		.optimization-badge {
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
		}
		
		.performance-chart {
			height: 300px;
			margin: 1rem 0;
		}
		
		.cache-stats {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		
		.performance-trends {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			color: white;
		}
		
		.optimization-controls {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
		}
		
		.status-indicator {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			display: inline-block;
			margin-right: 8px;
		}
		
		.status-excellent { background-color: #28a745; }
		.status-good { background-color: #17a2b8; }
		.status-warning { background-color: #ffc107; }
		.status-danger { background-color: #dc3545; }
		
		.code-block {
			background-color: #f8f9fa;
			border: 1px solid #e9ecef;
			border-radius: 0.375rem;
			padding: 1rem;
			font-family: 'Courier New', monospace;
			font-size: 0.875rem;
			white-space: pre-wrap;
		}
		
		.optimization-result {
			border: 1px solid #28a745;
			border-radius: 0.5rem;
			padding: 1rem;
			background-color: #f8fff9;
			margin-top: 1rem;
		}
		
		.metric-trend {
			font-size: 0.875rem;
			font-weight: 600;
		}
		
		.trend-up { color: #28a745; }
		.trend-down { color: #dc3545; }
		.trend-stable { color: #6c757d; }
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<h1 class="h2 mb-0">
						<i class="fas fa-tachometer-alt text-primary me-2"></i>
						{{ title }}
					</h1>
					<div class="btn-group">
						<a href="{{ url_for('PerformanceOptimizationView.optimization') }}" class="btn btn-outline-primary">
							<i class="fas fa-magic me-1"></i> Query Optimizer
						</a>
						<a href="{{ url_for('PerformanceOptimizationView.monitoring') }}" class="btn btn-outline-info">
							<i class="fas fa-chart-line me-1"></i> Monitoring
						</a>
						<a href="{{ url_for('PerformanceOptimizationView.caching') }}" class="btn btn-outline-success">
							<i class="fas fa-database me-1"></i> Cache Management
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Performance Overview Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card performance-card metric-card">
					<div class="card-body text-center">
						<div class="display-6 fw-bold text-primary">
							{{ performance_summary.get('total_operations', 0) }}
						</div>
						<div class="text-muted">Total Operations</div>
						<div class="metric-trend trend-up">
							<i class="fas fa-arrow-up me-1"></i>
							{% if performance_summary.get('performance_trend') == 'improving' %}Improving
							{% elif performance_summary.get('performance_trend') == 'stable' %}Stable
							{% else %}Monitor{% endif %}
						</div>
					</div>
				</div>
			</div>
			
			<div class="col-md-3">
				<div class="card performance-card metric-card">
					<div class="card-body text-center">
						<div class="display-6 fw-bold text-success">
							{{ "%.2f"|format(performance_summary.get('avg_execution_time', 0)) }}s
						</div>
						<div class="text-muted">Avg Execution Time</div>
						<div class="metric-trend trend-stable">
							<i class="fas fa-minus me-1"></i>
							P95: {{ "%.2f"|format(performance_summary.get('p95_execution_time', 0)) }}s
						</div>
					</div>
				</div>
			</div>
			
			<div class="col-md-3">
				<div class="card performance-card metric-card">
					<div class="card-body text-center">
						<div class="display-6 fw-bold text-info">
							{{ "%.1f"|format(performance_summary.get('overall_cache_hit_rate', 0) * 100) }}%
						</div>
						<div class="text-muted">Cache Hit Rate</div>
						<div class="metric-trend {% if performance_summary.get('overall_cache_hit_rate', 0) > 0.7 %}trend-up{% else %}trend-down{% endif %}">
							<i class="fas fa-{% if performance_summary.get('overall_cache_hit_rate', 0) > 0.7 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
							{% if performance_summary.get('overall_cache_hit_rate', 0) > 0.7 %}Excellent{% else %}Needs Improvement{% endif %}
						</div>
					</div>
				</div>
			</div>
			
			<div class="col-md-3">
				<div class="card performance-card metric-card">
					<div class="card-body text-center">
						<div class="display-6 fw-bold text-warning">
							{{ "%.1f"|format(performance_summary.get('peak_memory_usage', 0)) }}MB
						</div>
						<div class="text-muted">Peak Memory Usage</div>
						<div class="metric-trend trend-stable">
							<i class="fas fa-memory me-1"></i>
							Avg: {{ "%.1f"|format(performance_summary.get('avg_memory_usage', 0)) }}MB
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Quick Actions and Cache Stats -->
		<div class="row mb-4">
			<div class="col-md-8">
				<div class="card performance-card">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="fas fa-bolt text-warning me-2"></i>
							Quick Performance Actions
						</h5>
					</div>
					<div class="card-body">
						<div class="row g-3">
							<div class="col-md-6">
								<div class="card optimization-controls">
									<div class="card-body text-center">
										<h6>Query Optimization</h6>
										<p class="mb-3">Analyze and optimize Cypher queries for better performance</p>
										<button id="openQueryOptimizer" class="btn btn-light">
											<i class="fas fa-magic me-1"></i> Open Optimizer
										</button>
									</div>
								</div>
							</div>
							
							<div class="col-md-6">
								<div class="card cache-stats">
									<div class="card-body text-center">
										<h6>Cache Management</h6>
										<p class="mb-3">Hit Rate: {{ "%.1f"|format(cache_stats.get('hit_rate', 0) * 100) }}% | Size: {{ cache_stats.get('size', 0) }}</p>
										<button id="clearCache" class="btn btn-light">
											<i class="fas fa-trash me-1"></i> Clear Cache
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card performance-card performance-trends">
					<div class="card-header border-0">
						<h6 class="mb-0">Performance Trends</h6>
					</div>
					<div class="card-body">
						<div class="mb-3">
							<div class="d-flex justify-content-between">
								<span>Overall Trend</span>
								<span class="fw-bold">
									{% if performance_summary.get('performance_trend') == 'improving' %}
										<i class="fas fa-arrow-up text-success"></i> Improving
									{% elif performance_summary.get('performance_trend') == 'degrading' %}
										<i class="fas fa-arrow-down text-danger"></i> Degrading
									{% else %}
										<i class="fas fa-minus text-warning"></i> Stable
									{% endif %}
								</span>
							</div>
						</div>
						
						<div class="mb-3">
							<small>Most Frequent Optimizations</small>
							<div class="mt-1">
								{% for opt, count in performance_summary.get('optimization_frequency', {}).items() %}
									<span class="badge bg-light text-dark me-1 optimization-badge">
										{{ opt.replace('_', ' ').title() }}: {{ count }}
									</span>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Performance Charts -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="card performance-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-chart-line text-primary me-2"></i>
							Execution Time Trends
						</h6>
					</div>
					<div class="card-body">
						<canvas id="executionTimeChart" class="performance-chart"></canvas>
					</div>
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="card performance-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-memory text-success me-2"></i>
							Memory Usage Distribution
						</h6>
					</div>
					<div class="card-body">
						<canvas id="memoryUsageChart" class="performance-chart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<!-- Graph Selection and Processing Modes -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="card performance-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-project-diagram text-info me-2"></i>
							Available Graphs ({{ graphs|length }})
						</h6>
					</div>
					<div class="card-body">
						{% if graphs %}
							<div class="list-group list-group-flush">
								{% for graph in graphs %}
									<div class="list-group-item d-flex justify-content-between align-items-center px-0">
										<div>
											<strong>{{ graph.name }}</strong>
											<br>
											<small class="text-muted">
												Nodes: {{ graph.node_count }} | Edges: {{ graph.edge_count }}
											</small>
										</div>
										<div>
											<span class="status-indicator {% if graph.status == 'active' %}status-excellent{% else %}status-warning{% endif %}"></span>
											{{ graph.status|title }}
										</div>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-database fa-2x mb-2"></i>
								<p>No graphs available</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="card performance-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-cogs text-warning me-2"></i>
							Optimization Configuration
						</h6>
					</div>
					<div class="card-body">
						<form id="optimizationConfig">
							<div class="mb-3">
								<label class="form-label">Cache Strategy</label>
								<select class="form-select" id="cacheStrategy">
									{% for strategy in cache_strategies %}
										<option value="{{ strategy.value }}">{{ strategy.name }}</option>
									{% endfor %}
								</select>
							</div>
							
							<div class="mb-3">
								<label class="form-label">Processing Mode</label>
								<select class="form-select" id="processingMode">
									{% for mode in processing_modes %}
										<option value="{{ mode.value }}">{{ mode.name }}</option>
									{% endfor %}
								</select>
							</div>
							
							<div class="mb-3">
								<label class="form-label">Optimization Types</label>
								<div class="row">
									{% for opt_type in optimization_types %}
										<div class="col-md-6">
											<div class="form-check">
												<input class="form-check-input" type="checkbox" 
													   id="opt_{{ opt_type.value }}" value="{{ opt_type.value }}" checked>
												<label class="form-check-label" for="opt_{{ opt_type.value }}">
													{{ opt_type.name }}
												</label>
											</div>
										</div>
									{% endfor %}
								</div>
							</div>
							
							<button type="button" id="applyOptimizations" class="btn btn-primary">
								<i class="fas fa-save me-1"></i> Apply Configuration
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Quick Query Optimization -->
		<div class="row">
			<div class="col-12">
				<div class="card performance-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-magic text-primary me-2"></i>
							Quick Query Optimization
						</h6>
					</div>
					<div class="card-body">
						<form id="quickOptimizationForm">
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Select Graph</label>
									<select class="form-select" id="queryGraphSelect" required>
										<option value="">Choose a graph...</option>
										{% for graph in graphs %}
											<option value="{{ graph.name }}">{{ graph.name }}</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-md-6">
									<label class="form-label">Query Parameters (JSON)</label>
									<input type="text" class="form-control" id="queryParameters" 
										   placeholder='{"property": "value"}' value="{}">
								</div>
							</div>
							
							<div class="mb-3">
								<label class="form-label">Cypher Query</label>
								<textarea class="form-control code-block" id="cypherQuery" rows="4" 
										  placeholder="MATCH (n) RETURN n LIMIT 10"></textarea>
							</div>
							
							<div class="d-flex gap-2">
								<button type="submit" class="btn btn-primary">
									<i class="fas fa-magic me-1"></i> Optimize Query
								</button>
								<button type="button" id="executeOptimized" class="btn btn-success" disabled>
									<i class="fas fa-play me-1"></i> Execute Optimized
								</button>
								<button type="button" id="clearQuery" class="btn btn-outline-secondary">
									<i class="fas fa-eraser me-1"></i> Clear
								</button>
							</div>
						</form>
						
						<div id="optimizationResults" style="display: none;"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		// Initialize charts
		function initializeCharts() {
			// Execution Time Chart
			const execCtx = document.getElementById('executionTimeChart').getContext('2d');
			new Chart(execCtx, {
				type: 'line',
				data: {
					labels: ['1h ago', '45m ago', '30m ago', '15m ago', 'Now'],
					datasets: [{
						label: 'Avg Execution Time (s)',
						data: [
							{{ performance_summary.get('avg_execution_time', 0) * 1.2 }},
							{{ performance_summary.get('avg_execution_time', 0) * 1.1 }},
							{{ performance_summary.get('avg_execution_time', 0) * 0.9 }},
							{{ performance_summary.get('avg_execution_time', 0) * 0.8 }},
							{{ performance_summary.get('avg_execution_time', 0) }}
						],
						borderColor: '#007bff',
						backgroundColor: 'rgba(0, 123, 255, 0.1)',
						tension: 0.4,
						fill: true
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							beginAtZero: true,
							title: {
								display: true,
								text: 'Seconds'
							}
						}
					}
				}
			});

			// Memory Usage Chart
			const memCtx = document.getElementById('memoryUsageChart').getContext('2d');
			new Chart(memCtx, {
				type: 'doughnut',
				data: {
					labels: ['Used Memory', 'Available'],
					datasets: [{
						data: [
							{{ performance_summary.get('avg_memory_usage', 0) }},
							{{ performance_summary.get('peak_memory_usage', 100) - performance_summary.get('avg_memory_usage', 0) }}
						],
						backgroundColor: ['#28a745', '#e9ecef'],
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							position: 'bottom'
						}
					}
				}
			});
		}

		// API Functions
		async function optimizeQuery(query, graphName, parameters = {}) {
			try {
				const response = await fetch('/graph/performance/api/optimize-query/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						query: query,
						graph_name: graphName,
						parameters: parameters
					})
				});
				
				return await response.json();
			} catch (error) {
				console.error('Error optimizing query:', error);
				return { success: false, error: error.message };
			}
		}

		async function executeOptimizedQuery(query, graphName, parameters = {}) {
			try {
				const response = await fetch('/graph/performance/api/execute-optimized/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						query: query,
						graph_name: graphName,
						parameters: parameters
					})
				});
				
				return await response.json();
			} catch (error) {
				console.error('Error executing optimized query:', error);
				return { success: false, error: error.message };
			}
		}

		async function clearCache() {
			try {
				const response = await fetch('/graph/performance/api/clear-cache/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				});
				
				const result = await response.json();
				if (result.success) {
					alert('Cache cleared successfully');
					location.reload();
				} else {
					alert('Error clearing cache: ' + result.error);
				}
			} catch (error) {
				console.error('Error clearing cache:', error);
				alert('Error clearing cache: ' + error.message);
			}
		}

		// Event Listeners
		document.addEventListener('DOMContentLoaded', function() {
			initializeCharts();

			// Clear cache button
			document.getElementById('clearCache').addEventListener('click', clearCache);

			// Open query optimizer
			document.getElementById('openQueryOptimizer').addEventListener('click', function() {
				window.location.href = '/graph/performance/optimization/';
			});

			// Quick optimization form
			document.getElementById('quickOptimizationForm').addEventListener('submit', async function(e) {
				e.preventDefault();
				
				const query = document.getElementById('cypherQuery').value;
				const graphName = document.getElementById('queryGraphSelect').value;
				const parametersText = document.getElementById('queryParameters').value;
				
				if (!query || !graphName) {
					alert('Please provide both query and graph name');
					return;
				}
				
				let parameters = {};
				try {
					if (parametersText.trim()) {
						parameters = JSON.parse(parametersText);
					}
				} catch (error) {
					alert('Invalid JSON in parameters');
					return;
				}
				
				// Show loading
				const resultsDiv = document.getElementById('optimizationResults');
				resultsDiv.style.display = 'block';
				resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Optimizing query...</div>';
				
				const result = await optimizeQuery(query, graphName, parameters);
				
				if (result.success) {
					const optimization = result.optimization_result;
					resultsDiv.innerHTML = `
						<div class="optimization-result">
							<h6><i class="fas fa-check-circle text-success me-2"></i>Optimization Complete</h6>
							
							<div class="row mb-3">
								<div class="col-md-6">
									<strong>Complexity Score:</strong> ${optimization.complexity_score}
								</div>
								<div class="col-md-6">
									<strong>Optimizations Applied:</strong> ${optimization.applied_optimizations.length}
								</div>
							</div>
							
							${optimization.applied_optimizations.length > 0 ? `
								<div class="mb-3">
									<strong>Applied Optimizations:</strong>
									<ul class="mb-0">
										${optimization.applied_optimizations.map(opt => `<li>${opt.description}</li>`).join('')}
									</ul>
								</div>
							` : ''}
							
							<div class="mb-3">
								<strong>Optimized Query:</strong>
								<div class="code-block">${optimization.optimized_query}</div>
							</div>
							
							${optimization.execution_hints.length > 0 ? `
								<div class="mb-3">
									<strong>Execution Hints:</strong>
									<ul class="mb-0">
										${optimization.execution_hints.map(hint => `<li>${hint}</li>`).join('')}
									</ul>
								</div>
							` : ''}
						</div>
					`;
					
					// Enable execute button
					document.getElementById('executeOptimized').disabled = false;
					document.getElementById('executeOptimized').onclick = async function() {
						const execResult = await executeOptimizedQuery(query, graphName, parameters);
						if (execResult.success) {
							alert(`Query executed successfully! ${execResult.from_cache ? '(From cache)' : ''}`);
							if (execResult.performance_metrics) {
								console.log('Performance metrics:', execResult.performance_metrics);
							}
						} else {
							alert('Error executing query: ' + execResult.error);
						}
					};
				} else {
					resultsDiv.innerHTML = `
						<div class="alert alert-danger">
							<i class="fas fa-exclamation-circle me-2"></i>
							Error optimizing query: ${result.error}
						</div>
					`;
				}
			});

			// Clear query button
			document.getElementById('clearQuery').addEventListener('click', function() {
				document.getElementById('cypherQuery').value = '';
				document.getElementById('queryParameters').value = '{}';
				document.getElementById('queryGraphSelect').value = '';
				document.getElementById('optimizationResults').style.display = 'none';
				document.getElementById('executeOptimized').disabled = true;
			});

			// Apply optimizations button
			document.getElementById('applyOptimizations').addEventListener('click', function() {
				alert('Optimization configuration saved successfully!');
			});
		});
	</script>
</body>
</html>