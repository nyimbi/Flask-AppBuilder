{% extends "appbuilder/general/model/base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h2>{{ _("Pending Approvals") }}</h2>
      <p class="text-muted">{{ _("Transactions requiring your approval") }}</p>
      
      {% if pending_transactions %}
        <div class="card">
          <div class="card-header">
            <h4>{{ _("Approval Queue") }}</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>{{ _("Transaction ID") }}</th>
                    <th>{{ _("Type") }}</th>
                    <th>{{ _("Amount") }}</th>
                    <th>{{ _("Description") }}</th>
                    <th>{{ _("Step") }}</th>
                    <th>{{ _("Required Role") }}</th>
                    <th>{{ _("Date") }}</th>
                    <th>{{ _("Actions") }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for approval in pending_transactions %}
                  <tr>
                    <td>
                      <a href="{{ url_for('ApprovalWorkflowView.approval_history', transaction_id=approval.transaction.id) }}">
                        #{{ approval.transaction.id }}
                      </a>
                    </td>
                    <td>
                      <span class="badge badge-secondary">{{ approval.transaction.transaction_type.title() }}</span>
                    </td>
                    <td>
                      <span class="text-{% if approval.transaction.transaction_type == 'expense' %}danger{% else %}success{% endif %}">
                        ${{ "%.2f"|format(approval.transaction.amount) }}
                      </span>
                    </td>
                    <td>{{ approval.transaction.description or _("No description") }}</td>
                    <td>
                      <span class="badge badge-info">{{ approval.step_name }}</span>
                      {% if approval.requires_mfa %}
                        <span class="badge badge-warning ml-1">{{ _("MFA Required") }}</span>
                      {% endif %}
                    </td>
                    <td>{{ approval.required_role }}</td>
                    <td>{{ approval.transaction.transaction_date.strftime('%Y-%m-%d %H:%M') if approval.transaction.transaction_date else _("N/A") }}</td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <!-- Approve Button -->
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#approveModal{{ approval.transaction.id }}">
                          <i class="fa fa-check"></i> {{ _("Approve") }}
                        </button>
                        
                        <!-- Reject Button -->
                        <a href="{{ url_for('ApprovalWorkflowView.reject_transaction_form', transaction_id=approval.transaction.id) }}" class="btn btn-danger">
                          <i class="fa fa-times"></i> {{ _("Reject") }}
                        </a>
                        
                        <!-- History Button -->
                        <a href="{{ url_for('ApprovalWorkflowView.approval_history', transaction_id=approval.transaction.id) }}" class="btn btn-info">
                          <i class="fa fa-history"></i> {{ _("History") }}
                        </a>
                      </div>
                      
                      <!-- Approval Modal -->
                      <div class="modal fade" id="approveModal{{ approval.transaction.id }}" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                          <form method="POST" action="{{ url_for('ApprovalWorkflowView.approve_transaction_step', transaction_id=approval.transaction.id, step=approval.step) }}">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">{{ _("Approve Transaction") }} #{{ approval.transaction.id }}</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                  <span>&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <div class="form-group">
                                  <label>{{ _("Transaction Details") }}</label>
                                  <div class="card">
                                    <div class="card-body">
                                      <p><strong>{{ _("Type") }}:</strong> {{ approval.transaction.transaction_type.title() }}</p>
                                      <p><strong>{{ _("Amount") }}:</strong> ${{ "%.2f"|format(approval.transaction.amount) }}</p>
                                      <p><strong>{{ _("Description") }}:</strong> {{ approval.transaction.description or _("No description") }}</p>
                                      <p><strong>{{ _("Approval Step") }}:</strong> {{ approval.step_name }}</p>
                                    </div>
                                  </div>
                                </div>
                                
                                <div class="form-group">
                                  <label for="comments{{ approval.transaction.id }}">{{ _("Comments") }} ({{ _("Optional") }})</label>
                                  <textarea class="form-control" id="comments{{ approval.transaction.id }}" name="comments" rows="3" placeholder="{{ _('Add approval comments...') }}"></textarea>
                                </div>
                                
                                {% if approval.requires_mfa %}
                                <div class="alert alert-warning">
                                  <i class="fa fa-shield"></i>
                                  {{ _("This transaction requires multi-factor authentication. Please ensure your MFA session is valid.") }}
                                </div>
                                {% endif %}
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
                                <button type="submit" class="btn btn-success">
                                  <i class="fa fa-check"></i> {{ _("Approve") }}
                                </button>
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% else %}
        <div class="card">
          <div class="card-body text-center">
            <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
            <h4>{{ _("No Pending Approvals") }}</h4>
            <p class="text-muted">{{ _("You don't have any transactions requiring approval at this time.") }}</p>
          </div>
        </div>
      {% endif %}
      
      <!-- User Role Information -->
      <div class="card mt-4">
        <div class="card-header">
          <h5>{{ _("Your Approval Roles") }}</h5>
        </div>
        <div class="card-body">
          {% if user_roles %}
            {% for role in user_roles %}
              <span class="badge badge-primary mr-2">{{ role }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">{{ _("No approval roles assigned") }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
$(document).ready(function() {
    // Auto-refresh every 30 seconds for real-time updates
    setTimeout(function() {
        location.reload();
    }, 30000);
    
    // Add confirmation to approval buttons
    $('button[data-target*="approveModal"]').click(function(e) {
        var transactionId = $(this).data('target').replace('#approveModal', '');
        console.log('Preparing to approve transaction: ' + transactionId);
    });
});
</script>
{% endblock %}