<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ title }} - Graph Data Exchange</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	
	<style>
		.data-exchange-card {
			transition: transform 0.2s ease-in-out;
			border-left: 4px solid #28a745;
		}
		
		.data-exchange-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		
		.job-status-pending { color: #ffc107; }
		.job-status-processing { color: #007bff; }
		.job-status-completed { color: #28a745; }
		.job-status-failed { color: #dc3545; }
		.job-status-cancelled { color: #6c757d; }
		
		.format-card {
			background: linear-gradient(45deg, #f8f9fa, #e9ecef);
			border: 1px solid #dee2e6;
			border-radius: 0.5rem;
			padding: 1rem;
			margin-bottom: 1rem;
			transition: all 0.2s ease-in-out;
		}
		
		.format-card:hover {
			background: linear-gradient(45deg, #e9ecef, #f8f9fa);
			transform: translateY(-1px);
		}
		
		.format-card.selected {
			border-color: #007bff;
			background: linear-gradient(45deg, #e3f2fd, #f0f8ff);
		}
		
		.job-progress {
			height: 8px;
			border-radius: 4px;
			background-color: #e9ecef;
			overflow: hidden;
		}
		
		.job-progress-bar {
			height: 100%;
			transition: width 0.3s ease;
		}
		
		.job-card {
			border-left: 4px solid;
			margin-bottom: 1rem;
		}
		
		.job-card.export { border-left-color: #007bff; }
		.job-card.import { border-left-color: #28a745; }
		
		.stats-card {
			text-align: center;
			padding: 1.5rem;
		}
		
		.stats-number {
			font-size: 2.5rem;
			font-weight: bold;
			line-height: 1;
		}
		
		.stats-label {
			font-size: 0.875rem;
			color: #6c757d;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		
		.upload-area {
			border: 2px dashed #dee2e6;
			border-radius: 0.5rem;
			padding: 2rem;
			text-align: center;
			background-color: #f8f9fa;
			transition: all 0.2s ease-in-out;
		}
		
		.upload-area:hover {
			border-color: #007bff;
			background-color: #f0f8ff;
		}
		
		.upload-area.dragover {
			border-color: #28a745;
			background-color: #f0fff0;
		}
		
		.export-actions {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		
		.import-actions {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			color: white;
		}
		
		.job-management {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
		}
		
		.format-badge {
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
			border-radius: 0.25rem;
		}
		
		.auto-refresh {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
		}
		
		.job-metadata {
			font-size: 0.875rem;
			color: #6c757d;
		}
		
		.quick-action-btn {
			border-radius: 50px;
			padding: 0.75rem 1.5rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
	</style>
</head>

<body>
	<div class="container-fluid p-4">
		<!-- Auto-refresh toggle -->
		<div class="auto-refresh">
			<div class="form-check form-switch">
				<input class="form-check-input" type="checkbox" id="autoRefresh" checked>
				<label class="form-check-label" for="autoRefresh">
					<small>Auto-refresh</small>
				</label>
			</div>
		</div>

		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<h1 class="h2 mb-0">
						<i class="fas fa-exchange-alt text-success me-2"></i>
						{{ title }}
					</h1>
					<div class="btn-group">
						<a href="{{ url_for('ImportExportView.export') }}" class="btn btn-primary">
							<i class="fas fa-upload me-1"></i> Export Data
						</a>
						<a href="{{ url_for('ImportExportView.import_data') }}" class="btn btn-success">
							<i class="fas fa-download me-1"></i> Import Data
						</a>
						<a href="{{ url_for('ImportExportView.jobs') }}" class="btn btn-info">
							<i class="fas fa-tasks me-1"></i> Manage Jobs
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Statistics Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card data-exchange-card stats-card">
					<div class="stats-number text-primary">{{ job_stats.total_jobs }}</div>
					<div class="stats-label">Total Jobs</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card data-exchange-card stats-card">
					<div class="stats-number text-warning">{{ job_stats.active_jobs }}</div>
					<div class="stats-label">Active Jobs</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card data-exchange-card stats-card">
					<div class="stats-number text-success">{{ job_stats.completed_jobs }}</div>
					<div class="stats-label">Completed</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card data-exchange-card stats-card">
					<div class="stats-number text-danger">{{ job_stats.failed_jobs }}</div>
					<div class="stats-label">Failed</div>
				</div>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="row mb-4">
			<div class="col-md-4">
				<div class="card data-exchange-card export-actions">
					<div class="card-body text-center">
						<i class="fas fa-upload fa-3x mb-3"></i>
						<h5>Export Graph Data</h5>
						<p class="mb-3">Export your graph data to various formats including GraphML, CSV, JSON, and Cypher scripts.</p>
						<a href="{{ url_for('ImportExportView.export') }}" class="btn btn-light quick-action-btn">
							Start Export
						</a>
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card data-exchange-card import-actions">
					<div class="card-body text-center">
						<i class="fas fa-download fa-3x mb-3"></i>
						<h5>Import Graph Data</h5>
						<p class="mb-3">Import graph data from external sources with support for multiple formats and field mapping.</p>
						<a href="{{ url_for('ImportExportView.import_data') }}" class="btn btn-light quick-action-btn">
							Start Import
						</a>
					</div>
				</div>
			</div>
			
			<div class="col-md-4">
				<div class="card data-exchange-card job-management">
					<div class="card-body text-center">
						<i class="fas fa-tasks fa-3x mb-3"></i>
						<h5>Job Management</h5>
						<p class="mb-3">Monitor and manage your import/export jobs with real-time progress tracking and history.</p>
						<a href="{{ url_for('ImportExportView.jobs') }}" class="btn btn-light quick-action-btn">
							Manage Jobs
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Active Jobs -->
		{% if active_jobs %}
		<div class="row mb-4">
			<div class="col-12">
				<div class="card data-exchange-card">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="fas fa-spinner text-warning me-2"></i>
							Active Jobs ({{ active_jobs|length }})
						</h5>
					</div>
					<div class="card-body">
						<div class="row">
							{% for job in active_jobs %}
							<div class="col-md-6 mb-3">
								<div class="card job-card {{ job.job_type }}">
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-start mb-2">
											<div>
												<h6 class="mb-1">
													<i class="fas fa-{% if job.job_type == 'export' %}upload{% else %}download{% endif %} me-1"></i>
													{{ job.job_type|title }} - {{ job.format|title }}
												</h6>
												<small class="text-muted">Job ID: {{ job.job_id[:8] }}...</small>
											</div>
											<span class="badge bg-{% if job.status == 'processing' %}primary{% elif job.status == 'pending' %}warning{% else %}secondary{% endif %}">
												{{ job.status|title }}
											</span>
										</div>
										
										<div class="job-metadata mb-2">
											<div><strong>Source:</strong> {{ job.source }}</div>
											<div><strong>Target:</strong> {{ job.target }}</div>
										</div>
										
										<div class="job-progress mb-2">
											<div class="job-progress-bar bg-{% if job.status == 'processing' %}primary{% elif job.status == 'completed' %}success{% elif job.status == 'failed' %}danger{% else %}warning{% endif %}" 
												 style="width: {{ job.progress }}%"></div>
										</div>
										
										<div class="d-flex justify-content-between align-items-center">
											<small class="text-muted">{{ job.progress }}% complete</small>
											<button class="btn btn-sm btn-outline-danger" onclick="cancelJob('{{ job.job_id }}')">
												<i class="fas fa-stop me-1"></i> Cancel
											</button>
										</div>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endif %}

		<!-- Available Graphs and Formats -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="card data-exchange-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-project-diagram text-info me-2"></i>
							Available Graphs ({{ graphs|length }})
						</h6>
					</div>
					<div class="card-body">
						{% if graphs %}
							<div class="list-group list-group-flush">
								{% for graph in graphs %}
									<div class="list-group-item d-flex justify-content-between align-items-center px-0">
										<div>
											<strong>{{ graph.name }}</strong>
											<br>
											<small class="text-muted">
												Nodes: {{ graph.node_count }} | Edges: {{ graph.edge_count }}
											</small>
										</div>
										<div class="btn-group btn-group-sm">
											<button class="btn btn-outline-primary" onclick="quickExport('{{ graph.name }}')">
												<i class="fas fa-upload"></i>
											</button>
										</div>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-database fa-2x mb-2"></i>
								<p>No graphs available</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="card data-exchange-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-file-alt text-success me-2"></i>
							Supported Formats
						</h6>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6">
								<h6>Export Formats</h6>
								{% for format_key, format_info in export_formats.items() %}
									<div class="format-badge bg-primary text-white mb-1 me-1">
										{{ format_info.name }}
									</div>
								{% endfor %}
							</div>
							<div class="col-md-6">
								<h6>Import Formats</h6>
								{% for format_key, format_info in import_formats.items() %}
									<div class="format-badge bg-success text-white mb-1 me-1">
										{{ format_info.name }}
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Recent Job History -->
		<div class="row">
			<div class="col-12">
				<div class="card data-exchange-card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="fas fa-history text-secondary me-2"></i>
							Recent Jobs
						</h6>
					</div>
					<div class="card-body">
						{% if job_history %}
							<div class="table-responsive">
								<table class="table table-hover">
									<thead>
										<tr>
											<th>Job ID</th>
											<th>Type</th>
											<th>Format</th>
											<th>Source/Target</th>
											<th>Status</th>
											<th>Progress</th>
											<th>Created</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for job in job_history[:10] %}
											<tr>
												<td>
													<code>{{ job.job_id[:8] }}...</code>
												</td>
												<td>
													<i class="fas fa-{% if job.job_type == 'export' %}upload text-primary{% else %}download text-success{% endif %} me-1"></i>
													{{ job.job_type|title }}
												</td>
												<td>
													<span class="format-badge bg-secondary text-white">
														{{ job.format|upper }}
													</span>
												</td>
												<td>
													<small>
														<div><strong>From:</strong> {{ job.source }}</div>
														<div><strong>To:</strong> {{ job.target }}</div>
													</small>
												</td>
												<td>
													<span class="job-status-{{ job.status }}">
														<i class="fas fa-{% if job.status == 'completed' %}check-circle{% elif job.status == 'failed' %}exclamation-circle{% elif job.status == 'processing' %}spinner fa-spin{% elif job.status == 'cancelled' %}ban{% else %}clock{% endif %} me-1"></i>
														{{ job.status|title }}
													</span>
												</td>
												<td>
													<div class="job-progress" style="width: 80px;">
														<div class="job-progress-bar bg-{% if job.status == 'completed' %}success{% elif job.status == 'failed' %}danger{% else %}primary{% endif %}" 
															 style="width: {{ job.progress }}%"></div>
													</div>
													<small>{{ job.progress }}%</small>
												</td>
												<td>
													<small>{{ job.created_at[:19] }}</small>
												</td>
												<td>
													<div class="btn-group btn-group-sm">
														<button class="btn btn-outline-info" onclick="viewJobDetails('{{ job.job_id }}')">
															<i class="fas fa-eye"></i>
														</button>
														{% if job.job_type == 'export' and job.status == 'completed' %}
															<button class="btn btn-outline-success" onclick="downloadExport('{{ job.job_id }}')">
																<i class="fas fa-download"></i>
															</button>
														{% endif %}
													</div>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<div class="text-center text-muted py-3">
								<i class="fas fa-clock fa-2x mb-2"></i>
								<p>No job history available</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Job Details Modal -->
	<div class="modal fade" id="jobDetailsModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Job Details</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="jobDetailsContent">
					<div class="text-center">
						<i class="fas fa-spinner fa-spin fa-2x"></i>
						<p class="mt-2">Loading job details...</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Quick Export Modal -->
	<div class="modal fade" id="quickExportModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Quick Export</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="quickExportForm">
						<input type="hidden" id="exportGraphName">
						
						<div class="mb-3">
							<label class="form-label">Export Format</label>
							<select class="form-select" id="exportFormat" required>
								{% for format_key, format_info in export_formats.items() %}
									<option value="{{ format_key }}">{{ format_info.name }} - {{ format_info.description }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Filename</label>
							<input type="text" class="form-control" id="exportFilename" required>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="startQuickExport()">
						<i class="fas fa-upload me-1"></i> Start Export
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script>
		// Auto-refresh functionality
		let autoRefreshInterval;
		
		function toggleAutoRefresh() {
			const checkbox = document.getElementById('autoRefresh');
			if (checkbox.checked) {
				autoRefreshInterval = setInterval(refreshJobStatus, 5000); // Refresh every 5 seconds
			} else {
				if (autoRefreshInterval) {
					clearInterval(autoRefreshInterval);
				}
			}
		}
		
		function refreshJobStatus() {
			// Refresh active jobs
			fetch('/graph/import-export/api/jobs/?type=active')
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						updateActiveJobsDisplay(data.jobs);
					}
				})
				.catch(error => console.error('Error refreshing jobs:', error));
		}
		
		function updateActiveJobsDisplay(jobs) {
			// Update job progress bars and status
			jobs.forEach(job => {
				const progressBar = document.querySelector(`[data-job-id="${job.job_id}"] .job-progress-bar`);
				if (progressBar) {
					progressBar.style.width = job.progress + '%';
				}
			});
		}

		// Job management functions
		async function cancelJob(jobId) {
			if (!confirm('Are you sure you want to cancel this job?')) {
				return;
			}
			
			try {
				const response = await fetch(`/graph/import-export/api/jobs/${jobId}/cancel/`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				});
				
				const result = await response.json();
				if (result.success) {
					alert('Job cancelled successfully');
					location.reload();
				} else {
					alert('Error cancelling job: ' + result.error);
				}
			} catch (error) {
				console.error('Error cancelling job:', error);
				alert('Error cancelling job: ' + error.message);
			}
		}
		
		async function viewJobDetails(jobId) {
			try {
				const response = await fetch(`/graph/import-export/api/jobs/${jobId}/`);
				const result = await response.json();
				
				if (result.success) {
					const job = result.job;
					document.getElementById('jobDetailsContent').innerHTML = `
						<div class="row">
							<div class="col-md-6">
								<h6>Job Information</h6>
								<table class="table table-sm">
									<tr><td><strong>Job ID:</strong></td><td><code>${job.job_id}</code></td></tr>
									<tr><td><strong>Type:</strong></td><td>${job.job_type}</td></tr>
									<tr><td><strong>Format:</strong></td><td>${job.format}</td></tr>
									<tr><td><strong>Status:</strong></td><td><span class="job-status-${job.status}">${job.status}</span></td></tr>
									<tr><td><strong>Progress:</strong></td><td>${job.progress}%</td></tr>
								</table>
							</div>
							<div class="col-md-6">
								<h6>Paths</h6>
								<table class="table table-sm">
									<tr><td><strong>Source:</strong></td><td><small>${job.source}</small></td></tr>
									<tr><td><strong>Target:</strong></td><td><small>${job.target}</small></td></tr>
								</table>
								
								<h6>Timestamps</h6>
								<table class="table table-sm">
									<tr><td><strong>Created:</strong></td><td><small>${job.created_at}</small></td></tr>
									<tr><td><strong>Started:</strong></td><td><small>${job.started_at || 'Not started'}</small></td></tr>
									<tr><td><strong>Completed:</strong></td><td><small>${job.completed_at || 'Not completed'}</small></td></tr>
								</table>
							</div>
						</div>
						
						${job.error_message ? `
							<div class="alert alert-danger">
								<h6>Error Message</h6>
								<p>${job.error_message}</p>
							</div>
						` : ''}
						
						${Object.keys(job.metadata || {}).length > 0 ? `
							<div class="mt-3">
								<h6>Metadata</h6>
								<pre class="bg-light p-2 rounded"><code>${JSON.stringify(job.metadata, null, 2)}</code></pre>
							</div>
						` : ''}
					`;
					
					new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
				} else {
					alert('Error loading job details: ' + result.error);
				}
			} catch (error) {
				console.error('Error loading job details:', error);
				alert('Error loading job details: ' + error.message);
			}
		}
		
		function downloadExport(jobId) {
			window.location.href = `/graph/import-export/api/download/${jobId}/`;
		}
		
		function quickExport(graphName) {
			document.getElementById('exportGraphName').value = graphName;
			document.getElementById('exportFilename').value = `${graphName}_export.json`;
			new bootstrap.Modal(document.getElementById('quickExportModal')).show();
		}
		
		async function startQuickExport() {
			const graphName = document.getElementById('exportGraphName').value;
			const format = document.getElementById('exportFormat').value;
			const filename = document.getElementById('exportFilename').value;
			
			if (!graphName || !format || !filename) {
				alert('Please fill all fields');
				return;
			}
			
			try {
				const response = await fetch('/graph/import-export/api/export/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						graph_name: graphName,
						format: format,
						filename: filename
					})
				});
				
				const result = await response.json();
				if (result.success) {
					alert(`Export job started: ${result.job_id}`);
					bootstrap.Modal.getInstance(document.getElementById('quickExportModal')).hide();
					location.reload();
				} else {
					alert('Error starting export: ' + result.error);
				}
			} catch (error) {
				console.error('Error starting export:', error);
				alert('Error starting export: ' + error.message);
			}
		}
		
		// Initialize page
		document.addEventListener('DOMContentLoaded', function() {
			// Set up auto-refresh
			document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
			toggleAutoRefresh();
		});
	</script>
</body>
</html>