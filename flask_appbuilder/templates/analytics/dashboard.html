{% extends "appbuilder/base.html" %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Analytics Dashboard - {{ overview.tenant_info.name }}</h2>
            <p class="text-muted">Plan: {{ overview.tenant_info.plan|title }} | Status: {{ overview.tenant_info.status|title }}</p>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row">
        <!-- User Metrics -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-primary">{{ overview.user_metrics.total_users }}</h4>
                    <p class="card-text">Total Users</p>
                    <small class="text-success">+{{ overview.user_metrics.new_users_period }} new this period</small>
                </div>
            </div>
        </div>

        <!-- Active Users -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-primary">{{ overview.user_metrics.active_users_period }}</h4>
                    <p class="card-text">Active Users</p>
                    <small class="text-muted">
                        {{ "%.1f"|format(overview.user_metrics.active_users_period / overview.user_metrics.total_users * 100) if overview.user_metrics.total_users > 0 else 0 }}% activity rate
                    </small>
                </div>
            </div>
        </div>

        <!-- API Calls -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-primary">{{ "{:,}".format(overview.usage_metrics.api_calls) }}</h4>
                    <p class="card-text">API Calls</p>
                    <small class="text-muted">
                        {{ "%.0f"|format(overview.usage_metrics.api_calls / overview.user_metrics.total_users) if overview.user_metrics.total_users > 0 else 0 }} per user
                    </small>
                </div>
            </div>
        </div>

        <!-- Revenue -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-primary">${{ "%.2f"|format(overview.billing_metrics.total_revenue) }}</h4>
                    <p class="card-text">Total Revenue</p>
                    <small class="text-muted">
                        ${{ "%.2f"|format(overview.billing_metrics.monthly_revenue) }} base + ${{ "%.2f"|format(overview.billing_metrics.usage_charges) }} usage
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Details -->
    <div class="row mt-4">
        <!-- Usage Details -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Resource Usage</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>API Calls</td>
                                <td class="text-right">{{ "{:,}".format(overview.usage_metrics.api_calls) }}</td>
                            </tr>
                            <tr>
                                <td>Storage</td>
                                <td class="text-right">{{ "%.2f"|format(overview.usage_metrics.storage_gb) }} GB</td>
                            </tr>
                            <tr>
                                <td>Database Queries</td>
                                <td class="text-right">{{ "{:,}".format(overview.usage_metrics.database_queries) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Metrics -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Security Activity</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% set security_score = overview.security_metrics.security_score %}
                        <span class="badge 
                            {% if security_score >= 90 %}badge-success
                            {% elif security_score >= 75 %}badge-info
                            {% elif security_score >= 60 %}badge-warning
                            {% else %}badge-danger{% endif %} p-3">
                            Security Score: {{ "%.0f"|format(security_score) }}/100
                        </span>
                    </div>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Total Events</td>
                                <td class="text-right">{{ overview.security_metrics.total_security_events }}</td>
                            </tr>
                            <tr>
                                <td>Failed Logins</td>
                                <td class="text-right">{{ overview.security_metrics.failed_login_attempts }}</td>
                            </tr>
                            <tr>
                                <td>Security Violations</td>
                                <td class="text-right">{{ overview.security_metrics.security_violations }}</td>
                            </tr>
                            <tr>
                                <td>Unique IPs</td>
                                <td class="text-right">{{ overview.security_metrics.unique_ip_addresses }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Analytics Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Analytics Tools</h5>
                </div>
                <div class="card-body">
                    <a href="/analytics/reports" class="btn btn-primary mr-2">View Reports</a>
                    <button class="btn btn-outline-secondary" onclick="loadComparativeAnalytics()">Compare with Peers</button>
                    <button class="btn btn-outline-info" onclick="exportAnalytics()">Export Data</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadComparativeAnalytics() {
        fetch('/analytics/api/comparative?benchmark=plan_peers')
            .then(response => response.json())
            .then(data => {
                alert('Comparative data loaded. Check console for details.');
                console.log(data);
            });
    }

    function exportAnalytics() {
        const data = {{ overview|tojson }};
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analytics_{{ overview.tenant_info.slug }}_{{ overview.generated_at }}.json';
        a.click();
    }
</script>
{% endblock %}